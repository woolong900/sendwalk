# 🔥 退信处理和自动黑名单功能 - 部署说明

## ✅ 已实现的功能

### 1. 硬退信自动黑名单（5xx 错误）
- ✅ 自动识别 5xx SMTP 错误码
- ✅ 立即将邮箱加入黑名单
- ✅ 标记原因为 `hard_bounce`
- ✅ 记录详细的退信日志

### 2. 软退信计数（4xx 错误）
- ✅ 记录软退信次数
- ✅ 7天内失败3次自动加入黑名单
- ✅ 标记原因为 `soft_bounce`
- ✅ 可配置阈值和时间窗口

### 3. 退信日志记录
- ✅ 记录所有退信详情
- ✅ 包含错误码、错误消息、SMTP 响应
- ✅ 关联订阅者和活动
- ✅ 支持数据分析和改进

### 4. 智能退信检测
- ✅ 基于错误码判断（5xx/4xx）
- ✅ 基于错误消息关键词判断
- ✅ 支持多种 SMTP 服务器响应格式

---

## 📦 数据库变更

### 新增表
1. **bounce_logs** - 退信日志表
   - subscriber_id
   - campaign_id
   - email
   - bounce_type (hard/soft)
   - error_code
   - error_message
   - smtp_response
   - created_at

### 修改表
2. **subscribers** 表
   - bounce_count (退信计数)
   - last_bounce_at (最后退信时间)

3. **blacklist** 表
   - reason (enum: manual, hard_bounce, soft_bounce, complaint, unsubscribe)
   - notes (备注说明)

---

## 🚀 部署步骤

### 1. 备份数据库（重要！）
```bash
# 在生产服务器上执行
cd /data/www/sendwalk/backend

# 备份数据库
mysqldump -u root -p sendwalk > ~/backup_before_bounce_handler_$(date +%Y%m%d_%H%M%S).sql
```

### 2. 拉取代码
```bash
cd /data/www/sendwalk

# 拉取最新代码
git pull origin main

# 或者如果有分歧，使用 rebase
git pull --rebase origin main
```

### 3. 运行数据库迁移
```bash
cd /data/www/sendwalk/backend

# 运行迁移
php artisan migrate

# 检查是否成功
php artisan db:table bounce_logs
php artisan db:table subscribers
php artisan db:table blacklist
```

### 4. 清理缓存
```bash
cd /data/www/sendwalk/backend

php artisan config:clear
php artisan cache:clear
php artisan route:clear
php artisan view:clear
```

### 5. 重启队列 Worker
```bash
# 重启所有 worker
php artisan queue:restart

# 检查 worker 是否正常运行
ps aux | grep "campaign:process-queue"
ps aux | grep "queue:work"
```

---

## 🧪 测试验证

### 1. 测试硬退信（邮箱不存在）

**模拟发送到不存在的邮箱：**

```bash
# 创建一个测试活动，发送到不存在的邮箱
# 例如：test_nonexistent_12345@example.com
```

**预期结果：**
- ✅ 发送失败，记录到 `send_logs` 表
- ✅ 创建 `bounce_logs` 记录，bounce_type = 'hard'
- ✅ 邮箱立即加入 `blacklist` 表，reason = 'hard_bounce'
- ✅ `subscribers` 表中该订阅者 status = 'bounced'

**验证 SQL：**
```sql
-- 检查退信日志
SELECT * FROM bounce_logs ORDER BY created_at DESC LIMIT 5;

-- 检查黑名单
SELECT * FROM blacklist WHERE reason = 'hard_bounce' ORDER BY created_at DESC LIMIT 5;

-- 检查订阅者状态
SELECT id, email, status, bounce_count, last_bounce_at 
FROM subscribers 
WHERE status = 'bounced' 
ORDER BY last_bounce_at DESC 
LIMIT 5;
```

### 2. 测试软退信（多次失败）

**模拟多次发送失败：**
```bash
# 向同一个邮箱发送 3 次活动（在 7 天内）
# 每次都会失败（例如邮箱满）
```

**预期结果：**
- ✅ 第1次失败：bounce_count = 1，不加黑名单
- ✅ 第2次失败：bounce_count = 2，不加黑名单
- ✅ 第3次失败：bounce_count = 3，加入黑名单，reason = 'soft_bounce'

**验证 SQL：**
```sql
-- 检查软退信日志
SELECT email, COUNT(*) as bounce_count, MIN(created_at) as first_bounce, MAX(created_at) as last_bounce
FROM bounce_logs 
WHERE bounce_type = 'soft' 
GROUP BY email 
HAVING bounce_count >= 3;

-- 检查是否加入黑名单
SELECT * FROM blacklist WHERE reason = 'soft_bounce';
```

### 3. 查看退信统计

**退信类型分布：**
```sql
SELECT 
    bounce_type,
    COUNT(*) as count,
    COUNT(DISTINCT email) as unique_emails
FROM bounce_logs
GROUP BY bounce_type;
```

**最常见的错误码：**
```sql
SELECT 
    error_code,
    COUNT(*) as count,
    bounce_type
FROM bounce_logs
WHERE error_code IS NOT NULL
GROUP BY error_code, bounce_type
ORDER BY count DESC
LIMIT 10;
```

**最近的退信：**
```sql
SELECT 
    bl.email,
    bl.bounce_type,
    bl.error_code,
    bl.error_message,
    bl.created_at,
    c.name as campaign_name
FROM bounce_logs bl
LEFT JOIN campaigns c ON bl.campaign_id = c.id
ORDER BY bl.created_at DESC
LIMIT 20;
```

---

## ⚙️ 配置调整

### 修改软退信阈值

**编辑文件：** `backend/app/Services/BounceHandler.php`

```php
// 在第 31-32 行附近
private const SOFT_BOUNCE_THRESHOLD = 3; // 失败次数阈值（默认 3 次）
private const SOFT_BOUNCE_WINDOW_DAYS = 7; // 时间窗口（默认 7 天）
```

**修改后需要：**
```bash
php artisan config:clear
php artisan queue:restart
```

### 自定义错误码检测

**编辑文件：** `backend/app/Services/BounceHandler.php`

```php
// 在第 16-30 行附近
private const HARD_BOUNCE_CODES = [
    '550', // Mailbox not found
    '551', // User not local
    '552', // Exceeded storage allocation
    '553', // Mailbox name not allowed
    '554', // Transaction failed
    // 添加更多错误码...
];

private const SOFT_BOUNCE_CODES = [
    '450', // Mailbox busy
    '451', // Local error
    '452', // Insufficient storage
    '453', // Too many recipients
    // 添加更多错误码...
];
```

---

## 📊 监控和维护

### 1. 定期检查退信率
```sql
-- 最近 24 小时的退信率
SELECT 
    DATE(created_at) as date,
    COUNT(*) as total_bounces,
    SUM(CASE WHEN bounce_type = 'hard' THEN 1 ELSE 0 END) as hard_bounces,
    SUM(CASE WHEN bounce_type = 'soft' THEN 1 ELSE 0 END) as soft_bounces
FROM bounce_logs
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
GROUP BY DATE(created_at);
```

### 2. 清理旧的退信日志（可选）
```sql
-- 删除 90 天前的退信日志
DELETE FROM bounce_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

### 3. 查看退信趋势
```bash
# 创建一个定时任务来生成报告
cd /data/www/sendwalk/backend

# 可以创建一个 Artisan 命令来生成退信报告
php artisan make:command GenerateBounceReport
```

---

## 🎯 预期效果

实施后，你应该看到：

1. **发送信誉提升**
   - ✅ 自动清理无效邮箱
   - ✅ 减少退信率
   - ✅ SMTP 服务器不会被标记

2. **成本节约**
   - ✅ 不再向无效邮箱发送
   - ✅ 节省 SMTP 配额
   - ✅ 提高投递效率

3. **数据洞察**
   - ✅ 了解哪些邮箱有问题
   - ✅ 分析退信原因
   - ✅ 优化邮件列表质量

---

## ❓ 常见问题

### Q1: 如果误判了怎么办？
A: 可以手动从黑名单中移除：
```sql
DELETE FROM blacklist WHERE email = 'someone@example.com' AND reason IN ('hard_bounce', 'soft_bounce');
UPDATE subscribers SET status = 'active', bounce_count = 0 WHERE email = 'someone@example.com';
```

### Q2: 如何查看某个邮箱的退信历史？
A:
```sql
SELECT * FROM bounce_logs WHERE email = 'someone@example.com' ORDER BY created_at DESC;
```

### Q3: 如何调整软退信的阈值？
A: 修改 `BounceHandler.php` 中的常量，然后重启 worker。

### Q4: 退信日志会占用很多空间吗？
A: 建议定期清理 90 天前的日志，或者创建归档表。

---

## 📝 日志位置

- **应用日志：** `storage/logs/laravel.log`
- **退信处理日志：** 搜索关键词 "处理退信"、"硬退信"、"软退信"

**查看实时日志：**
```bash
tail -f storage/logs/laravel.log | grep -i bounce
```

---

## ✅ 部署完成检查清单

- [ ] 数据库已备份
- [ ] 代码已拉取到最新版本
- [ ] 数据库迁移已执行成功
- [ ] 缓存已清理
- [ ] Worker 已重启
- [ ] 测试发送到无效邮箱，验证硬退信功能
- [ ] 检查退信日志表有数据
- [ ] 检查黑名单表有新增记录
- [ ] 查看 Laravel 日志确认功能正常

---

## 🎉 完成！

退信处理和自动黑名单功能已部署完成！

现在你的邮件系统会自动：
- ✅ 识别无效邮箱并加入黑名单
- ✅ 记录所有退信详情
- ✅ 保护你的发送信誉
- ✅ 提供数据洞察

有任何问题，查看日志或运行测试 SQL！

