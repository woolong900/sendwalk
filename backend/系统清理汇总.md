# ç³»ç»Ÿæ¸…ç†åŠŸèƒ½æ±‡æ€»

## ğŸ“‹ æ¸…ç†ä»»åŠ¡æ€»è§ˆ

ç³»ç»Ÿå·²é…ç½®å¤šä¸ªè‡ªåŠ¨æ¸…ç†ä»»åŠ¡ï¼Œä¿æŒç³»ç»Ÿæ•´æ´å’Œé«˜æ•ˆè¿è¡Œã€‚

| æ¸…ç†ä»»åŠ¡ | æ‰§è¡Œæ—¶é—´ | ä¿ç•™æ—¶é—´ | çŠ¶æ€ |
|---------|---------|---------|------|
| é˜Ÿåˆ—ä»»åŠ¡ | æ¯å¤© 02:00 | N/A | âœ… å·²å¯ç”¨ |
| æ—¥å¿—æ–‡ä»¶ | æ¯å¤© 03:00 | 30 å¤© | âœ… å·²å¯ç”¨ |
| SendLog | æ¯å¤© 04:00 | 30 å¤© | âœ… å·²å¯ç”¨ |

## ğŸ—‘ï¸ 1. é˜Ÿåˆ—ä»»åŠ¡æ¸…ç†

### **æ¸…ç†å†…å®¹**
- å·²å®Œæˆçš„é˜Ÿåˆ—ä»»åŠ¡ï¼ˆ`jobs` è¡¨ï¼‰
- å¤±è´¥çš„é˜Ÿåˆ—ä»»åŠ¡ï¼ˆ`failed_jobs` è¡¨ï¼‰

### **é…ç½®**
```php
// routes/console.php
Schedule::command('queue:clean')
    ->dailyAt('02:00')
    ->runInBackground();
```

### **æ‰‹åŠ¨æ‰§è¡Œ**
```bash
# æ¸…ç†æ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡
php artisan queue:clean

# æ¸…ç†å¤±è´¥çš„ä»»åŠ¡
php artisan queue:flush
```

## ğŸ“„ 2. æ—¥å¿—æ–‡ä»¶æ¸…ç†

### **æ¸…ç†å†…å®¹**
- `storage/logs/*.log` æ–‡ä»¶
- è¶…è¿‡ 30 å¤©çš„æ—¥å¿—æ–‡ä»¶

### **æ–‡ä»¶ç±»å‹**
- `laravel-YYYY-MM-DD.log`
- `worker-YYYY-MM-DD.log`
- `email-YYYY-MM-DD.log`
- `scheduler-YYYY-MM-DD.log`

### **é…ç½®**
```php
// routes/console.php
Schedule::command('logs:cleanup --days=30')
    ->dailyAt('03:00')
    ->runInBackground();
```

### **æ‰‹åŠ¨æ‰§è¡Œ**
```bash
# é¢„è§ˆä¼šåˆ é™¤çš„æ–‡ä»¶
php artisan logs:cleanup --dry-run

# æ‰§è¡Œæ¸…ç†
php artisan logs:cleanup

# ä¿ç•™ 7 å¤©
php artisan logs:cleanup --days=7
```

### **è¯¦ç»†æ–‡æ¡£**
- `æ—¥å¿—æŒ‰å¤©æ»šåŠ¨è¯´æ˜.md`
- `æ—¥å¿—ç›®å½•æ•´ç†è¯´æ˜.md`
- `æ—¥å¿—é…ç½®å¿«é€Ÿå‚è€ƒ.md`

## ğŸ“Š 3. SendLog æ•°æ®åº“æ¸…ç†

### **æ¸…ç†å†…å®¹**
- `send_logs` è¡¨
- è¶…è¿‡ 30 å¤©çš„å‘é€è®°å½•

### **é…ç½®**
```php
// routes/console.php
Schedule::command('sendlogs:cleanup --days=30')
    ->dailyAt('04:00')
    ->runInBackground();
```

### **æ‰‹åŠ¨æ‰§è¡Œ**
```bash
# é¢„è§ˆä¼šåˆ é™¤çš„è®°å½•
php artisan sendlogs:cleanup --dry-run

# æ‰§è¡Œæ¸…ç†
php artisan sendlogs:cleanup

# ä¿ç•™ 90 å¤©
php artisan sendlogs:cleanup --days=90
```

### **è¯¦ç»†æ–‡æ¡£**
- `SendLogæ¸…ç†è¯´æ˜.md`
- `SendLogæ¸…ç†å¿«é€Ÿå‚è€ƒ.md`

## ğŸ” å½“å‰çŠ¶æ€æ£€æŸ¥

### **ä¸€é”®æ£€æŸ¥æ‰€æœ‰æ¸…ç†ä»»åŠ¡**

```bash
#!/bin/bash

echo "=== ç³»ç»Ÿæ¸…ç†çŠ¶æ€æ£€æŸ¥ ==="
echo ""

# 1. æ£€æŸ¥è°ƒåº¦å™¨
echo "1. è°ƒåº¦å™¨çŠ¶æ€:"
if pgrep -f "schedule:work" > /dev/null; then
    echo "   âœ… è¿è¡Œä¸­ (PID: $(pgrep -f 'schedule:work'))"
else
    echo "   âŒ æœªè¿è¡Œ"
fi
echo ""

# 2. æ£€æŸ¥é˜Ÿåˆ—ä»»åŠ¡æ•°é‡
echo "2. é˜Ÿåˆ—ä»»åŠ¡:"
php artisan tinker --execute="
echo '   æ€»ä»»åŠ¡: ' . DB::table('jobs')->count() . PHP_EOL;
echo '   å¤±è´¥ä»»åŠ¡: ' . DB::table('failed_jobs')->count() . PHP_EOL;
" 2>/dev/null
echo ""

# 3. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
echo "3. æ—¥å¿—æ–‡ä»¶:"
LOG_COUNT=$(ls -1 storage/logs/*.log 2>/dev/null | wc -l | tr -d ' ')
LOG_SIZE=$(du -sh storage/logs/ 2>/dev/null | cut -f1)
echo "   æ–‡ä»¶æ•°: ${LOG_COUNT}"
echo "   æ€»å¤§å°: ${LOG_SIZE}"
echo ""

# 4. æ£€æŸ¥ SendLog
echo "4. SendLog è®°å½•:"
php artisan tinker --execute="
\$count = App\Models\SendLog::count();
echo '   æ€»è®°å½•: ' . \$count . PHP_EOL;
if (\$count > 0) {
    \$oldest = App\Models\SendLog::orderBy('created_at', 'asc')->first();
    echo '   æœ€æ—©: ' . \$oldest->created_at . PHP_EOL;
}
" 2>/dev/null
echo ""

# 5. æ£€æŸ¥å®šæ—¶ä»»åŠ¡é…ç½®
echo "5. å®šæ—¶ä»»åŠ¡é…ç½®:"
grep -E "queue:clean|logs:cleanup|sendlogs:cleanup" routes/console.php | sed 's/^/   /'
echo ""

echo "=== æ£€æŸ¥å®Œæˆ ==="
```

ä¿å­˜ä¸º `check_cleanup_status.sh` å¹¶æ‰§è¡Œï¼š

```bash
chmod +x check_cleanup_status.sh
./check_cleanup_status.sh
```

## ğŸ“… æ¸…ç†æ—¶é—´è¡¨

```
00:00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â”‚
02:00 â”œâ”€â”€â”€ æ¸…ç†é˜Ÿåˆ—ä»»åŠ¡ (queue:clean)
      â”‚
03:00 â”œâ”€â”€â”€ æ¸…ç†æ—¥å¿—æ–‡ä»¶ (logs:cleanup)
      â”‚
04:00 â”œâ”€â”€â”€ æ¸…ç† SendLog (sendlogs:cleanup)
      â”‚
      â”‚
24:00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## ğŸ¯ æ¸…ç†ç­–ç•¥å»ºè®®

### **å¼€å‘/æµ‹è¯•ç¯å¢ƒ**

```php
// æ›´é¢‘ç¹ï¼Œä¿ç•™æ›´çŸ­
Schedule::command('logs:cleanup --days=7')
    ->dailyAt('03:00');

Schedule::command('sendlogs:cleanup --days=7')
    ->dailyAt('04:00');
```

### **ç”Ÿäº§ç¯å¢ƒï¼ˆé»˜è®¤ï¼‰**

```php
// ä¿ç•™ 30 å¤©ï¼ˆæ¨èï¼‰
Schedule::command('logs:cleanup --days=30')
    ->dailyAt('03:00');

Schedule::command('sendlogs:cleanup --days=30')
    ->dailyAt('04:00');
```

### **åˆè§„è¦æ±‚ç¯å¢ƒ**

```php
// ä¿ç•™ 90 å¤©æˆ–æ›´é•¿
Schedule::command('logs:cleanup --days=90')
    ->dailyAt('03:00');

Schedule::command('sendlogs:cleanup --days=90')
    ->dailyAt('04:00');
```

## ğŸ“Š ç£ç›˜ç©ºé—´ç›‘æ§

### **æŸ¥çœ‹å„éƒ¨åˆ†å ç”¨**

```bash
# é˜Ÿåˆ—ä»»åŠ¡è¡¨å¤§å°
php artisan tinker --execute="
echo 'jobs: ' . DB::table('jobs')->count() . ' records' . PHP_EOL;
"

# æ—¥å¿—æ–‡ä»¶å¤§å°
du -sh storage/logs/

# SendLog è¡¨å¤§å°
php artisan tinker --execute="
\$count = App\Models\SendLog::count();
\$size = DB::select('SELECT 
    ROUND((data_length + index_length) / 1024 / 1024, 2) AS size_mb 
    FROM information_schema.TABLES 
    WHERE table_name = \"send_logs\"')[0]->size_mb ?? 0;
echo 'SendLog: ' . \$count . ' records, ' . \$size . ' MB' . PHP_EOL;
"
```

### **è®¾ç½®å‘Šè­¦**

```bash
# æ¯å¤©æ£€æŸ¥ç£ç›˜ä½¿ç”¨ï¼Œè¶…è¿‡ 80% å‘é€å‘Šè­¦
0 9 * * * /path/to/check_disk_usage.sh
```

## ğŸ”§ æ•…éšœæ’æŸ¥

### **é—®é¢˜ 1ï¼šæ¸…ç†ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œ**

```bash
# æ£€æŸ¥è°ƒåº¦å™¨
ps aux | grep "schedule:work"

# æŸ¥çœ‹è°ƒåº¦å™¨æ—¥å¿—
tail -f storage/logs/scheduler.log

# æ‰‹åŠ¨è¿è¡Œæµ‹è¯•
php artisan queue:clean
php artisan logs:cleanup --dry-run
php artisan sendlogs:cleanup --dry-run
```

### **é—®é¢˜ 2ï¼šç£ç›˜ç©ºé—´ä»ç„¶ä¸è¶³**

```bash
# æ£€æŸ¥å„éƒ¨åˆ†å ç”¨
du -sh storage/logs/
du -sh storage/app/
du -sh storage/framework/

# æ‰‹åŠ¨æ¸…ç†æ—§æ•°æ®
php artisan logs:cleanup --days=7
php artisan sendlogs:cleanup --days=7

# ä¼˜åŒ–æ•°æ®åº“
php artisan tinker --execute="
DB::statement('OPTIMIZE TABLE send_logs');
DB::statement('OPTIMIZE TABLE jobs');
"
```

### **é—®é¢˜ 3ï¼šåˆ é™¤é€Ÿåº¦å¤ªæ…¢**

```bash
# å¢åŠ æ‰¹æ¬¡å¤§å°
php artisan sendlogs:cleanup --batch-size=5000

# åœ¨ä½å³°æœŸæ‰‹åŠ¨æ‰§è¡Œ
php artisan sendlogs:cleanup
```

## ğŸ“– ç›¸å…³æ–‡æ¡£

### **æ—¥å¿—æ¸…ç†**
- `æ—¥å¿—æŒ‰å¤©æ»šåŠ¨è¯´æ˜.md` - å®Œæ•´é…ç½®è¯´æ˜
- `æ—¥å¿—ç›®å½•æ•´ç†è¯´æ˜.md` - ç›®å½•ç»“æ„æ•´ç†
- `æ—¥å¿—é…ç½®å¿«é€Ÿå‚è€ƒ.md` - å¸¸ç”¨å‘½ä»¤
- `æ—¥å¿—æ–‡ä»¶é€ŸæŸ¥.txt` - é€ŸæŸ¥è¡¨
- `test_log_rotation.sh` - æµ‹è¯•è„šæœ¬

### **SendLog æ¸…ç†**
- `SendLogæ¸…ç†è¯´æ˜.md` - å®Œæ•´åŠŸèƒ½è¯´æ˜
- `SendLogæ¸…ç†å¿«é€Ÿå‚è€ƒ.md` - å¿«é€Ÿå‚è€ƒ
- `test_sendlog_cleanup.sh` - æµ‹è¯•è„šæœ¬

### **å…¶ä»–**
- `Workerä¼˜é›…é€€å‡ºè¯´æ˜.md` - Worker è¿›ç¨‹ç®¡ç†

## âœ… æ£€æŸ¥æ¸…å•

éƒ¨ç½²åè¯·ç¡®è®¤ï¼š

- [ ] è°ƒåº¦å™¨æ­£åœ¨è¿è¡Œï¼š`ps aux | grep schedule:work`
- [ ] æ‰€æœ‰æ¸…ç†å‘½ä»¤å¯ç”¨ï¼š`php artisan list | grep cleanup`
- [ ] å®šæ—¶ä»»åŠ¡å·²é…ç½®ï¼š`cat routes/console.php`
- [ ] æ—¥å¿—è®°å½•æ­£å¸¸ï¼š`tail -f storage/logs/laravel-*.log`
- [ ] ç£ç›˜ç©ºé—´å……è¶³ï¼š`df -h`

## ğŸš€ æ€»ç»“

ç³»ç»Ÿæ¸…ç†åŠŸèƒ½å·²å…¨é¢é…ç½®ï¼š

- âœ… **è‡ªåŠ¨åŒ–**ï¼šæ— éœ€äººå·¥å¹²é¢„ï¼Œæ¯å¤©è‡ªåŠ¨æ¸…ç†
- âœ… **å¯é…ç½®**ï¼šä¿ç•™å¤©æ•°ã€æ‰§è¡Œæ—¶é—´å¯è°ƒæ•´
- âœ… **å®‰å…¨**ï¼šæ”¯æŒ dry-run é¢„è§ˆï¼Œé¿å…è¯¯åˆ 
- âœ… **é«˜æ•ˆ**ï¼šæ‰¹é‡å¤„ç†ï¼Œè¡¨ä¼˜åŒ–ï¼Œæ€§èƒ½ä¼˜è‰¯
- âœ… **å¯ç›‘æ§**ï¼šè¯¦ç»†æ—¥å¿—ï¼Œæ˜“äºè¿½è¸ª
- âœ… **æ–‡æ¡£é½å…¨**ï¼šå®Œæ•´çš„ä½¿ç”¨è¯´æ˜å’Œæµ‹è¯•è„šæœ¬

ç°åœ¨æ‚¨çš„ç³»ç»Ÿä¼šä¿æŒæ•´æ´ï¼Œæ€§èƒ½ä¹Ÿä¼šæ›´å¥½ï¼ ğŸ‰

