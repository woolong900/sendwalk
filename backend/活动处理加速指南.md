# 活动处理加速指南

## 🚀 问题：活动处理速度太慢

当活动有大量收件人（如 166,312 个）时，默认配置处理速度较慢。

## ✅ 解决方案

### 方案 1：自动扩容（推荐用于长期运行）

**优化内容**：
- ✅ 提高最大 worker 数量：从 4 个提升到 20 个
- ✅ 更激进的扩容策略：每个 worker 处理 2000 个任务（原 5000）
- ✅ 更快的扩容速度：每次至少增加 2 个 worker（原 1 个）

**使用方法**：
```bash
# 停止现有的 queue manager
pkill -f 'queue:manage-workers'

# 使用新的配置启动（支持最多 20 个 workers）
cd /data/www/sendwalk/backend
nohup php artisan queue:manage-workers --max=20 > storage/logs/queue-manager.log 2>&1 &

# 或者更激进（最多 30 个 workers，适合超大批量）
nohup php artisan queue:manage-workers --max=30 > storage/logs/queue-manager.log 2>&1 &
```

**优点**：
- ✅ 自动管理，无需手动干预
- ✅ 根据队列长度智能扩缩容
- ✅ 适合多个活动并发处理

**缺点**：
- ⚠️ 扩容需要一定时间（每 10 秒检查一次）
- ⚠️ 对于紧急任务可能不够快

---

### 方案 2：手动快速启动（推荐用于紧急加速）

**使用新脚本快速启动大量 workers**：

```bash
cd /data/www/sendwalk/backend

# 为活动 #18 启动 20 个 workers
php boost-campaign-workers.php 18 20

# 或者更激进，启动 30 个 workers
php boost-campaign-workers.php 18 30
```

**优点**：
- ✅ 立即生效，无需等待
- ✅ 可以精确控制 worker 数量
- ✅ 适合紧急加速单个活动

**缺点**：
- ⚠️ 需要手动执行
- ⚠️ 活动完成后需手动清理（或等待自动退出）

---

### 方案 3：实时监控进度

**使用监控脚本查看处理速度和预计完成时间**：

```bash
cd /data/www/sendwalk/backend

# 每 5 秒刷新一次
php monitor-campaign-progress.php 18 5

# 或每 10 秒刷新一次
php monitor-campaign-progress.php 18 10
```

**显示内容**：
- 📊 实时处理进度和百分比
- 🔄 队列状态（待处理、处理中）
- ⚡ 当前 worker 数量
- 📈 实时处理速度（任务/秒）
- ⏱️ 预计剩余时间

---

## 📊 速度对比

**示例：166,312 个任务**

| Workers | 预计速度 | 预计完成时间 |
|---------|----------|--------------|
| 4       | 20 任务/秒 | ~138 分钟 |
| 10      | 50 任务/秒 | ~55 分钟 |
| 20      | 100 任务/秒 | ~28 分钟 |
| 30      | 150 任务/秒 | ~18 分钟 |

*注：实际速度受 SMTP 服务器限流影响*

---

## 🎯 推荐操作流程

### 对于当前卡住的活动 #18：

```bash
cd /data/www/sendwalk/backend

# 1. 先检查当前状态
php check-campaign-status.php 18

# 2. 快速启动 20 个 workers
php boost-campaign-workers.php 18 20

# 3. 实时监控进度
php monitor-campaign-progress.php 18 5
```

### 对于未来的大批量活动：

```bash
# 1. 提前配置自动扩容（支持更多 workers）
cd /data/www/sendwalk/backend
pkill -f 'queue:manage-workers'
nohup php artisan queue:manage-workers --max=30 > storage/logs/queue-manager.log 2>&1 &

# 2. 创建活动后，队列管理器会自动扩容
# 3. 可选：使用监控脚本查看进度
php monitor-campaign-progress.php <campaign_id> 5
```

---

## ⚠️ 注意事项

### 1. **服务器资源**
- 每个 worker 占用 ~50-100MB 内存
- 30 个 workers ≈ 1.5-3GB 内存
- 确保服务器有足够资源

### 2. **SMTP 限流**
- worker 再多也会受 SMTP 服务器限流影响
- 如遇 rate limit，workers 会自动休眠 60 秒
- 建议：配置多个 SMTP 服务器分散压力

### 3. **数据库连接**
- 大量 workers 会占用数据库连接
- 确保 MySQL `max_connections` 足够大（建议 ≥ 200）

---

## 🛠️ 常用命令

```bash
# 查看当前运行的 workers
ps aux | grep 'campaign:process-queue' | grep -v grep

# 查看特定活动的 workers
ps aux | grep 'campaign:process-queue 18' | grep -v grep

# 停止特定活动的所有 workers
pkill -f 'campaign:process-queue 18'

# 停止所有活动的 workers
pkill -f 'campaign:process-queue'

# 查看 worker 日志
tail -f storage/logs/campaign_18-worker-*.log

# 查看 queue manager 日志
tail -f storage/logs/queue-manager.log
```

---

## 💡 性能优化建议

### 短期（立即生效）：
1. ✅ 手动启动 20-30 个 workers
2. ✅ 使用监控脚本跟踪进度
3. ✅ 根据实际速度调整 worker 数量

### 长期（持续优化）：
1. ✅ 提高 queue manager 的 max workers 配置
2. ✅ 配置多个 SMTP 服务器
3. ✅ 优化数据库索引和连接池
4. ✅ 考虑使用 Redis 队列（比数据库队列更快）

---

## 📞 问题排查

### 问题：workers 启动后速度仍然很慢

**可能原因**：
1. SMTP 服务器限流
2. 发件人邮箱被暂停
3. 数据库连接不足

**解决方法**：
```bash
# 查看错误日志
tail -f storage/logs/laravel.log | grep -i "rate limit"

# 查看 SMTP 服务器状态
php artisan tinker
>>> App\Models\SmtpServer::find(1)->checkRateLimits()

# 查看数据库连接数
mysql -e "SHOW PROCESSLIST;" | wc -l
```

### 问题：workers 频繁退出

**可能原因**：
1. 内存不足
2. 活动状态变更
3. 未捕获的异常

**解决方法**：
```bash
# 查看 worker 日志
tail -f storage/logs/campaign_*-worker-*.log

# 增加内存限制
php boost-campaign-workers.php 18 20  # 脚本已使用 256MB 内存限制
```

