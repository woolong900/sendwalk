# 修复活动内存溢出问题

## 问题现象

编辑活动 20 时报错 500，Nginx 错误日志显示：

```
PHP Fatal error: Allowed memory size of 134217728 bytes exhausted (tried to allocate 20480 bytes)
```

**原因**: 活动 20 有大量发送记录，`CampaignController::show` 方法加载了所有 `sends` 关系，导致内存溢出（超过 128MB 限制）。

## 立即解决方案（正式环境）

### 方案 1：部署代码更新（推荐）

代码已经在本地修复，需要部署到正式环境：

```bash
# 1. 在本地提交更改
cd /Users/panlei/sendwalk
git add backend/app/Http/Controllers/Api/CampaignController.php
git add backend/app/Models/Campaign.php
git add backend/bootstrap/app.php
git commit -m "修复活动编辑内存溢出问题：移除sends关系加载"
git push

# 2. 在正式环境拉取更新
ssh your-server
cd /data/www/sendwalk
git pull

# 3. 清理缓存
cd backend
php artisan config:clear
php artisan route:clear
php artisan view:clear

# 4. 重启 PHP-FPM
sudo systemctl restart php8.3-fpm
# 或
sudo service php8.3-fpm restart
```

### 方案 2：手动修改正式环境代码（紧急）

如果无法立即部署，可以直接在正式环境修改：

```bash
ssh your-server
cd /data/www/sendwalk/backend

# 备份原文件
cp app/Http/Controllers/Api/CampaignController.php app/Http/Controllers/Api/CampaignController.php.backup

# 编辑文件
nano app/Http/Controllers/Api/CampaignController.php
```

找到 `show` 方法（约第 68-79 行），将：

```php
public function show(Request $request, Campaign $campaign)
{
    if ($campaign->user_id !== $request->user()->id) {
        return response()->json(['message' => '无权访问'], 403);
    }

    $campaign->load(['list', 'lists', 'sends', 'smtpServer']);  // ❌ 包含 sends

    return response()->json([
        'data' => $campaign,
    ]);
}
```

改为：

```php
public function show(Request $request, Campaign $campaign)
{
    try {
        if ($campaign->user_id !== $request->user()->id) {
            return response()->json(['message' => '无权访问'], 403);
        }

        // 不加载 sends 关系，因为可能有大量发送记录
        $campaign->load(['list', 'lists', 'smtpServer']);  // ✅ 移除 sends

        return response()->json([
            'data' => $campaign,
        ]);
    } catch (\Exception $e) {
        \Log::error('Failed to show campaign', [
            'campaign_id' => $campaign->id,
            'error' => $e->getMessage(),
        ]);
        
        return response()->json([
            'message' => '获取活动详情失败',
            'error' => $e->getMessage(),
        ], 500);
    }
}
```

保存后：

```bash
# 清理缓存
php artisan config:clear

# 重启 PHP-FPM
sudo systemctl restart php8.3-fpm
```

### 方案 3：临时增加 PHP 内存限制（不推荐）

**注意**: 这只是临时方案，治标不治本，不推荐使用。

```bash
# 编辑 PHP-FPM 配置
sudo nano /etc/php/8.3/fpm/php.ini

# 修改 memory_limit
memory_limit = 512M

# 重启 PHP-FPM
sudo systemctl restart php8.3-fpm
```

## 验证修复

### 1. 先检查活动 20 的发送记录数

在正式环境运行：

```bash
cd /data/www/sendwalk/backend
php -r "
require 'vendor/autoload.php';
\$app = require 'bootstrap/app.php';
\$app->make(Illuminate\Contracts\Console\Kernel::class)->bootstrap();
\$count = DB::table('campaign_sends')->where('campaign_id', 20)->count();
echo '活动 20 发送记录数: ' . \$count . PHP_EOL;
\$memoryMB = (\$count * 1024) / 1024 / 1024;
echo '估算内存占用: ' . round(\$memoryMB, 2) . ' MB' . PHP_EOL;
"
```

### 2. 测试 API

```bash
# 获取访问令牌（从浏览器开发者工具复制）
TOKEN="your-bearer-token"

# 测试 API
curl -X GET "https://api.sendwalk.com/api/campaigns/20" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Accept: application/json" \
  -i
```

应该返回 200 状态码，不再是 500。

### 3. 在浏览器中测试

直接访问编辑页面：`https://edm.sendwalk.com/campaigns/20/edit`

## 其他需要同步的修改

### 1. Campaign 模型优化

文件：`backend/app/Models/Campaign.php`

修改 `getListIdsAttribute` 方法（约第 128-133 行）：

```php
public function getListIdsAttribute()
{
    // 使用已加载的关系（如果已加载），避免额外的数据库查询
    if ($this->relationLoaded('lists')) {
        return $this->lists->pluck('id')->toArray();
    }
    
    // 如果关系未加载，执行查询
    return $this->lists()->pluck('lists.id')->toArray();
}
```

### 2. 全局异常处理

文件：`backend/bootstrap/app.php`

在 `withExceptions` 中添加：

```php
->withExceptions(function (Exceptions $exceptions) {
    $exceptions->render(function (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
        return response()->json([
            'message' => '资源不存在',
        ], 404);
    });
})
```

## 问题根源分析

### 为什么会内存溢出？

以活动 20 为例，假设有 100,000 条发送记录：

| 记录数 | 每条大小 | 总内存占用 | PHP 限制 | 结果 |
|--------|----------|-----------|----------|------|
| 100,000 | ~1KB | ~100MB | 128MB | ⚠️ 接近限制 |
| 200,000 | ~1KB | ~200MB | 128MB | ❌ 超出限制 |

加上：
- Eloquent 模型的开销
- 序列化开销
- 其他关系数据
- PHP 自身内存占用

很容易就超过 128MB。

### 为什么编辑活动需要加载 sends？

**答案：不需要！**

编辑活动时只需要：
- 活动的基本信息（名称、内容等）
- 关联的列表（`lists`）
- SMTP 服务器（`smtpServer`）

**不需要**：
- 发送记录（`sends`）- 可能有数十万条
- 单个列表（`list`）- 已弃用，改用 `lists`

### 正确的数据加载策略

| 场景 | 加载关系 | 理由 |
|------|----------|------|
| 活动列表 | `list`, `lists`, `smtpServer` | 显示基本信息 |
| 编辑活动 | `list`, `lists`, `smtpServer` | 只需编辑信息 |
| 活动统计 | 无（使用汇总字段） | `total_sent` 等字段已有统计 |
| 发送日志 | 分页加载 | 使用独立 API，分页返回 |

## 长期优化建议

### 1. 移除 list 关系

`list` 关系已弃用（单列表），应该只使用 `lists`（多列表）：

```php
// ❌ 旧代码
$campaign->load(['list', 'lists', 'smtpServer']);

// ✅ 新代码
$campaign->load(['lists', 'smtpServer']);
```

### 2. 优化前端

前端如果需要发送记录，应该使用专门的分页 API：

```typescript
// ❌ 不要依赖活动数据中的 sends
const campaign = await fetchCampaign(id);
const sends = campaign.sends; // 可能有数十万条

// ✅ 使用分页 API
const sendsPage = await fetch(`/api/campaigns/${id}/send-logs?page=1&per_page=50`);
```

### 3. 添加内存监控

在关键操作中添加内存监控：

```php
Log::info('Memory usage', [
    'operation' => 'load_campaign',
    'campaign_id' => $campaign->id,
    'memory_mb' => round(memory_get_usage(true) / 1024 / 1024, 2),
    'peak_memory_mb' => round(memory_get_peak_usage(true) / 1024 / 1024, 2),
]);
```

## 总结

1. **立即**: 部署代码更新或手动修改正式环境（移除 sends 加载）
2. **验证**: 测试活动 20 是否可以正常编辑
3. **长期**: 优化前端，使用分页 API 加载发送记录

修复后，即使活动有百万条发送记录，也能在 10MB 内存以内完成加载。

