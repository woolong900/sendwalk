# 日志目录整理说明

## 📋 完成的工作

### 1. **移动日志文件**

将 `storage/logs/queue/` 下的所有日志文件移动到 `storage/logs/` 目录：

```bash
# 移动的文件列表
✅ campaign_23-worker-1.log
✅ campaign_24-worker-1.log
✅ campaign_25-worker-1.log ~ campaign_25-worker-4.log
✅ campaign_26-worker-1.log
✅ campaign_27-worker-1.log
✅ manager.log (1.7MB)
✅ scheduler.log (676KB)
✅ worker-1.log ~ worker-8.log
```

### 2. **删除 queue 子目录**

```bash
✅ storage/logs/queue/ 目录已删除
```

### 3. **更新代码引用**

修改了所有引用 `logs/queue` 的文件：

#### **PHP 文件**

- ✅ `app/Console/Commands/ManageWorkers.php`
  ```php
  // 修改前：storage_path('logs/queue')
  // 修改后：storage_path('logs')
  ```

- ✅ `app/Http/Controllers/Api/DashboardController.php`
  ```php
  // 修改前：base_path('storage/logs/queue/scheduler.log')
  // 修改后：base_path('storage/logs/scheduler.log')
  ```

#### **Shell 脚本**

- ✅ `start_scheduler.sh`
  ```bash
  # 修改前：storage/logs/queue/scheduler.log
  # 修改后：storage/logs/scheduler.log
  ```

- ✅ `start_worker.sh`
  ```bash
  # 修改前：
  # - mkdir -p storage/logs/queue
  # - storage/logs/queue/scheduler.log
  # - storage/logs/queue/manager.log
  # 
  # 修改后：
  # - mkdir -p storage/logs
  # - storage/logs/scheduler.log
  # - storage/logs/manager.log
  ```

- ✅ `status_worker.sh`
  ```bash
  # 修改前：
  # - storage/logs/queue/manager.log
  # - storage/logs/queue/worker-1.log
  # - storage/logs/queue/scheduler.log
  # 
  # 修改后：
  # - storage/logs/manager.log
  # - storage/logs/campaign_*-worker-*.log
  # - storage/logs/scheduler.log
  ```

## 📂 新的日志目录结构

```
storage/logs/
├── laravel.log                      # 主日志（旧，56MB）
├── laravel-2025-12-20.log           # 主日志（按天）
├── worker-2025-12-20.log            # Worker 日志（按天）
├── email-2025-12-20.log             # 邮件日志（按天）
├── scheduler-2025-12-20.log         # 调度器日志（按天）
├── manager.log                      # 管理器日志（实时输出）
├── scheduler.log                    # 调度器日志（实时输出）
├── campaign_25-worker-3.log         # 活动 Worker 日志
├── campaign_25-worker-4.log
└── ... (其他历史日志文件)
```

## 🎯 日志类型说明

### **按天滚动的日志**（通过 Laravel logging 配置）

这些日志使用 `config/logging.php` 配置，自动按天滚动：

- **laravel-YYYY-MM-DD.log**：主应用日志
- **worker-YYYY-MM-DD.log**：Worker 进程日志
- **email-YYYY-MM-DD.log**：邮件发送日志
- **scheduler-YYYY-MM-DD.log**：调度器日志

使用方式：
```php
// 默认通道（laravel.log）
Log::info('General log');

// Worker 通道
Log::channel('worker')->info('Worker started');

// 邮件通道
Log::channel('email')->error('Email failed');

// 调度器通道
Log::channel('scheduler')->info('Scheduler running');
```

### **实时输出日志**（通过 nohup 重定向）

这些日志不会自动滚动，需要手动清理：

- **manager.log**：Worker 管理器的输出
- **scheduler.log**：任务调度器的输出（从脚本启动）
- **campaign_XX-worker-X.log**：每个活动 Worker 的独立日志

## 🔄 日志清理策略

### **自动清理（按天滚动的日志）**

- 每天凌晨 3:00 自动清理超过 30 天的 `*-YYYY-MM-DD.log` 文件
- 由 `php artisan logs:cleanup` 命令执行

### **手动清理（实时输出日志）**

需要定期手动清理以下文件：

```bash
# 压缩旧日志
gzip storage/logs/manager.log
gzip storage/logs/scheduler.log
gzip storage/logs/campaign_*-worker-*.log

# 或直接删除
rm storage/logs/manager.log
rm storage/logs/scheduler.log
rm storage/logs/campaign_*-worker-*.log
```

## 💻 常用命令

### **查看日志**

```bash
# 按天滚动的日志
tail -f storage/logs/laravel-$(date +%Y-%m-%d).log
tail -f storage/logs/worker-$(date +%Y-%m-%d).log
tail -f storage/logs/email-$(date +%Y-%m-%d).log
tail -f storage/logs/scheduler-$(date +%Y-%m-%d).log

# 实时输出日志
tail -f storage/logs/manager.log
tail -f storage/logs/scheduler.log
tail -f storage/logs/campaign_25-worker-*.log
```

### **清理日志**

```bash
# 预览会删除的文件
php artisan logs:cleanup --dry-run

# 清理 30 天前的日志
php artisan logs:cleanup

# 清理 7 天前的日志
php artisan logs:cleanup --days=7

# 手动清理实时输出日志
rm storage/logs/manager.log
rm storage/logs/scheduler.log
rm storage/logs/campaign_*-worker-*.log
```

### **检查磁盘使用**

```bash
# 总大小
du -sh storage/logs/

# 按文件大小排序
du -h storage/logs/*.log | sort -hr

# 文件数量
ls -1 storage/logs/*.log | wc -l
```

## ✅ 验证结果

### **代码中没有 queue 目录引用**

```bash
$ grep -r "logs/queue" backend/
✅ 没有找到 'logs/queue' 引用
```

### **日志文件已移动**

```bash
$ ls storage/logs/*.log | wc -l
23 个日志文件
```

### **目录结构正确**

```bash
$ ls -la storage/logs/
✅ queue 目录不存在
✅ 所有日志文件在 logs/ 根目录
```

## 🎯 优势

统一日志目录后的好处：

1. ✅ **结构简化**：所有日志在同一目录，便于管理
2. ✅ **自动清理**：按天滚动的日志自动清理
3. ✅ **易于查找**：使用 `ls storage/logs/*.log` 即可查看所有日志
4. ✅ **统一规范**：所有日志文件命名规范一致
5. ✅ **便于备份**：只需备份 `storage/logs/` 一个目录

## 📖 相关文档

- **日志按天滚动详细说明**：`日志按天滚动说明.md`
- **日志配置快速参考**：`日志配置快速参考.md`
- **测试脚本**：`test_log_rotation.sh`

## 🚀 后续建议

### **1. 定期清理实时输出日志**

创建一个 cron 任务：

```bash
# 每周清理实时输出日志
0 4 * * 0 cd /path/to/backend && rm -f storage/logs/manager.log storage/logs/scheduler.log storage/logs/campaign_*-worker-*.log
```

### **2. 考虑将实时输出日志也改为按天滚动**

可以修改 `start_worker.sh`：

```bash
# 修改前
nohup php artisan schedule:work > storage/logs/scheduler.log 2>&1 &

# 修改后（使用 multilog 或 rotatelogs）
nohup php artisan schedule:work 2>&1 | rotatelogs storage/logs/scheduler-%Y-%m-%d.log 86400 &
```

### **3. 监控磁盘使用**

```bash
# 每天检查日志目录大小
0 9 * * * du -sh /path/to/storage/logs/ | mail -s "Daily Log Size" admin@example.com
```

## ✨ 总结

日志目录整理已完成！所有日志文件现在统一存放在 `storage/logs/` 目录下，按天滚动的日志会自动清理，实时输出日志需要手动管理。系统现在更加整洁和易于维护！ 🎉

