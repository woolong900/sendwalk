# 日志按天滚动配置说明

## 📋 功能说明

系统已配置为按天滚动日志，每天会创建一个新的日志文件，旧日志会自动清理，避免单个日志文件过大影响性能。

## 🎯 配置详情

### 1. **日志驱动配置** (`config/logging.php`)

#### **默认通道**：`daily`
```php
'default' => env('LOG_CHANNEL', 'daily'),
```

#### **主日志通道**：
```php
'daily' => [
    'driver' => 'daily',
    'path' => storage_path('logs/laravel.log'),
    'level' => env('LOG_LEVEL', 'debug'),
    'days' => env('LOG_DAILY_DAYS', 30),  // 保留30天
    'replace_placeholders' => true,
],
```

#### **专用日志通道**：
为不同的功能模块创建了独立的日志通道，方便分类管理：

- **worker.log**：Worker 进程日志
- **email.log**：邮件发送日志
- **scheduler.log**：调度器日志

### 2. **环境变量配置** (`.env`)

```bash
# 日志通道（按天滚动）
LOG_CHANNEL=daily

# 日志级别
LOG_LEVEL=debug

# 日志保留天数
LOG_DAILY_DAYS=30

# 弃用警告日志
LOG_DEPRECATIONS_CHANNEL=null
```

### 3. **自动清理任务** (`routes/console.php`)

每天凌晨 3:00 自动清理超过 30 天的旧日志：

```php
Schedule::command('logs:cleanup --days=30')
    ->dailyAt('03:00')
    ->runInBackground();
```

## 📂 日志文件命名规则

### **命名格式**

```
laravel-YYYY-MM-DD.log
worker-YYYY-MM-DD.log
email-YYYY-MM-DD.log
scheduler-YYYY-MM-DD.log
```

### **示例**

```
storage/logs/
├── laravel.log              # 当前日志（符号链接或当天日志）
├── laravel-2025-12-20.log   # 今天的日志
├── laravel-2025-12-19.log   # 昨天的日志
├── laravel-2025-12-18.log   # 前天的日志
├── worker-2025-12-20.log
├── email-2025-12-20.log
└── scheduler-2025-12-20.log
```

## 💻 使用方式

### **1. 手动清理旧日志**

#### 查看会删除哪些文件（Dry Run）
```bash
php artisan logs:cleanup --dry-run
```

#### 清理 30 天前的日志（默认）
```bash
php artisan logs:cleanup
```

#### 清理 7 天前的日志
```bash
php artisan logs:cleanup --days=7
```

#### 清理 90 天前的日志
```bash
php artisan logs:cleanup --days=90
```

### **2. 使用专用日志通道**

#### Worker 日志
```php
use Illuminate\Support\Facades\Log;

// 写入 worker.log
Log::channel('worker')->info('Worker started', [
    'campaign_id' => 25,
    'pid' => getmypid(),
]);
```

#### 邮件日志
```php
// 写入 email.log
Log::channel('email')->info('Email sent successfully', [
    'to' => 'user@example.com',
    'campaign_id' => 25,
]);
```

#### 调度器日志
```php
// 写入 scheduler.log
Log::channel('scheduler')->info('Scheduler started');
```

#### 使用默认日志
```php
// 写入 laravel.log（默认）
Log::info('General log message');
```

### **3. 查看日志**

#### 查看今天的日志
```bash
tail -f storage/logs/laravel.log
# 或
tail -f storage/logs/laravel-2025-12-20.log
```

#### 查看 Worker 日志
```bash
tail -f storage/logs/worker-2025-12-20.log
```

#### 查看邮件日志
```bash
tail -f storage/logs/email-2025-12-20.log
```

#### 搜索所有日志
```bash
# 搜索包含 "error" 的日志
grep -r "error" storage/logs/

# 搜索最近7天的错误日志
find storage/logs/ -name "*.log" -mtime -7 -exec grep -l "error" {} \;
```

## 📊 日志级别说明

系统支持以下日志级别（从高到低）：

| 级别 | 说明 | 使用场景 |
|------|------|----------|
| `emergency` | 紧急情况 | 系统崩溃 |
| `alert` | 必须立即采取行动 | 数据库不可用 |
| `critical` | 严重错误 | 应用组件不可用 |
| `error` | 运行时错误 | 邮件发送失败 |
| `warning` | 警告但不是错误 | 速率限制达到 |
| `notice` | 正常但重要的事件 | 用户登录 |
| `info` | 一般信息 | Worker 启动 |
| `debug` | 详细的调试信息 | SQL 查询 |

### **在 .env 中设置日志级别**

```bash
# 生产环境：只记录 warning 及以上
LOG_LEVEL=warning

# 开发环境：记录所有日志
LOG_LEVEL=debug

# 测试环境：记录 info 及以上
LOG_LEVEL=info
```

## 🔍 日志清理命令详解

### **命令签名**
```bash
php artisan logs:cleanup {--days=30} {--dry-run}
```

### **参数说明**

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--days` | 30 | 保留最近 N 天的日志 |
| `--dry-run` | false | 只显示会删除的文件，不实际删除 |

### **输出示例**

```
🧹 Starting log cleanup...
   Log directory: /path/to/storage/logs
   Keep logs newer than: 2025-11-20
   Dry run: No

⏭️  Skipping current log: laravel.log
✅ Deleted: laravel-2025-11-19.log (12.5MB)
✅ Deleted: laravel-2025-11-18.log (15.3MB)
✅ Deleted: worker-2025-11-19.log (5.2MB)

📊 Summary:
   Files kept: 32
   Files deleted: 3
   Space freed: 33.0 MB

✅ Log cleanup completed
```

## 📈 性能优化

### **1. 按天分割的好处**

- ✅ **文件大小可控**：每个日志文件只包含一天的数据
- ✅ **查询速度快**：不需要在巨大的单一文件中搜索
- ✅ **易于归档**：可以轻松将旧日志移动到存储服务器
- ✅ **磁盘空间可控**：自动清理避免磁盘被占满

### **2. 日志文件大小估算**

假设系统每天记录 10,000 条日志，平均每条 200 字节：

```
单日日志大小 = 10,000 × 200 = 2MB
30天日志总大小 = 2MB × 30 = 60MB
```

### **3. 磁盘使用监控**

```bash
# 查看 logs 目录总大小
du -sh storage/logs/

# 查看每个日志文件大小
du -h storage/logs/*.log | sort -hr

# 查看日志文件数量
ls -1 storage/logs/*.log | wc -l
```

## 🔧 故障排查

### **问题 1：日志没有按天分割**

**检查**：
```bash
# 查看当前日志配置
php artisan tinker
>>> config('logging.default')
>>> config('logging.channels.daily')
```

**解决方案**：
```bash
# 清除配置缓存
php artisan config:clear

# 重新生成缓存
php artisan config:cache
```

### **问题 2：自动清理不工作**

**检查调度器是否运行**：
```bash
# 查看调度器进程
ps aux | grep "schedule:work"

# 手动运行清理任务
php artisan logs:cleanup --dry-run
```

**解决方案**：
```bash
# 启动调度器
php artisan schedule:work &
```

### **问题 3：日志权限问题**

**检查权限**：
```bash
ls -la storage/logs/
```

**修复权限**：
```bash
# 给 logs 目录设置正确的权限
chmod -R 775 storage/logs/
chown -R www-data:www-data storage/logs/  # Linux
chown -R _www:_www storage/logs/          # macOS
```

### **问题 4：日志文件太大**

如果单日日志文件超过 100MB：

**短期方案**：
```bash
# 手动压缩旧日志
gzip storage/logs/laravel-2025-12-19.log

# 查看压缩后的日志
zcat storage/logs/laravel-2025-12-19.log.gz | less
```

**长期方案**：
1. 降低日志级别（`LOG_LEVEL=warning`）
2. 使用专用日志通道分散日志
3. 缩短日志保留天数（`LOG_DAILY_DAYS=7`）

## 📦 备份和归档

### **1. 压缩旧日志**

```bash
# 压缩 7 天前的日志
find storage/logs/ -name "*.log" -mtime +7 -exec gzip {} \;

# 解压查看
gunzip -c storage/logs/laravel-2025-12-01.log.gz | less
```

### **2. 归档到 S3 或其他存储**

```bash
#!/bin/bash
# 每周归档日志到 S3

DATE=$(date +%Y-%m-%d)
TAR_FILE="logs-${DATE}.tar.gz"

# 压缩日志
tar -czf /tmp/${TAR_FILE} -C storage logs/

# 上传到 S3
aws s3 cp /tmp/${TAR_FILE} s3://your-bucket/logs/

# 清理本地归档
rm /tmp/${TAR_FILE}

echo "Logs archived to S3: ${TAR_FILE}"
```

### **3. 自动化归档任务**

在 `routes/console.php` 中添加：

```php
// 每周日凌晨4点归档日志
Schedule::exec('bash /path/to/archive_logs.sh')
    ->weekly()
    ->sundays()
    ->at('04:00');
```

## 🎯 最佳实践

### **1. 日志级别设置**

```bash
# 开发环境
LOG_LEVEL=debug
LOG_DAILY_DAYS=7

# 测试环境
LOG_LEVEL=info
LOG_DAILY_DAYS=14

# 生产环境
LOG_LEVEL=warning
LOG_DAILY_DAYS=30
```

### **2. 结构化日志**

使用上下文数组记录详细信息：

```php
// ✅ 好的做法
Log::info('Email sent', [
    'campaign_id' => 25,
    'subscriber_id' => 100,
    'smtp_server' => 'AWS SES',
    'duration_ms' => 150,
]);

// ❌ 不好的做法
Log::info('Email sent to subscriber 100 for campaign 25');
```

### **3. 使用专用日志通道**

```php
// Worker 日志
Log::channel('worker')->info('Worker started');

// 邮件日志
Log::channel('email')->error('Email failed', $context);

// 默认日志
Log::info('General information');
```

### **4. 定期监控**

```bash
# 每天检查日志大小
0 9 * * * du -sh /path/to/storage/logs/ | mail -s "Daily Log Size" admin@example.com

# 每周报告错误日志数量
0 9 * * 0 grep -r "ERROR" /path/to/storage/logs/ | wc -l | mail -s "Weekly Error Count" admin@example.com
```

## ✅ 检查清单

在部署后，请确认以下项目：

- [ ] `config/logging.php` 文件已创建
- [ ] `.env` 中 `LOG_CHANNEL=daily`
- [ ] `.env` 中 `LOG_DAILY_DAYS=30`
- [ ] 调度器正在运行（`php artisan schedule:work`）
- [ ] `storage/logs/` 目录权限正确（775）
- [ ] 手动运行 `php artisan logs:cleanup --dry-run` 测试
- [ ] 查看日志文件是否按天创建
- [ ] 检查磁盘空间是否充足

## 🚀 总结

日志按天滚动配置已完成，系统现在会：

- ✅ 每天创建新的日志文件
- ✅ 自动清理超过 30 天的旧日志
- ✅ 支持多个专用日志通道
- ✅ 提供手动清理工具
- ✅ 保持日志目录整洁，避免磁盘占满

现在您可以更轻松地管理和查看日志，系统性能也会更好！ 🎉

