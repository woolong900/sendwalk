# ğŸš¨ SMTP æœåŠ¡å™¨è‡ªåŠ¨æš‚åœ - å¿«é€ŸæŒ‡å—

## é—®é¢˜
å‘é€æ—¥å¿—ä¸­å‡ºç°å¤§é‡ `Excessive message rate from sender` é”™è¯¯ã€‚

## è§£å†³æ–¹æ¡ˆ
âœ… **å·²å®ç°è‡ªåŠ¨æš‚åœåŠŸèƒ½**

å½“æ£€æµ‹åˆ°é¢‘ç‡é™åˆ¶é”™è¯¯æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æš‚åœè¯¥ SMTP æœåŠ¡å™¨ 5 åˆ†é’Ÿã€‚

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### è‡ªåŠ¨æ£€æµ‹ä»¥ä¸‹é”™è¯¯å¹¶æš‚åœï¼š

- âœ… `Excessive message rate`
- âœ… `Too many messages`
- âœ… `Rate limit exceeded`
- âœ… `Sending rate exceeded`
- âœ… `Throttle`
- âœ… `Quota exceeded`
- âœ… ä»¥åŠå…¶ä»–é¢‘ç‡é™åˆ¶ç›¸å…³é”™è¯¯

### æš‚åœåçš„è¡Œä¸ºï¼š

1. **è‡ªåŠ¨æš‚åœ** - æ£€æµ‹åˆ°é”™è¯¯åç«‹å³æš‚åœ 5 åˆ†é’Ÿ
2. **è‡ªåŠ¨åˆ‡æ¢** - ä½¿ç”¨å…¶ä»–å¯ç”¨çš„ SMTP æœåŠ¡å™¨ç»§ç»­å‘é€
3. **è‡ªåŠ¨æ¢å¤** - 5 åˆ†é’Ÿåè‡ªåŠ¨è§£é™¤æš‚åœ
4. **è®°å½•æ—¥å¿—** - è¯¦ç»†è®°å½•æš‚åœå’Œæ¢å¤äº‹ä»¶

---

## ğŸ“Š æŸ¥çœ‹çŠ¶æ€

### 1. æŸ¥çœ‹æœåŠ¡å™¨æ˜¯å¦è¢«æš‚åœ

```http
GET /api/smtp-servers/{serverId}/rate-limit-status
```

**å“åº”ç¤ºä¾‹ï¼ˆè¢«æš‚åœï¼‰ï¼š**
```json
{
  "data": {
    "can_send": false,
    "blocked_by": "temporarily_paused",
    "wait_seconds": 180,
    "is_paused": true,
    "pause_remaining_seconds": 180
  }
}
```

### 2. æ‰‹åŠ¨æ¢å¤æœåŠ¡å™¨

å¦‚æœéœ€è¦æå‰æ¢å¤ï¼š

```http
POST /api/smtp-servers/{serverId}/resume
```

---

## ğŸ” æŸ¥çœ‹æ—¥å¿—

### ç›‘æ§æš‚åœäº‹ä»¶

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f backend/storage/logs/laravel.log | grep "paused"

# æŸ¥çœ‹æš‚åœå†å²
grep "temporarily paused" backend/storage/logs/laravel.log
```

### æ—¥å¿—ç¤ºä¾‹

**è‡ªåŠ¨æš‚åœï¼š**
```
[2024-12-25 10:30:15] WARNING: SMTP server auto-paused due to rate limit error
Campaign: 123, Server: Gmail SMTP (ID: 5)
Error: Excessive message rate from sender
Duration: 5 minutes
```

**è‡ªåŠ¨æ¢å¤ï¼š**
```
5 åˆ†é’Ÿåï¼ŒæœåŠ¡å™¨è‡ªåŠ¨æ¢å¤å¯ç”¨ï¼ˆæ— éœ€äººå·¥å¹²é¢„ï¼‰
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é…ç½®å¤šä¸ª SMTP æœåŠ¡å™¨

- å»ºè®®è‡³å°‘ 2-3 ä¸ª SMTP æœåŠ¡å™¨
- ä¸€ä¸ªè¢«æš‚åœæ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨å…¶ä»–æœåŠ¡å™¨
- é¿å…å‘é€ä¸­æ–­

### 2. åˆç†è®¾ç½®é¢‘ç‡é™åˆ¶

åœ¨ SMTP æœåŠ¡å™¨é…ç½®ä¸­ï¼š

```
æ¯ç§’ï¼š14 å°
æ¯åˆ†é’Ÿï¼š60 å°
æ¯å°æ—¶ï¼š500 å°
æ¯å¤©ï¼š5000 å°
```

### 3. ç›‘æ§å‘Šè­¦

å¦‚æœé¢‘ç¹å‡ºç°æš‚åœï¼š

- âœ… é™ä½æ´»åŠ¨å‘é€é€Ÿç‡
- âœ… å¢åŠ æ›´å¤š SMTP æœåŠ¡å™¨
- âœ… æ£€æŸ¥æœåŠ¡å•†é™åˆ¶æ”¿ç­–

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### Q: æœåŠ¡å™¨ä¸€ç›´è¢«æš‚åœï¼Ÿ

**è§£å†³ï¼š**
```bash
# 1. æ‰‹åŠ¨æ¢å¤
POST /api/smtp-servers/{serverId}/resume

# 2. é™ä½å‘é€é€Ÿç‡æˆ–å¢åŠ æœåŠ¡å™¨
```

### Q: å¦‚ä½•æŸ¥çœ‹ Redis ä¸­çš„æš‚åœçŠ¶æ€ï¼Ÿ

```bash
# æŸ¥çœ‹æ‰€æœ‰æš‚åœçš„æœåŠ¡å™¨
redis-cli KEYS "smtp_server_paused_*"

# æŸ¥çœ‹å…·ä½“æœåŠ¡å™¨çš„æš‚åœæ—¶é—´
redis-cli GET "smtp_server_paused_5"
```

---

## âœ… æµ‹è¯•ç»“æœ

æ‰€æœ‰åŠŸèƒ½å·²æµ‹è¯•é€šè¿‡ï¼š

- âœ… æš‚åœåŠŸèƒ½æ­£å¸¸
- âœ… è‡ªåŠ¨æ¢å¤æ­£å¸¸
- âœ… æ‰‹åŠ¨æ¢å¤æ­£å¸¸
- âœ… é”™è¯¯æ£€æµ‹å‡†ç¡®
- âœ… çŠ¶æ€æŸ¥è¯¢æ­£å¸¸

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### ä¿®æ”¹çš„æ–‡ä»¶

1. `app/Models/SmtpServer.php` - æš‚åœ/æ¢å¤é€»è¾‘
2. `app/Jobs/SendCampaignEmail.php` - é”™è¯¯æ£€æµ‹
3. `app/Http/Controllers/Api/SmtpServerController.php` - API æ¥å£
4. `routes/api.php` - è·¯ç”±

### å®ç°æ–¹å¼

- **å­˜å‚¨ï¼š** Redis Cacheï¼ˆè‡ªåŠ¨è¿‡æœŸï¼‰
- **æ£€æµ‹ï¼š** æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…é”™è¯¯æ¶ˆæ¯
- **æ¢å¤ï¼š** 5 åˆ†é’Ÿ TTL è‡ªåŠ¨è¿‡æœŸ

---

## ğŸ‰ æ€»ç»“

âœ… **åŠŸèƒ½å·²ä¸Šçº¿ï¼**

ç°åœ¨ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†é¢‘ç‡é™åˆ¶é”™è¯¯ï¼Œä¿æŠ¤æ‚¨çš„ SMTP è´¦å·ä¸è¢«å°ç¦ã€‚

**è¯¦ç»†æ–‡æ¡£ï¼š** `SMTPæœåŠ¡å™¨è‡ªåŠ¨æš‚åœåŠŸèƒ½è¯´æ˜.md`

---

**ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é…ç½®ï¼** ğŸš€

