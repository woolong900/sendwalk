# 🎨 邮件模板系统 - 部署说明

## ✅ 已实现的功能

### 核心功能
- ✅ **模板管理**：创建、编辑、删除、复制模板
- ✅ **模板分类**：6种分类（通用、营销、交易、新闻、欢迎、公告）
- ✅ **模板预览**：实时预览模板效果
- ✅ **变量支持**：支持邮件个性化变量
- ✅ **系统模板**：4个预设模板（不可删除，可复制）
- ✅ **搜索筛选**：按名称、描述、分类搜索
- ✅ **使用统计**：记录模板使用次数和时间

### 预设模板
1. ��**简约通知模板** - 适合系统通知
2. **营销推广模板** - 带醒目 CTA 按钮
3. **新闻资讯模板** - 多内容块布局
4. **欢迎邮件模板** - 温暖的欢迎设计

---

## 📦 数据库变更

### 新增表
**templates** - 邮件模板表
- id - 主键
- user_id - 用户ID
- name - 模板名称
- category - 分类（general, marketing, transactional, newsletter, welcome, announcement）
- description - 描述
- thumbnail - 缩略图URL（可选）
- html_content - HTML 内容
- plain_content - 纯文本（可选）
- is_default - 是否系统默认模板
- is_active - 是否启用
- usage_count - 使用次数
- last_used_at - 最后使用时间
- created_at, updated_at - 时间戳

---

## 📁 新增/修改的文件

### 后端文件
- ✅ `database/migrations/2025_12_24_183316_create_templates_table.php` - 数据库迁移
- ✅ `app/Models/Template.php` - 模板模型
- ✅ `app/Http/Controllers/Api/TemplateController.php` - API 控制器
- ✅ `database/seeders/TemplateSeeder.php` - 预设模板种子数据
- ✅ `routes/api.php` - API 路由（已添加模板路由）

### 前端文件
- ✅ `frontend/src/pages/templates/index.tsx` - 模板列表页面
- ✅ `frontend/src/pages/templates/editor.tsx` - 模板编辑器页面
- ✅ `frontend/src/App.tsx` - 路由配置（已添加模板路由）
- ✅ `frontend/src/layouts/dashboard-layout.tsx` - 侧边栏菜单（已添加模板菜单）

---

## 🚀 部署步骤

### 本地开发环境（已完成）

后端迁移已执行：
```bash
cd backend
php artisan migrate
php artisan db:seed --class=TemplateSeeder
```

### 生产环境部署

#### 1. 备份数据库
```bash
cd /data/www/sendwalk/backend
mysqldump -u root -p sendwalk > ~/backup_before_templates_$(date +%Y%m%d_%H%M%S).sql
```

#### 2. 拉取代码
```bash
cd /data/www/sendwalk
git pull origin main
```

#### 3. 后端部署
```bash
cd /data/www/sendwalk/backend

# 运行数据库迁移
php artisan migrate --force

# 创建预设模板
php artisan db:seed --class=TemplateSeeder

# 清理缓存
php artisan config:clear
php artisan cache:clear
php artisan route:clear
```

#### 4. 前端部署
```bash
cd /data/www/sendwalk/frontend

# 安装依赖（如果有新的）
npm install

# 构建生产版本
npm run build

# 复制到 Nginx 目录（如果需要）
# 注意：根据你的实际部署配置调整
```

#### 5. 验证部署
```bash
# 检查模板表
mysql -u root -p -D sendwalk -e "SELECT id, name, category FROM templates;"

# 检查路由
php artisan route:list | grep template
```

---

## 📖 使用指南

### 1. 访问模板管理

登录系统后，在左侧菜单中点击 **"邮件模板"**。

### 2. 查看预设模板

系统已预置 4 个模板：
- 简约通知模板（交易通知）
- 营销推广模板（营销推广）
- 新闻资讯模板（新闻资讯）
- 欢迎邮件模板（欢迎邮件）

### 3. 创建新模板

1. 点击 **"创建模板"** 按钮
2. 填写基本信息：
   - **模板名称** *（必填）
   - **分类** *（必填）
   - **描述**（选填）
3. 编写 HTML 内容
4. 使用变量：
   - `{email}` - 订阅者邮箱
   - `{first_name}` - 名
   - `{last_name}` - 姓
   - `{full_name}` - 全名
   - `{sender_domain}` - 发件域名
   - `{unsubscribe_url}` - 退订链接
5. 点击 **"预览"** 查看效果
6. 点击 **"保存"** 完成创建

### 4. 编辑模板

- **用户创建的模板**：直接点击 "编辑" 按钮
- **系统默认模板**：点击 "复制编辑"（会创建副本）

### 5. 复制模板

点击 "复制" 按钮，系统会创建一个副本，名称为 "原模板名 (副本)"。

### 6. 删除模板

- 只有用户创建的模板可以删除
- 系统默认模板不能删除

### 7. 搜索和筛选

- **搜索框**：输入模板名称或描述关键词
- **分类筛选**：选择特定分类查看

---

## 🎯 API 接口文档

### 获取模板列表
```http
GET /api/templates
Query Parameters:
  - search: 搜索关键词
  - category: 分类筛选
  - active_only: 只显示启用的模板
  - sort_by: 排序字段（默认：updated_at）
  - sort_order: 排序方向（默认：desc）
```

### 获取单个模板
```http
GET /api/templates/{id}
```

### 创建模板
```http
POST /api/templates
Body:
  {
    "name": "模板名称",
    "category": "general",
    "description": "描述",
    "html_content": "HTML内容",
    "is_active": true
  }
```

### 更新模板
```http
PUT /api/templates/{id}
Body: 同创建模板
```

### 删除模板
```http
DELETE /api/templates/{id}
```

### 复制模板
```http
POST /api/templates/{id}/duplicate
Body:
  {
    "name": "新模板名称"  // 可选
  }
```

### 预览模板
```http
GET /api/templates/{id}/preview
```

### 获取分类列表
```http
GET /api/templates/categories
```

---

## 🔍 测试验证

### 1. 测试模板列表
```bash
curl -X GET "http://localhost:8000/api/templates" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2. 测试创建模板
```bash
curl -X POST "http://localhost:8000/api/templates" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试模板",
    "category": "general",
    "description": "这是一个测试模板",
    "html_content": "<h1>Hello {first_name}!</h1>"
  }'
```

### 3. 测试模板预览
```bash
curl -X GET "http://localhost:8000/api/templates/1/preview" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 4. 前端测试
1. 访问 http://localhost:5173/templates
2. 查看预设模板
3. 创建新模板
4. 编辑模板
5. 预览模板
6. 复制模板
7. 删除模板

---

## 💡 下一步增强（可选）

### 优先级高 ⭐⭐⭐
1. **在活动编辑器中集成模板选择**
   - 创建活动时可以选择模板
   - 一键应用模板内容
   - 预计时间：1-2 小时

2. **模板缩略图上传**
   - 支持上传模板截图
   - 在列表页显示预览图
   - 预计时间：1-2 小时

### 优先级中 ⭐⭐
3. **模板标签系统**
   - 为模板添加标签
   - 按标签筛选
   - 预计时间：2-3 小时

4. **模板导入/导出**
   - 导出为 JSON/HTML
   - 从文件导入模板
   - 预计时间：2-3 小时

### 优先级低 ⭐
5. **可视化编辑器**
   - 集成 GrapesJS 或类似编辑器
   - 拖拽式设计
   - 预计时间：8-10 小时

6. **模板市场**
   - 更多预设模板
   - 模板分享功能
   - 预计时间：10+ 小时

---

## ❓ 常见问题

### Q1: 如何添加更多预设模板？
A: 编辑 `backend/database/seeders/TemplateSeeder.php`，添加新的模板数据，然后运行：
```bash
php artisan db:seed --class=TemplateSeeder --force
```

### Q2: 模板变量不起作用？
A: 确保使用花括号包裹变量名，如 `{email}` 而不是 `{{email}}`。

### Q3: 如何修改模板分类？
A: 编辑 `backend/app/Models/Template.php` 中的 `CATEGORIES` 常量，然后更新前端。

### Q4: 可以上传图片到模板吗？
A: 目前需要使用外部图片 URL。后续可以添加图片上传功能。

### Q5: 系统默认模板可以修改吗？
A: 不能直接修改，但可以复制后编辑副本。

---

## ✅ 部署完成检查清单

- [ ] 数据库迁移已执行
- [ ] 预设模板已创建
- [ ] 后端缓存已清理
- [ ] 前端已构建
- [ ] 可以访问模板列表页面
- [ ] 可以创建新模板
- [ ] 可以编辑模板
- [ ] 可以预览模板
- [ ] 可以复制模板
- [ ] 可以删除用户模板
- [ ] 系统模板显示正确（不可删除）

---

## 🎉 完成！

邮件模板系统已成功实现！

现在您可以：
- ✅ 快速创建专业的邮件模板
- ✅ 使用预设模板节省时间
- ✅ 通过变量实现邮件个性化
- ✅ 管理和组织模板库
- ✅ 提高邮件创建效率

下一步建议：
1. 在活动编辑器中集成模板选择
2. 添加模板缩略图功能
3. 创建更多行业模板

有任何问题随时咨询！

