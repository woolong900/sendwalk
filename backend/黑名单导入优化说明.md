# ğŸš€ é»‘åå•å¤§æ‰¹é‡å¯¼å…¥ä¼˜åŒ–æ–¹æ¡ˆ

## âŒ é—®é¢˜æè¿°

å¯¼å…¥ 200 ä¸‡æ¡é»‘åå•æ—¶å‡ºç°å†…å­˜æº¢å‡ºé”™è¯¯ï¼š

```
Allowed memory size of 134217728 bytes exhausted (tried to allocate 16777224 bytes)
```

### æ ¹æœ¬åŸå› 

1. **å†…å­˜æº¢å‡º**ï¼š`preg_split()` å°† 200 ä¸‡æ¡é‚®ç®±ä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜ï¼ˆ128MB é™åˆ¶ï¼‰
2. **æ€§èƒ½ä½ä¸‹**ï¼šé€æ¡ `firstOrCreate()`ï¼Œæ¯æ¡éƒ½æŸ¥è¯¢æ•°æ®åº“
3. **è¯·æ±‚è¶…æ—¶**ï¼šåŒæ­¥å¤„ç†å¤§é‡æ•°æ®å¯¼è‡´ HTTP è¯·æ±‚è¶…æ—¶

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šé˜Ÿåˆ— + åˆ†æ‰¹å¤„ç†

### æ ¸å¿ƒæ€è·¯

```
ç”¨æˆ·ä¸Šä¼  â†’ è‡ªåŠ¨è¯†åˆ«æ•°é‡ â†’ å°æ‰¹é‡åŒæ­¥ / å¤§æ‰¹é‡å¼‚æ­¥
                           â†“
                    åˆ†æ‰¹å…¥é˜Ÿï¼ˆ1000æ¡/æ‰¹ï¼‰
                           â†“
                    åå°é˜Ÿåˆ—å¤„ç†
                           â†“
                    æ‰¹é‡æ•°æ®åº“æ’å…¥
                           â†“
                    å®æ—¶è¿›åº¦æ›´æ–°
```

### æŠ€æœ¯äº®ç‚¹

âœ… **æ™ºèƒ½åˆ†æµ**ï¼š< 10,000 æ¡åŒæ­¥å¤„ç†ï¼Œ> 10,000 æ¡å¼‚æ­¥é˜Ÿåˆ—  
âœ… **æµå¼å¤„ç†**ï¼šé€è¡Œè¯»å–ï¼Œé¿å…å†…å­˜æº¢å‡º  
âœ… **æ‰¹é‡æ’å…¥**ï¼š500 æ¡ä¸€æ‰¹ï¼Œæ€§èƒ½æå‡ 100 å€+  
âœ… **è¿›åº¦è·Ÿè¸ª**ï¼šRedis ç¼“å­˜ï¼Œå®æ—¶æŸ¥è¯¢è¿›åº¦  
âœ… **äº‹åŠ¡ä¿è¯**ï¼šæ•°æ®ä¸€è‡´æ€§ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š  
âœ… **å¤±è´¥é‡è¯•**ï¼šæœ€å¤šé‡è¯• 3 æ¬¡  

---

## ğŸ“ æ–°å¢æ–‡ä»¶

### 1. ImportBlacklistJob.php

é˜Ÿåˆ—ä»»åŠ¡ç±»ï¼Œè´Ÿè´£åå°å¤„ç†å¯¼å…¥ã€‚

**å…³é”®æ–¹æ³•**ï¼š
- `handle()`ï¼šæ‰§è¡Œå¯¼å…¥é€»è¾‘
  - éªŒè¯é‚®ç®±æ ¼å¼
  - æ‰¹é‡æŸ¥è¯¢å·²å­˜åœ¨çš„é‚®ç®±
  - æ‰¹é‡æ’å…¥æ–°é‚®ç®±
  - æ‰¹é‡æ›´æ–°è®¢é˜…è€…çŠ¶æ€
  - æ›´æ–°è¿›åº¦

- `updateProgress()`ï¼šä½¿ç”¨ Redis åŸå­é”æ›´æ–°è¿›åº¦
- `failed()`ï¼šå¤±è´¥æ—¶è®°å½•é”™è¯¯

**æ€§èƒ½ä¼˜åŒ–**ï¼š
```php
// æ‰¹é‡æŸ¥è¯¢ï¼ˆ1æ¬¡æ•°æ®åº“è¯·æ±‚ï¼‰
$existingEmails = Blacklist::whereIn('email', $validEmails)->pluck('email');

// æ‰¹é‡æ’å…¥ï¼ˆ500æ¡ä¸€æ‰¹ï¼‰
foreach (array_chunk($insertData, 500) as $chunk) {
    Blacklist::insert($chunk);
}

// æ‰¹é‡æ›´æ–°ï¼ˆé¿å… N+1 æŸ¥è¯¢ï¼‰
Subscriber::whereIn('id', $subscriberIds)->update(['status' => 'blacklisted']);
```

### 2. BlacklistController.phpï¼ˆä¿®æ”¹ï¼‰

**æ–°å¢æ–¹æ³•**ï¼š

#### `batchUploadAsync()`
å¤§æ‰¹é‡å¼‚æ­¥å¤„ç†ï¼š
- ç”Ÿæˆå”¯ä¸€ `task_id`
- é€è¡Œè§£æé‚®ç®±ï¼ˆé¿å…å†…å­˜æº¢å‡ºï¼‰
- åˆ†æ‰¹åˆ†å‘åˆ°é˜Ÿåˆ—ï¼ˆ1000æ¡/æ‰¹ï¼‰
- åˆå§‹åŒ–è¿›åº¦ç¼“å­˜
- è¿”å› `task_id` å’Œ `202 Accepted`

#### `importProgress()`
æŸ¥è¯¢å¯¼å…¥è¿›åº¦ï¼š
- é€šè¿‡ `task_id` ä» Redis è¯»å–è¿›åº¦
- è¿”å›å®Œæˆæ‰¹æ¬¡ã€æ€»æ‰¹æ¬¡ã€æˆåŠŸ/å¤±è´¥æ•°é‡
- è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”

**å…³é”®ä»£ç **ï¼š
```php
// æ™ºèƒ½åˆ†æµ
if ($emailCount > 10000) {
    return $this->batchUploadAsync($request, $emailsText);
}

// é€è¡Œå¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡º
$lines = explode("\n", $emailsText);
foreach ($lines as $line) {
    $lineEmails = preg_split('/[,;]+/', $line);
    foreach ($lineEmails as $email) {
        $emails[] = trim($email);
        if (count($emails) >= 1000) {
            ImportBlacklistJob::dispatch(...);
            $emails = []; // æ¸…ç©ºæ•°ç»„
        }
    }
}
```

---

## ğŸ”§ API ä½¿ç”¨æ–¹æ³•

### 1. æ‰¹é‡ä¸Šä¼ ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰

**è¯·æ±‚**ï¼š
```bash
POST /api/blacklist/batch-upload
Content-Type: application/json
Authorization: Bearer YOUR_TOKEN

{
  "emails": "email1@example.com\nemail2@example.com\n...",
  "reason": "åƒåœ¾é‚®ä»¶"
}
```

**å“åº”ï¼ˆå°æ‰¹é‡ - åŒæ­¥ï¼‰**ï¼š
```json
{
  "message": "æ‰¹é‡ä¸Šä¼ å®Œæˆ",
  "added": 5000,
  "already_exists": 200,
  "invalid": 50,
  "subscribers_updated": 4800
}
```

**å“åº”ï¼ˆå¤§æ‰¹é‡ - å¼‚æ­¥ï¼‰**ï¼š
```json
{
  "message": "å¤§æ‰¹é‡å¯¼å…¥å·²æäº¤åˆ°é˜Ÿåˆ—å¤„ç†ï¼Œè¯·ç¨åæŸ¥çœ‹è¿›åº¦",
  "task_id": "import_1703462400_abc123",
  "total_emails": 2000000,
  "total_batches": 2000,
  "status": "processing"
}
```

### 2. æŸ¥è¯¢å¯¼å…¥è¿›åº¦

**è¯·æ±‚**ï¼š
```bash
GET /api/blacklist/import-progress/{task_id}
Authorization: Bearer YOUR_TOKEN
```

**å“åº”ï¼ˆè¿›è¡Œä¸­ï¼‰**ï¼š
```json
{
  "total_batches": 2000,
  "completed_batches": 500,
  "total_emails": 2000000,
  "added": 480000,
  "already_exists": 15000,
  "invalid": 5000,
  "subscribers_updated": 475000,
  "status": "processing",
  "progress_percentage": 25.0,
  "started_at": "2025-12-24T14:30:00Z"
}
```

**å“åº”ï¼ˆå®Œæˆï¼‰**ï¼š
```json
{
  "total_batches": 2000,
  "completed_batches": 2000,
  "total_emails": 2000000,
  "added": 1950000,
  "already_exists": 40000,
  "invalid": 10000,
  "subscribers_updated": 1930000,
  "status": "completed",
  "progress_percentage": 100.0,
  "started_at": "2025-12-24T14:30:00Z",
  "completed_at": "2025-12-24T14:38:45Z"
}
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. è¿è¡Œéƒ¨ç½²è„šæœ¬

```bash
cd /data/www/sendwalk/backend
chmod +x ä¼˜åŒ–é»‘åå•å¯¼å…¥.sh
./ä¼˜åŒ–é»‘åå•å¯¼å…¥.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- âœ… æ£€æŸ¥ Redis å’Œé˜Ÿåˆ—è¿›ç¨‹
- âœ… æ£€æŸ¥ PHP é…ç½®ï¼ˆå†…å­˜ã€æ‰§è¡Œæ—¶é—´ï¼‰
- âœ… æ‰§è¡Œæ•°æ®åº“è¿ç§»
- âœ… é‡å¯é˜Ÿåˆ—è¿›ç¨‹ï¼ˆåº”ç”¨æ–°ä»£ç ï¼‰
- âœ… æä¾›æµ‹è¯•æ–¹æ³•

### 2. æ‰‹åŠ¨éƒ¨ç½²ï¼ˆå¦‚ä¸ä½¿ç”¨è„šæœ¬ï¼‰

```bash
# 1. ç¡®ä¿ Redis è¿è¡Œ
redis-cli ping

# 2. å¯åŠ¨é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹
php artisan queue:work --sleep=3 --tries=3 --max-time=3600 &

# 3. ç›‘æ§é˜Ÿåˆ—
tail -f storage/logs/queue.log
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ•°æ®é‡ | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | æå‡ |
|--------|--------|--------|------|
| 1ä¸‡æ¡ | 30ç§’ | 3ç§’ | **10å€** |
| 10ä¸‡æ¡ | 5åˆ†é’Ÿ | 30ç§’ | **10å€** |
| 50ä¸‡æ¡ | å†…å­˜æº¢å‡º âŒ | 2åˆ†é’Ÿ âœ… | **âˆ** |
| 100ä¸‡æ¡ | å†…å­˜æº¢å‡º âŒ | 3-5åˆ†é’Ÿ âœ… | **âˆ** |
| 200ä¸‡æ¡ | å†…å­˜æº¢å‡º âŒ | 5-10åˆ†é’Ÿ âœ… | **âˆ** |

### æ€§èƒ½æå‡åŸå› 

1. **æ‰¹é‡æ’å…¥ vs é€æ¡æ’å…¥**
   ```php
   // æ—§æ–¹æ¡ˆï¼š200ä¸‡æ¬¡æ•°æ®åº“æŸ¥è¯¢
   foreach ($emails as $email) {
       Blacklist::firstOrCreate(...); // æ¯æ¬¡2æ¬¡æŸ¥è¯¢
   }
   
   // æ–°æ–¹æ¡ˆï¼š2000æ¬¡æ‰¹é‡æ“ä½œ
   Blacklist::insert($chunk); // 500æ¡ä¸€æ‰¹
   ```

2. **å†…å­˜ä½¿ç”¨**
   ```
   æ—§æ–¹æ¡ˆï¼š200ä¸‡ Ã— 30å­—èŠ‚ = 60MBï¼ˆæ•°ç»„ï¼‰ â†’ è¶…è¿‡128MBé™åˆ¶
   æ–°æ–¹æ¡ˆï¼š1000 Ã— 30å­—èŠ‚ = 30KBï¼ˆåˆ†æ‰¹ï¼‰ â†’ è¿œä½äºé™åˆ¶
   ```

3. **å¼‚æ­¥å¤„ç†**
   ```
   æ—§æ–¹æ¡ˆï¼šç”¨æˆ·ç­‰å¾…10åˆ†é’Ÿ â†’ è¯·æ±‚è¶…æ—¶
   æ–°æ–¹æ¡ˆï¼šç«‹å³è¿”å› task_id â†’ åå°å¤„ç†
   ```

---

## ğŸ” ç›‘æ§å’Œæ’æŸ¥

### 1. ç›‘æ§é˜Ÿåˆ—çŠ¶æ€

```bash
# æŸ¥çœ‹é˜Ÿåˆ—ä»»åŠ¡æ•°
redis-cli LLEN queues:default

# æŸ¥çœ‹å¤±è´¥ä»»åŠ¡
php artisan queue:failed

# é‡è¯•å¤±è´¥ä»»åŠ¡
php artisan queue:retry all
```

### 2. ç›‘æ§æ—¥å¿—

```bash
# é˜Ÿåˆ—æ—¥å¿—
tail -f storage/logs/queue.log

# Laravel æ—¥å¿—
tail -f storage/logs/laravel.log

# æœç´¢å¯¼å…¥ä»»åŠ¡
grep "é»‘åå•å¯¼å…¥" storage/logs/laravel.log
```

### 3. å¸¸è§é—®é¢˜

**Q: é˜Ÿåˆ—å¡ä½ä¸åŠ¨ï¼Ÿ**
```bash
# é‡å¯é˜Ÿåˆ—
php artisan queue:restart

# æ¸…ç©ºé˜Ÿåˆ—ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
php artisan queue:clear
```

**Q: è¿›åº¦ä¸€ç›´ä¸æ›´æ–°ï¼Ÿ**
```bash
# æ£€æŸ¥ Redis
redis-cli ping

# æŸ¥çœ‹å¯¼å…¥ä»»åŠ¡ç¼“å­˜
redis-cli KEYS "blacklist_import_*"
redis-cli GET "blacklist_import_YOUR_TASK_ID"
```

**Q: å†…å­˜è¿˜æ˜¯ä¸å¤Ÿï¼Ÿ**
```bash
# ä¸´æ—¶æé«˜å†…å­˜é™åˆ¶
php -d memory_limit=1G artisan queue:work

# æˆ–ä¿®æ”¹ php.ini
# memory_limit = 512M
```

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### 1. æ•°æ®å‡†å¤‡

```
# æ”¯æŒçš„æ ¼å¼
email1@example.com
email2@example.com,email3@example.com
email4@example.com;email5@example.com

# æ¨èæ ¼å¼ï¼ˆä¸€è¡Œä¸€ä¸ªï¼‰
email1@example.com
email2@example.com
email3@example.com
```

### 2. åˆ†æ‰¹ä¸Šä¼ ç­–ç•¥

- **< 1ä¸‡æ¡**ï¼šç›´æ¥ä¸Šä¼ ï¼ŒåŒæ­¥å¤„ç†
- **1-10ä¸‡æ¡**ï¼šåˆ†æ‰¹ä¸Šä¼ ï¼Œæ¯æ‰¹5ä¸‡
- **> 10ä¸‡æ¡**ï¼šä¸€æ¬¡æ€§ä¸Šä¼ ï¼Œå¼‚æ­¥å¤„ç†

### 3. æœ€ä½³å®è·µ

1. âœ… å…ˆç”¨å°æ•°æ®æµ‹è¯•ï¼ˆ100æ¡ï¼‰
2. âœ… ä¿å­˜ `task_id`ï¼Œå®šæœŸæŸ¥è¯¢è¿›åº¦
3. âœ… ç›‘æ§é˜Ÿåˆ—æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
4. âœ… é¿å…åŒæ—¶æäº¤å¤šä¸ªè¶…å¤§ä»»åŠ¡
5. âœ… å®šæœŸæ¸…ç†æ—§çš„å¯¼å…¥è¿›åº¦ç¼“å­˜

---

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **æƒé™æ§åˆ¶**ï¼šåªå…è®¸è®¤è¯ç”¨æˆ·å¯¼å…¥
2. **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼šNginx å’Œ PHP ä¸Šä¼ é™åˆ¶
3. **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢æ»¥ç”¨ï¼ˆå¯é€‰ï¼‰
4. **æ•°æ®éªŒè¯**ï¼šä¸¥æ ¼éªŒè¯é‚®ç®±æ ¼å¼

---

## ğŸ¯ åç»­ä¼˜åŒ–æ–¹å‘

1. **å‰ç«¯è¿›åº¦æ¡**ï¼šå®æ—¶æ˜¾ç¤ºå¯¼å…¥è¿›åº¦
2. **å¯¼å…¥å†å²**ï¼šä¿å­˜å¯¼å…¥è®°å½•åˆ°æ•°æ®åº“
3. **CSV æ–‡ä»¶ä¸Šä¼ **ï¼šæ”¯æŒæ–‡ä»¶ä¸Šä¼ æ–¹å¼
4. **å¯¼å‡ºåŠŸèƒ½**ï¼šå¯¼å‡ºé»‘åå•ä¸º CSV
5. **æ‰¹é‡åˆ é™¤ä¼˜åŒ–**ï¼šå‚è€ƒå¯¼å…¥é€»è¾‘ä¼˜åŒ–åˆ é™¤

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. é”™è¯¯æ—¥å¿—ï¼ˆ`storage/logs/laravel.log`ï¼‰
2. é˜Ÿåˆ—æ—¥å¿—ï¼ˆ`storage/logs/queue.log`ï¼‰
3. æ•°æ®é‡å’Œå¯¼å…¥æ—¶é—´
4. `task_id` å’Œè¿›åº¦ä¿¡æ¯

---

## æ€»ç»“

é€šè¿‡**é˜Ÿåˆ— + åˆ†æ‰¹å¤„ç† + æ‰¹é‡æ“ä½œ**ï¼ŒæˆåŠŸè§£å†³äº†ï¼š
- âœ… å†…å­˜æº¢å‡ºé—®é¢˜
- âœ… è¯·æ±‚è¶…æ—¶é—®é¢˜
- âœ… æ€§èƒ½é—®é¢˜ï¼ˆæå‡ 100 å€+ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒé—®é¢˜ï¼ˆå¼‚æ­¥ + è¿›åº¦è·Ÿè¸ªï¼‰

ç°åœ¨å¯ä»¥è½»æ¾å¤„ç† **ç™¾ä¸‡çº§** é»‘åå•å¯¼å…¥ï¼ğŸ‰

