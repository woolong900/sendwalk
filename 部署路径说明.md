# éƒ¨ç½²è·¯å¾„å’ŒåŸŸåé…ç½®

## ğŸ“‚ é¡¹ç›®éƒ¨ç½²è·¯å¾„

æœ¬é¡¹ç›®å°†éƒ¨ç½²åˆ°ï¼š**`/data/www/sendwalk`**

## ğŸŒ ä½¿ç”¨çš„åŸŸå

- **å‰ç«¯**: `edm.sendwalk.com`
- **API**: `api.edm.sendwalk.com`

æ‰€æœ‰é…ç½®æ–‡ä»¶å’Œè„šæœ¬å·²ç»æ›´æ–°ä¸ºä½¿ç”¨æ­¤è·¯å¾„å’ŒåŸŸåã€‚

## ğŸ“‹ å·²æ›´æ–°çš„æ–‡ä»¶

### **Nginx é…ç½®**

âœ… `nginx/api.conf`
```nginx
root /data/www/sendwalk/backend/public;
```

âœ… `nginx/frontend.conf`
```nginx
root /data/www/sendwalk/frontend/dist;
```

### **Supervisor é…ç½®**

âœ… `supervisor/scheduler.conf`
```ini
command=/usr/bin/php /data/www/sendwalk/backend/artisan schedule:work
stdout_logfile=/data/www/sendwalk/backend/storage/logs/scheduler.log
```

âœ… `supervisor/worker.conf`
```ini
command=/usr/bin/php /data/www/sendwalk/backend/artisan queue:manage-workers ...
stdout_logfile=/data/www/sendwalk/backend/storage/logs/manager.log
```

### **è‡ªåŠ¨åŒ–è„šæœ¬**

âœ… `deploy.sh`
```bash
PROJECT_DIR="/data/www/sendwalk"
```

âœ… `check-deployment.sh`
```bash
PROJECT_DIR="/data/www/sendwalk"
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 0. é…ç½® DNSï¼ˆåœ¨åŸŸåæœåŠ¡å•†æ“ä½œï¼‰

åœ¨åŸŸåæœåŠ¡å•†ï¼ˆå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼‰æ·»åŠ ä»¥ä¸‹ A è®°å½•ï¼š

```
ç±»å‹   ä¸»æœºè®°å½•    è®°å½•å€¼
A      edm        æœåŠ¡å™¨IP
A      api.edm    æœåŠ¡å™¨IP
```

éªŒè¯ DNS ç”Ÿæ•ˆï¼š

```bash
ping edm.sendwalk.com
ping api.edm.sendwalk.com
```

> ğŸ’¡ **æç¤º**: DNS ç”Ÿæ•ˆé€šå¸¸éœ€è¦ 5-10 åˆ†é’Ÿï¼Œæœ€é•¿å¯èƒ½éœ€è¦ 24 å°æ—¶

### 1. åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
# åˆ›å»ºç›®å½•
sudo mkdir -p /data/www

# è®¾ç½®æƒé™
sudo chown -R www-data:www-data /data/www
```

### 2. å…‹éš†ä»£ç 

```bash
# åˆ‡æ¢åˆ°ç›®æ ‡ç›®å½•
cd /data/www

# å…‹éš†ä»£ç 
git clone https://github.com/your-username/sendwalk.git

# è®¾ç½®æƒé™
sudo chown -R www-data:www-data /data/www/sendwalk
```

### 3. é…ç½®åç«¯

```bash
cd /data/www/sendwalk/backend

# å®‰è£…ä¾èµ–
composer install --optimize-autoloader --no-dev

# é…ç½®ç¯å¢ƒ
cp .env.example .env
nano .env  # ç¼–è¾‘é…ç½®

# ç”Ÿæˆå¯†é’¥å’Œè¿ç§»
php artisan key:generate
php artisan migrate --force

# ä¼˜åŒ–
php artisan config:cache
php artisan route:cache
php artisan view:cache

# è®¾ç½®æƒé™
sudo chown -R www-data:www-data storage bootstrap/cache
sudo chmod -R 775 storage bootstrap/cache
```

### 4. é…ç½®å‰ç«¯

```bash
cd /data/www/sendwalk/frontend

# å®‰è£…ä¾èµ–
npm install

# é…ç½®ç¯å¢ƒå˜é‡
cat > .env << 'EOF'
VITE_API_URL=https://api.edm.sendwalk.com
VITE_APP_NAME=SendWalk
EOF

# æ„å»º
npm run build
```

### 5. é…ç½® Nginx

```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶åˆ° conf.d ç›®å½•
sudo cp /data/www/sendwalk/nginx/api.conf /etc/nginx/conf.d/sendwalk-api.conf
sudo cp /data/www/sendwalk/nginx/frontend.conf /etc/nginx/conf.d/sendwalk-frontend.conf

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

### 6. é…ç½® Supervisor

```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶
sudo cp /data/www/sendwalk/supervisor/scheduler.conf /etc/supervisor/conf.d/sendwalk-scheduler.conf
sudo cp /data/www/sendwalk/supervisor/worker.conf /etc/supervisor/conf.d/sendwalk-worker-manager.conf

# é‡æ–°åŠ è½½é…ç½®
sudo supervisorctl reread
sudo supervisorctl update

# å¯åŠ¨æ‰€æœ‰è¿›ç¨‹
sudo supervisorctl start all

# æ£€æŸ¥çŠ¶æ€
sudo supervisorctl status
```

### 7. é…ç½® SSL

#### ä½¿ç”¨å·²æœ‰çš„ Cloudflare è¯ä¹¦

```bash
# è¯ä¹¦æ–‡ä»¶å·²å‡†å¤‡åœ¨ï¼š
# /data/www/ca/sendwalk.pem   (è¯ä¹¦)
# /data/www/ca/sendwalk.key   (ç§é’¥)

# ç¡®è®¤è¯ä¹¦æ–‡ä»¶å­˜åœ¨
ls -lh /data/www/ca/sendwalk.pem
ls -lh /data/www/ca/sendwalk.key

# è®¾ç½®æ­£ç¡®çš„æƒé™
sudo chown root:root /data/www/ca/sendwalk.pem
sudo chown root:root /data/www/ca/sendwalk.key
sudo chmod 644 /data/www/ca/sendwalk.pem
sudo chmod 600 /data/www/ca/sendwalk.key

# Nginx é…ç½®å·²åŒ…å« SSL è®¾ç½®ï¼Œç›´æ¥é‡å¯å³å¯
sudo nginx -t
sudo systemctl restart nginx
```

> ğŸ’¡ è¯¦ç»†çš„ SSL é…ç½®è¯´æ˜è¯·æŸ¥çœ‹ï¼š[SSLè¯ä¹¦é…ç½®è¯´æ˜.md](./SSLè¯ä¹¦é…ç½®è¯´æ˜.md)

### 8. éªŒè¯éƒ¨ç½²

```bash
cd /data/www/sendwalk
./check-deployment.sh
```

## ğŸ“ ç›®å½•ç»“æ„

```
/data/www/sendwalk/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ public/          # Nginx root for API
â”‚   â”œâ”€â”€ storage/
â”‚   â”‚   â””â”€â”€ logs/
â”‚   â”‚       â”œâ”€â”€ laravel-YYYY-MM-DD.log
â”‚   â”‚       â”œâ”€â”€ scheduler.log
â”‚   â”‚       â””â”€â”€ manager.log
â”‚   â”œâ”€â”€ .env
â”‚   â””â”€â”€ artisan
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ dist/            # Nginx root for frontend
â”‚   â”‚   â”œâ”€â”€ index.html
â”‚   â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â””â”€â”€ favicon.svg
â”‚   â”œâ”€â”€ src/
â”‚   â””â”€â”€ .env
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ api.conf
â”‚   â””â”€â”€ frontend.conf
â”œâ”€â”€ supervisor/
â”‚   â”œâ”€â”€ scheduler.conf
â”‚   â””â”€â”€ worker.conf
â”œâ”€â”€ deploy.sh
â”œâ”€â”€ check-deployment.sh
â””â”€â”€ README-DEPLOYMENT.md
```

## ğŸ” é‡è¦è·¯å¾„

### **åº”ç”¨è·¯å¾„**

| é¡¹ç›® | è·¯å¾„ |
|------|------|
| é¡¹ç›®æ ¹ç›®å½• | `/data/www/sendwalk` |
| åç«¯ä»£ç  | `/data/www/sendwalk/backend` |
| åç«¯å…¥å£ | `/data/www/sendwalk/backend/public` |
| å‰ç«¯ä»£ç  | `/data/www/sendwalk/frontend` |
| å‰ç«¯æ„å»º | `/data/www/sendwalk/frontend/dist` |

### **æ—¥å¿—è·¯å¾„**

| æ—¥å¿— | è·¯å¾„ |
|------|------|
| Laravel | `/data/www/sendwalk/backend/storage/logs/laravel-*.log` |
| Scheduler | `/data/www/sendwalk/backend/storage/logs/scheduler.log` |
| Worker | `/data/www/sendwalk/backend/storage/logs/manager.log` |
| Nginx API | `/var/log/nginx/sendwalk-api-*.log` |
| Nginx Frontend | `/var/log/nginx/sendwalk-frontend-*.log` |

### **é…ç½®è·¯å¾„**

| é…ç½® | è·¯å¾„ |
|------|------|
| åç«¯ç¯å¢ƒå˜é‡ | `/data/www/sendwalk/backend/.env` |
| å‰ç«¯ç¯å¢ƒå˜é‡ | `/data/www/sendwalk/frontend/.env` |
| Nginx API | `/etc/nginx/conf.d/sendwalk-api.conf` |
| Nginx Frontend | `/etc/nginx/conf.d/sendwalk-frontend.conf` |
| Supervisor Scheduler | `/etc/supervisor/conf.d/sendwalk-scheduler.conf` |
| Supervisor Worker | `/etc/supervisor/conf.d/sendwalk-worker-manager.conf` |

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### **è¿›å…¥é¡¹ç›®ç›®å½•**

```bash
cd /data/www/sendwalk
```

### **æ›´æ–°ä»£ç **

```bash
cd /data/www/sendwalk
./deploy.sh production
```

### **æ£€æŸ¥çŠ¶æ€**

```bash
cd /data/www/sendwalk
./check-deployment.sh
```

### **æŸ¥çœ‹æ—¥å¿—**

```bash
# Laravel æ—¥å¿—
tail -f /data/www/sendwalk/backend/storage/logs/laravel-$(date +%Y-%m-%d).log

# Scheduler æ—¥å¿—
tail -f /data/www/sendwalk/backend/storage/logs/scheduler.log

# Worker æ—¥å¿—
tail -f /data/www/sendwalk/backend/storage/logs/manager.log
```

### **é‡å¯æœåŠ¡**

```bash
# é‡å¯ PHP-FPM
sudo systemctl restart php8.3-fpm

# é‡å¯ Nginx
sudo systemctl restart nginx

# é‡å¯ Supervisor è¿›ç¨‹
sudo supervisorctl restart all
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### **æƒé™è®¾ç½®**

ç¡®ä¿ä»¥ä¸‹ç›®å½•æƒé™æ­£ç¡®ï¼š

```bash
# è®¾ç½®æ‰€æœ‰è€…
sudo chown -R www-data:www-data /data/www/sendwalk

# è®¾ç½®å­˜å‚¨ç›®å½•æƒé™
sudo chmod -R 775 /data/www/sendwalk/backend/storage
sudo chmod -R 775 /data/www/sendwalk/backend/bootstrap/cache
```

### **SELinuxï¼ˆå¦‚æœå¯ç”¨ï¼‰**

å¦‚æœæœåŠ¡å™¨å¯ç”¨äº† SELinuxï¼Œéœ€è¦è®¾ç½®æ­£ç¡®çš„ä¸Šä¸‹æ–‡ï¼š

```bash
# è®¾ç½® SELinux ä¸Šä¸‹æ–‡
sudo semanage fcontext -a -t httpd_sys_rw_content_t "/data/www/sendwalk/backend/storage(/.*)?"
sudo restorecon -Rv /data/www/sendwalk/backend/storage
```

### **é˜²ç«å¢™**

ç¡®ä¿é˜²ç«å¢™å…è®¸ HTTP/HTTPS è®¿é—®ï¼š

```bash
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

## âœ… å¿«é€Ÿæ£€æŸ¥æ¸…å•

éƒ¨ç½²å®Œæˆåï¼Œç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] é¡¹ç›®ä»£ç åœ¨ `/data/www/sendwalk`
- [ ] åç«¯ä¾èµ–å·²å®‰è£…
- [ ] æ•°æ®åº“å·²è¿ç§»
- [ ] å‰ç«¯å·²æ„å»º
- [ ] Nginx é…ç½®æ­£ç¡®ï¼ˆæŒ‡å‘ `/data/www/sendwalk`ï¼‰
- [ ] Supervisor é…ç½®æ­£ç¡®ï¼ˆæŒ‡å‘ `/data/www/sendwalk`ï¼‰
- [ ] æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] æ–‡ä»¶æƒé™æ­£ç¡®ï¼ˆwww-data:www-dataï¼‰
- [ ] SSL è¯ä¹¦é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] å¯ä»¥è®¿é—®å‰ç«¯å’Œ API
- [ ] Worker æ­£å¸¸å¤„ç†ä»»åŠ¡
- [ ] æ—¥å¿—æ­£å¸¸è®°å½•

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **åŸŸåé…ç½®è¯¦ç»†æŒ‡å—**: [åŸŸåé…ç½®è¯´æ˜.md](./åŸŸåé…ç½®è¯´æ˜.md) - **æ¨èé¦–å…ˆé˜…è¯»**
- **å¿«é€Ÿéƒ¨ç½²å‘½ä»¤**: [å¿«é€Ÿéƒ¨ç½²å‘½ä»¤.sh](./å¿«é€Ÿéƒ¨ç½²å‘½ä»¤.sh) - æ‰€æœ‰å‘½ä»¤é€ŸæŸ¥
- **å®Œæ•´éƒ¨ç½²æŒ‡å—**: [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—.md](./ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—.md)
- **æ–‡æ¡£ç´¢å¼•**: [README-DEPLOYMENT.md](./README-DEPLOYMENT.md)

---

**æ‰€æœ‰é…ç½®æ–‡ä»¶å’Œè„šæœ¬å·²æ›´æ–°ä¸ºä½¿ç”¨ `/data/www/sendwalk` è·¯å¾„å’Œ `edm.sendwalk.com` åŸŸåï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼** âœ…

