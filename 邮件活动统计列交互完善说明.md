# 邮件活动统计列交互完善说明

## ✅ 已完成的功能

1. **调整列顺序**：将"送达率"移到"打开率"前面
2. **添加可点击交互**：送达率、取消订阅率、投诉率、弹回率都可点击查看详情
3. **新增详情对话框**：送达记录、弹回记录、取消订阅记录

---

## 📊 最终列顺序（共13列）

| # | 列名 | 是否可点击 | 对话框 | 说明 |
|---|------|-----------|--------|------|
| 1 | ID | ❌ | - | 活动ID |
| 2 | 标题 | ❌ | - | 活动标题 |
| 3 | 状态 | ❌ | - | 活动状态 |
| 4 | 列表 | ❌ | - | 目标列表 |
| 5 | 发送进度 | ✅ | 发送日志 | 发送进度条 |
| 6 | **送达率** 👈 | ✅ | **发送日志**（同发送进度） | 邮件成功送达的比例 |
| 7 | 打开率 | ✅ | 打开记录 | 打开率 |
| 8 | 点击率 | ❌ | - | 点击率 |
| 9 | **取消订阅率** 👈 | ✅ | **取消订阅记录** 🆕 | 收件人退订的比例 |
| 10 | 投诉率 | ✅ | 投诉报告 | 投诉率 |
| 11 | **弹回率** 👈 | ✅ | **弹回记录** 🆕 | 邮件无法送达的比例 |
| 12 | 时间 | ❌ | - | 计划时间 |
| 13 | 操作 | ❌ | - | 操作按钮 |

---

## 🎯 交互功能总览

### 可点击查看详情的列（6个）
1. ✅ **发送进度** → 发送日志对话框
2. ✅ **送达率** → 发送日志对话框（与发送进度相同）
3. ✅ **打开率** → 打开记录对话框
4. ✅ **取消订阅率** → 取消订阅记录对话框 🆕
5. ✅ **投诉率** → 投诉报告对话框
6. ✅ **弹回率** → 弹回记录对话框 🆕

### 纯展示的列（2个）
- **点击率** - 仅显示数据
- **时间** - 仅显示时间

---

## 🔧 技术实现

### 后端修改

#### 1. **CampaignAnalyticsController** (`backend/app/Http/Controllers/Api/CampaignAnalyticsController.php`)

新增三个API方法：

##### getDeliveries() - 获取送达记录
```php
public function getDeliveries(Request $request, $campaignId)
{
    // 查询 send_logs 表中 status = 'delivered' 的记录
    $query = SendLog::with(['subscriber', 'smtpServer'])
        ->where('campaign_id', $campaignId)
        ->where('status', 'delivered')
        ->orderBy('completed_at', 'desc');
    
    // 支持搜索和分页
    return response()->json($deliveries);
}
```

##### getBounces() - 获取弹回记录
```php
public function getBounces(Request $request, $campaignId)
{
    // 查询 bounce_logs 表
    $query = BounceLog::with('subscriber')
        ->where('campaign_id', $campaignId)
        ->orderBy('created_at', 'desc');
    
    // 支持搜索和分页
    return response()->json($bounces);
}
```

##### getUnsubscribes() - 获取取消订阅记录
```php
public function getUnsubscribes(Request $request, $campaignId)
{
    // 查询 list_subscriber 表中 status = 'unsubscribed' 的记录
    $query = ListSubscriber::with(['subscriber', 'list'])
        ->whereIn('list_id', $listIds)
        ->where('status', 'unsubscribed')
        ->whereNotNull('unsubscribed_at')
        ->orderBy('unsubscribed_at', 'desc');
    
    // 格式化数据并返回
    return response()->json($unsubscribes);
}
```

#### 2. **API 路由** (`backend/routes/api.php`)

新增三个路由：
```php
Route::get('campaigns/{campaign}/deliveries', [CampaignAnalyticsController::class, 'getDeliveries']);
Route::get('campaigns/{campaign}/bounces', [CampaignAnalyticsController::class, 'getBounces']);
Route::get('campaigns/{campaign}/unsubscribes', [CampaignAnalyticsController::class, 'getUnsubscribes']);
```

---

### 前端修改

#### 1. **新建对话框组件文件** (`frontend/src/pages/campaigns/stats-dialogs.tsx`)

包含两个新对话框组件：
- `BouncesDialog` - 弹回记录对话框
- `UnsubscribesDialog` - 取消订阅记录对话框

注：`DeliveriesDialog`（送达记录）组件代码已实现，但未使用，因为送达率直接复用发送日志对话框。

每个对话框都包含：
- 🔍 搜索功能
- 📄 分页功能（首页/上一页/下一页/尾页）
- 📊 详细数据展示
- 🎨 独特的图标和颜色主题

#### 2. **修改主页面** (`frontend/src/pages/campaigns/index.tsx`)

##### 导入新组件
```typescript
import { BouncesDialog, UnsubscribesDialog } from './stats-dialogs'
```

##### 添加状态管理
```typescript
const [bouncesDialog, setBouncesDialog] = useState<{...}>({...})
const [unsubscribesDialog, setUnsubscribesDialog] = useState<{...}>({...})
```

##### 调整列顺序
- 将送达率移到打开率前面
- 保持其他列的相对顺序

##### 将统计列改为可点击按钮

送达率复用发送日志对话框：
```typescript
<button
  onClick={() => setSendLogsDialog({ 
    open: true, 
    campaignId: campaign.id, 
    campaignName: campaign.name 
  })}
  className="flex flex-col items-center gap-1 w-full hover:opacity-70 transition-opacity cursor-pointer"
  disabled={campaign.total_sent === 0}
>
  <span className="font-medium">{campaign.delivery_rate?.toFixed(1) || 0}%</span>
  <span className="text-xs text-muted-foreground">
    {campaign.total_delivered || 0} / {campaign.total_sent || 0}
  </span>
</button>
```

##### 添加对话框组件
```typescript
<BouncesDialog {...bouncesDialog} onClose={...} />
<UnsubscribesDialog {...unsubscribesDialog} onClose={...} />
```

注：送达率复用 `SendLogsDialog`，无需单独添加。

---

## 📋 对话框详情

### 1. 发送日志对话框 (SendLogsDialog)

**用途**: 由"发送进度"和"送达率"两列共同使用

**图标**: 📄 FileText  
**标题**: 发送日志 - {活动名称}

**显示字段**:
| 列名 | 说明 |
|------|------|
| 邮箱地址 | 收件人邮箱 |
| 状态 | 发送状态（已发送/已送达/失败等） |
| SMTP 服务器 | 使用的SMTP服务器名称 |
| 发送时间 | 邮件发送/送达的时间 |
| 错误信息 | 如果失败，显示错误原因 |

**数据来源**: `send_logs` 表（所有记录）

**筛选功能**: 
- 可以按状态筛选（全部/已送达/失败等）
- 可以搜索邮箱地址

---

### 2. 弹回记录对话框 (BouncesDialog)

**图标**: ❌ XCircle (橙色)  
**标题**: 弹回记录 - {活动名称}

**显示字段**:
| 列名 | 说明 |
|------|------|
| 邮箱地址 | 弹回的邮箱地址 |
| 弹回类型 | 硬弹回/软弹回（带颜色标签） |
| 错误代码 | SMTP错误代码 |
| 错误信息 | 详细的错误描述 |
| 弹回时间 | 弹回发生的时间 |

**弹回类型标签**:
- 🔴 **硬弹回** (Hard Bounce) - 红色标签
- 🟡 **软弹回** (Soft Bounce) - 黄色标签

**数据来源**: `bounce_logs` 表

---

### 3. 取消订阅记录对话框 (UnsubscribesDialog)

**图标**: 👤 UserX (蓝色)  
**标题**: 取消订阅记录 - {活动名称}

**显示字段**:
| 列名 | 说明 |
|------|------|
| 邮箱地址 | 取消订阅的邮箱地址 |
| 所属列表 | 取消订阅的邮件列表名称 |
| 取消订阅时间 | 退订的时间 |

**数据来源**: `list_subscriber` 表（`status = 'unsubscribed'`）

---

## 🎨 UI/UX 特点

### 1. **一致的交互体验**
- 所有可点击的统计列使用相同的按钮样式
- 鼠标悬停时透明度变化（`hover:opacity-70`）
- 数据为0时按钮禁用

### 2. **清晰的视觉反馈**
- 每个对话框有独特的图标和颜色主题
  - 送达：✅ 绿色
  - 弹回：❌ 橙色
  - 取消订阅：👤 蓝色
  - 投诉：⚠️ 红色

### 3. **完整的功能**
- 🔍 搜索邮箱地址
- 📄 分页浏览（首页/上一页/下一页/尾页）
- 📊 显示总数和当前范围
- 💾 数据懒加载（只在打开对话框时加载）

### 4. **响应式设计**
- 表格设置最小宽度，小屏幕可水平滚动
- 使用 `whitespace-nowrap` 防止文本换行
- 使用 `truncate` 处理超长文本

---

## 🚀 部署步骤

### 1. 拉取最新代码
```bash
cd /data/www/sendwalk
git pull
```

### 2. 后端无需额外操作
- 新的API路由会自动生效
- 无需运行迁移

### 3. 重新构建前端
```bash
cd frontend
npm install
npm run build
cd ..
```

### 4. 清理缓存
```bash
# 清理浏览器缓存
# Ctrl+F5 (Windows/Linux) 或 Cmd+Shift+R (Mac)

# 如果使用 Cloudflare，在控制台清除缓存
```

---

## 📈 使用场景

### 发送日志（发送进度 & 送达率）
**适用于**:
- 查看所有邮件的发送状态
- 验证邮件是否成功送达
- 查看使用了哪些SMTP服务器
- 检查发送失败的原因
- 分析送达时间分布
- 筛选特定状态的邮件（已送达/失败等）

**为什么送达率和发送进度共用同一个对话框？**
- 送达的邮件是发送日志的子集（`status = 'delivered'`）
- 在发送日志中可以通过状态筛选查看送达的邮件
- 避免重复的UI，提供统一的发送数据查看入口

### 弹回记录
**适用于**:
- 识别无效的邮箱地址
- 区分硬弹回和软弹回
- 分析弹回原因
- 清理邮件列表

**硬弹回 vs 软弹回**:
- **硬弹回**: 永久性错误（邮箱不存在、域名无效）→ 应从列表中移除
- **软弹回**: 临时性错误（邮箱已满、服务器故障）→ 可以稍后重试

### 取消订阅记录
**适用于**:
- 了解用户退订原因
- 分析退订趋势
- 遵守反垃圾邮件法规
- 优化邮件内容和频率

---

## 💡 最佳实践

### 1. 定期检查弹回记录
- 每周检查一次弹回记录
- 将硬弹回的邮箱加入黑名单
- 对软弹回的邮箱进行二次尝试

### 2. 分析取消订阅趋势
- 如果取消订阅率突然上升，检查最近的邮件内容
- 对比不同活动的取消订阅率
- 优化邮件频率和内容

### 3. 监控送达率
- 送达率应保持在 95% 以上
- 如果送达率下降，检查SMTP服务器状态
- 考虑使用多个SMTP服务器分散风险

### 4. 关注投诉率
- 投诉率应低于 0.1%
- 投诉率高说明邮件内容或发送策略有问题
- 及时调整以避免被标记为垃圾邮件发送者

---

## 📊 数据指标参考

| 指标 | 优秀 | 良好 | 需改进 |
|------|------|------|--------|
| **送达率** | ≥ 98% | 95-98% | < 95% |
| **打开率** | ≥ 20% | 15-20% | < 15% |
| **点击率** | ≥ 3% | 2-3% | < 2% |
| **弹回率** | ≤ 1% | 1-2% | > 2% |
| **取消订阅率** | ≤ 0.2% | 0.2-0.5% | > 0.5% |
| **投诉率** | ≤ 0.1% | 0.1-0.3% | > 0.3% |

---

## 🔍 故障排查

### 对话框无法打开
1. 检查浏览器控制台是否有错误
2. 确认后端API是否正常响应
3. 检查网络请求是否成功

### 数据显示不正确
1. 检查后端日志：`backend/storage/logs/laravel.log`
2. 确认数据库中是否有相关记录
3. 检查API返回的数据格式

### 搜索功能不工作
1. 确认输入的搜索词是否正确
2. 检查后端是否正确处理搜索参数
3. 查看网络请求中的 `search` 参数

---

## 📚 相关文件

### 后端
- `backend/app/Http/Controllers/Api/CampaignAnalyticsController.php` - 控制器
- `backend/routes/api.php` - API路由
- `backend/app/Models/SendLog.php` - 发送日志模型
- `backend/app/Models/BounceLog.php` - 弹回日志模型
- `backend/app/Models/ListSubscriber.php` - 列表订阅者模型

### 前端
- `frontend/src/pages/campaigns/index.tsx` - 主页面
- `frontend/src/pages/campaigns/stats-dialogs.tsx` - 新对话框组件
- `frontend/src/pages/campaigns/analytics-dialogs.tsx` - 原有对话框组件

### 文档
- `邮件活动统计列完善说明.md` - 之前的统计列说明
- `列顺序调整说明.md` - 列顺序调整说明
- `邮件活动投诉率功能说明.md` - 投诉率功能说明

---

**更新日期**: 2025-12-26  
**版本**: v3.0  
**新增内容**: 送达率、弹回率、取消订阅率可点击查看详情，调整列顺序

