# é‚®ä»¶åˆ—è¡¨è®¡æ•°æ˜¾ç¤ºé”™è¯¯ - ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

**ç—‡çŠ¶**:
- åˆ›å»ºæ–°é‚®ä»¶åˆ—è¡¨å¹¶å¯¼å…¥è”ç³»äººå
- åˆ—è¡¨é¡µé¢æ˜¾ç¤ºè®¢é˜…è€…æ•°é‡ä¸º **0**
- ä½†ç‚¹è¿›è¯¦æƒ…é¡µæŸ¥çœ‹ï¼Œæ•°é‡æ˜¯**æ­£ç¡®çš„**

## ğŸ” é—®é¢˜åŸå› 

æ‰¹é‡å¯¼å…¥è”ç³»äººæ—¶ä½¿ç”¨çš„ `attach()` å’Œ `updateExistingPivot()` æ–¹æ³•ä¸ä¼šè§¦å‘ `ListSubscriberObserver`ï¼Œå¯¼è‡´åˆ—è¡¨çš„ `subscribers_count` å­—æ®µæ²¡æœ‰è¢«æ›´æ–°ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: è¿è¡Œä¿®å¤è„šæœ¬ï¼ˆæ¨èï¼‰â­ï¸

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd /data/www/sendwalk
git pull
./fix-list-counts.sh
```

**è¯´æ˜**: è¿™ä¸ªè„šæœ¬ä¼šé‡æ–°è®¡ç®—æ‰€æœ‰é‚®ä»¶åˆ—è¡¨çš„è®¢é˜…è€…æ•°é‡ã€‚

### æ–¹æ¡ˆ2: æ‰‹åŠ¨è¿è¡Œ Artisan å‘½ä»¤

```bash
cd /data/www/sendwalk/backend
php artisan lists:recalculate-counts
```

**é¢„æœŸè¾“å‡º**:
```
å¼€å§‹é‡æ–°è®¡ç®—é‚®ä»¶åˆ—è¡¨è®¢é˜…è€…è®¡æ•°...
 5/5 [â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%
è®¡æ•°é‡æ–°è®¡ç®—å®Œæˆï¼
å¤„ç†äº† 5 ä¸ªåˆ—è¡¨
```

### æ–¹æ¡ˆ3: é€šè¿‡ SQL ç›´æ¥æ›´æ–°

å¦‚æœå‘½ä»¤æ— æ³•è¿è¡Œï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œ SQLï¼š

```sql
-- æ›´æ–°æ‰€æœ‰åˆ—è¡¨çš„è®¢é˜…è€…è®¡æ•°
UPDATE lists l
SET 
    subscribers_count = (
        SELECT COUNT(*) 
        FROM list_subscriber ls 
        WHERE ls.list_id = l.id 
        AND ls.status = 'active'
    ),
    unsubscribed_count = (
        SELECT COUNT(*) 
        FROM list_subscriber ls 
        WHERE ls.list_id = l.id 
        AND ls.status = 'unsubscribed'
    );
```

æ‰§è¡Œæ–¹æ³•:
```bash
mysql -u root -p sendwalk < update_list_counts.sql
```

æˆ–ç›´æ¥åœ¨ MySQL å‘½ä»¤è¡Œä¸­æ‰§è¡Œï¼š
```bash
mysql -u root -p sendwalk
```

ç„¶åç²˜è´´ä¸Šé¢çš„ SQL è¯­å¥ã€‚

---

## ğŸ”§ å·²ä¿®å¤çš„é—®é¢˜

### 1. ImportSubscribers Job ä¼˜åŒ–

**æ–‡ä»¶**: `backend/app/Jobs/ImportSubscribers.php`

**ä¿®æ”¹**:
- åœ¨å¯¼å…¥å®Œæˆåè‡ªåŠ¨é‡æ–°è®¡ç®—åˆ—è¡¨çš„è®¢é˜…è€…æ•°é‡
- æ·»åŠ äº† `recalculateListCounts()` æ–¹æ³•

**ä»£ç **:
```php
// é‡æ–°è®¡ç®—åˆ—è¡¨çš„è®¢é˜…è€…æ•°é‡ï¼ˆå› ä¸ºæ‰¹é‡å¯¼å…¥ä¸ä¼šè§¦å‘ Observerï¼‰
$this->recalculateListCounts($this->listId);
```

### 2. æ–°çš„é‡æ–°è®¡ç®—æ–¹æ³•

```php
private function recalculateListCounts(int $listId): void
{
    $list = MailingList::find($listId);
    if (!$list) {
        return;
    }

    // è®¡ç®—æ´»è·ƒè®¢é˜…è€…æ•°é‡
    $subscribersCount = \DB::table('list_subscriber')
        ->where('list_id', $listId)
        ->where('status', 'active')
        ->count();

    // è®¡ç®—å–æ¶ˆè®¢é˜…è€…æ•°é‡
    $unsubscribedCount = \DB::table('list_subscriber')
        ->where('list_id', $listId)
        ->where('status', 'unsubscribed')
        ->count();

    // æ›´æ–°åˆ—è¡¨è®¡æ•°
    $list->timestamps = false;
    $list->subscribers_count = $subscribersCount;
    $list->unsubscribed_count = $unsubscribedCount;
    $list->save();
    $list->timestamps = true;
}
```

---

## ğŸ“‹ éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥åˆ—è¡¨è®¡æ•°

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd /data/www/sendwalk/backend
php artisan tinker
```

ç„¶åæ‰§è¡Œï¼š
```php
// æŸ¥çœ‹æ‰€æœ‰åˆ—è¡¨çš„è®¡æ•°
DB::table('lists')
    ->select('id', 'name', 'subscribers_count', 'unsubscribed_count')
    ->get();

// éªŒè¯ç‰¹å®šåˆ—è¡¨
$listId = 1; // æ›¿æ¢ä¸ºæ‚¨çš„åˆ—è¡¨ID
$list = DB::table('lists')->find($listId);
$actualCount = DB::table('list_subscriber')
    ->where('list_id', $listId)
    ->where('status', 'active')
    ->count();

echo "åˆ—è¡¨æ˜¾ç¤ºæ•°é‡: {$list->subscribers_count}\n";
echo "å®é™…è®¢é˜…è€…æ•°é‡: {$actualCount}\n";
```

### 2. åœ¨æµè§ˆå™¨ä¸­éªŒè¯

1. æ‰“å¼€é‚®ä»¶åˆ—è¡¨é¡µé¢
2. åˆ·æ–°é¡µé¢ï¼ˆCtrl+F5 æˆ– Cmd+Shift+Rï¼‰
3. æ£€æŸ¥è®¢é˜…è€…æ•°é‡æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

---

## ğŸ”„ æœªæ¥å¯¼å…¥ä¸ä¼šå†å‡ºç°æ­¤é—®é¢˜

**åŸå› **: å·²ç»åœ¨ `ImportSubscribers` Job ä¸­æ·»åŠ äº†è‡ªåŠ¨é‡æ–°è®¡ç®—é€»è¾‘ã€‚

**æ•ˆæœ**: 
- âœ… æ¯æ¬¡å¯¼å…¥å®Œæˆåä¼šè‡ªåŠ¨æ›´æ–°åˆ—è¡¨è®¡æ•°
- âœ… æ— éœ€æ‰‹åŠ¨è¿è¡Œä¿®å¤å‘½ä»¤
- âœ… åˆ—è¡¨é¡µé¢ä¼šç«‹å³æ˜¾ç¤ºæ­£ç¡®çš„æ•°é‡

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### é—®é¢˜1: ä¿®å¤åæ•°é‡ä»ç„¶ä¸º 0

**å¯èƒ½åŸå› **:
- å®é™…æ²¡æœ‰æ´»è·ƒè®¢é˜…è€…
- è®¢é˜…è€…çŠ¶æ€ä¸æ˜¯ 'active'

**æ£€æŸ¥æ–¹æ³•**:
```bash
php artisan tinker
```

```php
$listId = 1; // æ›¿æ¢ä¸ºæ‚¨çš„åˆ—è¡¨ID

// æ£€æŸ¥ pivot è¡¨ä¸­çš„è®°å½•
DB::table('list_subscriber')
    ->where('list_id', $listId)
    ->get(['subscriber_id', 'status', 'subscribed_at']);

// æ£€æŸ¥çŠ¶æ€åˆ†å¸ƒ
DB::table('list_subscriber')
    ->where('list_id', $listId)
    ->groupBy('status')
    ->select('status', DB::raw('COUNT(*) as count'))
    ->get();
```

### é—®é¢˜2: å‘½ä»¤æ‰§è¡Œå¤±è´¥

**æ£€æŸ¥æ—¥å¿—**:
```bash
tail -f backend/storage/logs/laravel.log
```

**å¸¸è§é”™è¯¯**:
- æ•°æ®åº“è¿æ¥å¤±è´¥
- æƒé™é—®é¢˜
- åˆ—è¡¨ä¸å­˜åœ¨

### é—®é¢˜3: æµè§ˆå™¨ä»æ˜¾ç¤ºæ—§æ•°æ®

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ¸…ç†æµè§ˆå™¨ç¼“å­˜
Ctrl+F5 (Windows/Linux)
Cmd+Shift+R (Mac)

# æˆ–åœ¨éšç§æ¨¡å¼ä¸‹æ‰“å¼€
```

---

## ğŸ’¡ é¢„é˜²æªæ–½

### 1. å®šæœŸæ£€æŸ¥è®¡æ•°å‡†ç¡®æ€§

åˆ›å»ºå®šæœŸä»»åŠ¡ï¼ˆå¯é€‰ï¼‰:
```bash
# æ·»åŠ åˆ° crontab
0 2 * * * cd /data/www/sendwalk/backend && php artisan lists:recalculate-counts >> /var/log/list-counts-sync.log 2>&1
```

### 2. ç›‘æ§è®¡æ•°å¼‚å¸¸

åœ¨ `AppServiceProvider` ä¸­æ·»åŠ ç›‘æ§ï¼ˆå¯é€‰ï¼‰:
```php
use Illuminate\Support\Facades\DB;

public function boot()
{
    // æ¯å¤©æ£€æŸ¥ä¸€æ¬¡è®¡æ•°å‡†ç¡®æ€§
    if (now()->hour === 0) {
        $inconsistencies = DB::select("
            SELECT l.id, l.name, l.subscribers_count,
                   COUNT(CASE WHEN ls.status = 'active' THEN 1 END) as actual_count
            FROM lists l
            LEFT JOIN list_subscriber ls ON l.id = ls.list_id
            GROUP BY l.id
            HAVING l.subscribers_count != actual_count
        ");
        
        if (!empty($inconsistencies)) {
            Log::warning('å‘ç°åˆ—è¡¨è®¡æ•°ä¸ä¸€è‡´', [
                'inconsistencies' => $inconsistencies
            ]);
        }
    }
}
```

---

## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯

### æŸ¥çœ‹æ‰€æœ‰åˆ—è¡¨çš„è®¡æ•°æƒ…å†µ

```bash
php artisan tinker
```

```php
// æ˜¾ç¤ºæ‰€æœ‰åˆ—è¡¨åŠå…¶è®¡æ•°
DB::table('lists as l')
    ->leftJoin('list_subscriber as ls', 'l.id', '=', 'ls.list_id')
    ->select(
        'l.id',
        'l.name',
        'l.subscribers_count as stored_count',
        DB::raw('COUNT(CASE WHEN ls.status = "active" THEN 1 END) as actual_count')
    )
    ->groupBy('l.id', 'l.name', 'l.subscribers_count')
    ->get()
    ->map(function ($item) {
        $item->is_correct = $item->stored_count == $item->actual_count;
        return $item;
    });
```

---

## âœ… ä¿®å¤å®Œæˆæ¸…å•

ä¿®å¤åè¯·ç¡®è®¤ï¼š

- [ ] è¿è¡Œäº† `php artisan lists:recalculate-counts` å‘½ä»¤
- [ ] å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼ˆæ— é”™è¯¯è¾“å‡ºï¼‰
- [ ] åˆ·æ–°äº†æµè§ˆå™¨é¡µé¢
- [ ] åˆ—è¡¨é¡µé¢æ˜¾ç¤ºæ­£ç¡®çš„è®¢é˜…è€…æ•°é‡
- [ ] è¯¦æƒ…é¡µé¢æ•°é‡ä¸åˆ—è¡¨é¡µé¢ä¸€è‡´
- [ ] æ›´æ–°äº†ä»£ç ï¼ˆ`git pull`ï¼‰
- [ ] é‡å¯äº†é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹ï¼ˆ`supervisorctl restart laravel-worker:*`ï¼‰

---

## ğŸš€ éƒ¨ç½²æ›´æ–°

å¦‚æœéœ€è¦åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²ä¿®å¤ï¼š

```bash
cd /data/www/sendwalk

# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull

# 2. è¿è¡Œä¿®å¤è„šæœ¬
./fix-list-counts.sh

# 3. é‡å¯é˜Ÿåˆ—ï¼ˆç¡®ä¿æ–°å¯¼å…¥ä½¿ç”¨ä¿®å¤åçš„ä»£ç ï¼‰
supervisorctl restart laravel-worker:*

# æˆ–æ‰‹åŠ¨é‡å¯
cd backend
php artisan queue:restart
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. ä¿®å¤å‘½ä»¤çš„è¾“å‡º
2. Laravel æ—¥å¿—ï¼ˆ`backend/storage/logs/laravel.log`ï¼‰
3. åˆ—è¡¨ ID
4. å¯¼å…¥æ—¶é—´
5. å®é™…è®¢é˜…è€…æ•°é‡

---

**é—®é¢˜å·²ä¿®å¤ï¼æœªæ¥çš„å¯¼å…¥å°†è‡ªåŠ¨æ›´æ–°è®¡æ•°ã€‚** âœ…

