# 邮件活动统计列完善说明

## ✅ 已完成的功能

在之前添加的"投诉率"基础上，又新增了三列：**送达率、弹回率、取消订阅率**。

---

## 📊 完整的列结构

| # | 列名 | 计算公式 | 说明 |
|---|------|---------|------|
| 1 | ID | - | 活动ID |
| 2 | 标题 | - | 活动标题 |
| 3 | 状态 | - | 活动状态 |
| 4 | 列表 | - | 目标列表 |
| 5 | 发送进度 | `sent / total_recipients` | 发送进度条（可点击查看日志） |
| 6 | 打开率 | `(total_opened / total_delivered) × 100` | 打开率（可点击查看详情） |
| 7 | 点击率 | `(total_clicked / total_delivered) × 100` | 点击率 |
| 8 | **取消订阅** ⭐ | `(total_unsubscribed / total_delivered) × 100` | **新增：取消订阅的比例** |
| 9 | 投诉率 | `(total_complained / total_delivered) × 100` | 投诉率（可点击查看详情） |
| 10 | **送达率** ⭐ | `(total_delivered / total_sent) × 100` | **新增：邮件成功送达的比例** |
| 11 | **弹回率** ⭐ | `(total_bounced / total_sent) × 100` | **新增：邮件弹回的比例** |
| 12 | 时间 | - | 计划时间 |
| 13 | 操作 | - | 操作按钮 |

---

## 🔧 技术实现

### 后端修改

#### **Campaign 模型** (`backend/app/Models/Campaign.php`)

##### 1. 更新 $appends 数组
```php
protected $appends = [
    'open_rate',
    'click_rate',
    'complaint_rate',
    'delivery_rate',      // 新增
    'bounce_rate',        // 新增
    'unsubscribe_rate',   // 新增
    'list_ids',
];
```

##### 2. 添加送达率计算
```php
public function getDeliveryRateAttribute()
{
    if ($this->total_sent == 0) return 0;
    return round(($this->total_delivered / $this->total_sent) * 100, 2);
}
```

##### 3. 添加弹回率计算
```php
public function getBounceRateAttribute()
{
    if ($this->total_sent == 0) return 0;
    return round(($this->total_bounced / $this->total_sent) * 100, 2);
}
```

##### 4. 添加取消订阅率计算
```php
public function getUnsubscribeRateAttribute()
{
    if ($this->total_delivered == 0) return 0;
    return round(($this->total_unsubscribed / $this->total_delivered) * 100, 2);
}
```

---

### 前端修改

#### **Campaign 接口定义** (`frontend/src/pages/campaigns/index.tsx`)
```typescript
interface Campaign {
  // ... 其他字段
  total_bounced: number         // 新增
  total_unsubscribed: number    // 新增
  delivery_rate: number         // 新增
  bounce_rate: number           // 新增
  unsubscribe_rate: number      // 新增
}
```

#### **表格配置**
- **最小宽度**: `1290px` → `1590px`（增加了 300px，每列 100px）
- **新增 3 个 colgroup**: 每个 `w-[100px]`
- **新增 3 个 TableHead**

#### **单元格实现**

##### 送达率单元格
```tsx
<TableCell className="text-center whitespace-nowrap">
  <div className="flex flex-col items-center gap-1">
    <span className="font-medium">
      {campaign.delivery_rate?.toFixed(1) || 0}%
    </span>
    <span className="text-xs text-muted-foreground">
      {campaign.total_delivered || 0} / {campaign.total_sent || 0}
    </span>
  </div>
</TableCell>
```

##### 弹回率单元格
```tsx
<TableCell className="text-center whitespace-nowrap">
  <div className="flex flex-col items-center gap-1">
    <span className="font-medium">
      {campaign.bounce_rate?.toFixed(1) || 0}%
    </span>
    <span className="text-xs text-muted-foreground">
      {campaign.total_bounced || 0} 次
    </span>
  </div>
</TableCell>
```

##### 取消订阅率单元格
```tsx
<TableCell className="text-center whitespace-nowrap">
  <div className="flex flex-col items-center gap-1">
    <span className="font-medium">
      {campaign.unsubscribe_rate?.toFixed(1) || 0}%
    </span>
    <span className="text-xs text-muted-foreground">
      {campaign.total_unsubscribed || 0} 次
    </span>
  </div>
</TableCell>
```

---

## 📐 计算说明

### 1. 送达率 (Delivery Rate)
**公式**: `(已送达 / 已发送) × 100`

- **分子**: `total_delivered` - 成功送达的邮件数
- **分母**: `total_sent` - 实际发送的邮件数
- **含义**: 表示邮件成功送达收件箱的比例
- **理想值**: 95% 以上

**示例**:
- 发送了 1000 封邮件 (`total_sent = 1000`)
- 成功送达 980 封 (`total_delivered = 980`)
- 送达率 = `(980 / 1000) × 100 = 98.0%`

---

### 2. 弹回率 (Bounce Rate)
**公式**: `(弹回数 / 已发送) × 100`

- **分子**: `total_bounced` - 弹回的邮件数
- **分母**: `total_sent` - 实际发送的邮件数
- **含义**: 表示邮件无法送达的比例
- **理想值**: 2% 以下

**弹回类型**:
- **硬弹回 (Hard Bounce)**: 邮箱地址不存在、域名无效等永久性错误
- **软弹回 (Soft Bounce)**: 邮箱已满、服务器临时故障等暂时性错误

**示例**:
- 发送了 1000 封邮件 (`total_sent = 1000`)
- 弹回了 20 封 (`total_bounced = 20`)
- 弹回率 = `(20 / 1000) × 100 = 2.0%`

---

### 3. 取消订阅率 (Unsubscribe Rate)
**公式**: `(取消订阅数 / 已送达) × 100`

- **分子**: `total_unsubscribed` - 取消订阅的人数
- **分母**: `total_delivered` - 成功送达的邮件数
- **含义**: 表示收到邮件后选择退订的比例
- **理想值**: 0.5% 以下

**注意**: 使用 `total_delivered` 而非 `total_sent` 作为分母，因为只有成功收到邮件的人才可能取消订阅。

**示例**:
- 送达了 980 封邮件 (`total_delivered = 980`)
- 有 5 人取消订阅 (`total_unsubscribed = 5`)
- 取消订阅率 = `(5 / 980) × 100 = 0.51%`

---

## 📊 数据关系

```
total_recipients (收件人总数)
    ↓
total_sent (实际发送数)
    ↓ ↓
    ↓ └→ total_bounced (弹回数) → 弹回率
    ↓
total_delivered (成功送达数) → 送达率
    ↓ ↓ ↓ ↓ ↓
    ↓ ↓ ↓ ↓ └→ total_unsubscribed (取消订阅数) → 取消订阅率
    ↓ ↓ ↓ └→ total_complained (投诉数) → 投诉率
    ↓ ↓ └→ total_clicked (点击数) → 点击率
    ↓ └→ total_opened (打开数) → 打开率
    ↓
    └→ 未打开数
```

---

## 🚀 部署步骤

### 1. 拉取最新代码
```bash
cd /data/www/sendwalk
git pull
```

### 2. 后端无需额外操作
- 所有计算属性会自动生效
- 无需运行迁移

### 3. 重新构建前端
```bash
cd frontend
npm install
npm run build
cd ..
```

### 4. 清理缓存
```bash
# 清理浏览器缓存
# Ctrl+F5 (Windows/Linux) 或 Cmd+Shift+R (Mac)

# 如果使用 Cloudflare，在控制台清除缓存
```

---

## 🎨 UI 特点

### 1. **一致的设计**
- 所有统计列使用相同的布局
- 上方显示百分比（加粗）
- 下方显示具体数据（灰色小字）

### 2. **交互功能**
- ✅ **发送进度**: 可点击查看发送日志
- ✅ **打开率**: 可点击查看打开详情
- ✅ **投诉率**: 可点击查看投诉报告
- ⭕ **点击率**: 纯展示
- ⭕ **送达率**: 纯展示
- ⭕ **弹回率**: 纯展示
- ⭕ **取消订阅率**: 纯展示

### 3. **响应式设计**
- 表格最小宽度: `1590px`
- 小屏幕可水平滚动
- 所有列不会换行（`whitespace-nowrap`）

---

## 📈 数据指标解读

### 优秀的邮件活动指标
| 指标 | 优秀 | 良好 | 需改进 |
|------|------|------|--------|
| 送达率 | ≥ 98% | 95-98% | < 95% |
| 打开率 | ≥ 20% | 15-20% | < 15% |
| 点击率 | ≥ 3% | 2-3% | < 2% |
| 弹回率 | ≤ 1% | 1-2% | > 2% |
| 投诉率 | ≤ 0.1% | 0.1-0.3% | > 0.3% |
| 取消订阅率 | ≤ 0.2% | 0.2-0.5% | > 0.5% |

### 指标异常时的处理建议

#### 送达率低 (< 95%)
- 检查邮件列表质量
- 清理无效邮箱地址
- 检查黑名单
- 检查 SMTP 服务器配置

#### 弹回率高 (> 2%)
- 定期清理弹回邮箱
- 使用邮箱验证服务
- 移除硬弹回地址到黑名单

#### 投诉率高 (> 0.3%)
- 检查邮件内容是否合规
- 确保取消订阅链接可见
- 检查发送频率是否过高
- 确保邮件内容与订阅时承诺一致

#### 取消订阅率高 (> 0.5%)
- 优化邮件内容质量
- 降低发送频率
- 提供更精准的内容分类
- 改进邮件设计和价值

---

## 🔍 未来优化建议

### 1. 弹回详情对话框
类似投诉报告，点击弹回率可查看：
- 弹回的邮箱地址
- 弹回类型（硬弹回/软弹回）
- 弹回原因
- SMTP 错误信息

### 2. 取消订阅详情对话框
点击取消订阅率可查看：
- 取消订阅的邮箱地址
- 取消订阅时间
- 取消订阅原因（如果收集了）

### 3. 统计趋势图表
在活动详情页添加：
- 各指标的时间趋势图
- 与历史活动的对比
- 行业平均值对比

### 4. 智能预警
当指标异常时自动通知：
- 弹回率超过 3%
- 投诉率超过 0.5%
- 取消订阅率超过 1%

---

## 📞 技术支持

如有问题，请检查：
1. 浏览器控制台是否有错误
2. 后端日志：`backend/storage/logs/laravel.log`
3. 确认 `campaigns` 表中是否有相关字段数据

---

**更新日期**: 2025-12-26  
**版本**: v2.0  
**新增内容**: 送达率、弹回率、取消订阅率

