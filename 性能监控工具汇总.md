# 性能监控工具汇总

## 📋 概述

已为 SendWalk 项目添加完整的性能监控系统，可以精确追踪每个请求和步骤的耗时。

---

## 🎯 监控范围

### 1. 导入进度查询
- ✅ 订阅者导入进度
- ✅ 黑名单导入进度
- 📊 记录：请求开始、缓存查询、响应构建、总耗时

### 2. 列表页面
- ✅ 黑名单列表页面
- ✅ 订阅者列表页面
- 📊 记录：查询构建、数据库查询、后处理、响应构建、总耗时

---

## 🛠️ 诊断工具清单

### 通用工具

| 工具 | 说明 | 使用场景 |
|------|------|---------|
| `立即诊断导入性能.sh` | 导入进度查询诊断 | 导入时前端pending |
| `diagnose-import-performance.sh` | 导入性能交互式诊断 | 详细分析导入问题 |

### 黑名单专用

| 工具 | 说明 | 使用场景 |
|------|------|---------|
| `快速诊断黑名单性能.sh` ⭐ | 一键诊断黑名单页面 | 黑名单页面卡顿 |
| `diagnose-blacklist-performance.sh` | 黑名单详细诊断 | 深度分析性能问题 |

---

## 🚀 快速开始

### 场景1：导入订阅者时前端卡住

```bash
cd /data/www/sendwalk
git pull
./立即诊断导入性能.sh
```

然后在浏览器中开始导入，观察日志。

---

### 场景2：黑名单页面加载慢 ⭐

```bash
cd /data/www/sendwalk
git pull
./快速诊断黑名单性能.sh
```

然后在浏览器中打开黑名单页面，观察日志。

**特别关注**：
- 数据库查询耗时（重点）
- 翻页到后面时的性能
- 搜索功能的性能

---

### 场景3：订阅者页面加载慢

```bash
cd /data/www/sendwalk/backend
tail -f storage/logs/laravel.log | grep "\[性能-订阅者\]"
```

然后在浏览器中打开订阅者页面。

---

## 📊 日志格式说明

### 导入进度查询日志

```
[性能] 开始处理导入进度请求
  - request_id: 请求唯一ID
  - import_id: 导入任务ID
  
[性能] 缓存查询完成
  - duration_ms: 缓存查询耗时
  - progress_status: 当前状态
  
[性能] 请求处理完成
  - total_duration_ms: 总耗时
```

### 黑名单列表页面日志

```
[性能-黑名单] 开始处理列表请求
  - request_id: 请求ID
  - page: 页码
  - has_search: 是否有搜索
  
[性能-黑名单] 数据库查询完成
  - duration_ms: 数据库查询耗时 ⭐ 重点
  - total_records: 总记录数
  
[性能-黑名单] 请求处理完成
  - db_query_ms: 数据库耗时
  - total_duration_ms: 总耗时
```

### 订阅者列表页面日志

```
[性能-订阅者] 开始处理列表请求
  - list_id: 列表ID（如果有）
  - status: 状态过滤
  - search: 搜索关键词
  
[性能-订阅者] 数据库查询完成
  - duration_ms: 数据库查询耗时 ⭐ 重点
  
[性能-订阅者] 后处理完成
  - duration_ms: 后处理耗时（状态处理）
  
[性能-订阅者] 请求处理完成
  - total_duration_ms: 总耗时
```

---

## ⚠️ 告警阈值

### 导入进度查询

| 指标 | 正常 | 警告 | 危险 |
|------|------|------|------|
| 总耗时 | < 50ms | 50-1000ms | > 1000ms |
| 缓存查询 | < 10ms | 10-50ms | > 50ms |

**自动告警**：
- 总耗时 > 1秒：`[性能] 慢请求警告`
- 总耗时 > 5秒：`[性能] 极慢请求`

### 黑名单列表

| 指标 | 正常 | 警告 | 危险 |
|------|------|------|------|
| 数据库查询 | < 50ms | 50-100ms | > 100ms |
| 总耗时 | < 200ms | 200-500ms | > 500ms |

**自动告警**：
- 数据库查询 > 100ms：`[性能-黑名单] 数据库查询慢`
- 总耗时 > 500ms：`[性能-黑名单] 请求处理慢`

### 订阅者列表

| 指标 | 正常 | 警告 | 危险 |
|------|------|------|------|
| 数据库查询 | < 100ms | 100-200ms | > 200ms |
| 总耗时 | < 500ms | 500-1000ms | > 1000ms |

**自动告警**：
- 数据库查询 > 200ms：`[性能-订阅者] 数据库查询慢`
- 总耗时 > 1秒：`[性能-订阅者] 请求处理慢`

---

## 🔍 常见问题诊断

### 问题1：导入时前端请求pending

**症状**：
- 前端显示"pending"很久
- 后端日志延迟很久才出现
- 突然所有日志一起出现

**诊断**：
```bash
./立即诊断导入性能.sh
```

**可能原因**：
- PHP-FPM进程不足
- 前端轮询太频繁（已优化为3秒）
- 导入任务阻塞了进程

**解决方案**：见 `导入性能诊断指南.md`

---

### 问题2：黑名单页面翻页很慢

**症状**：
- 前几页正常
- 翻到后面很慢（>5秒）
- 日志显示数据库查询慢

**诊断**：
```bash
./快速诊断黑名单性能.sh
# 然后翻到后面的页（如第1000页）
```

**可能原因**：
- OFFSET在大数据集上性能差
- 索引不足

**解决方案**：见 `黑名单页面性能诊断说明.md`

---

### 问题3：订阅者页面加载慢

**症状**：
- 有列表过滤时特别慢
- 日志显示 whereHas 查询慢

**诊断**：
```bash
cd /data/www/sendwalk/backend
tail -f storage/logs/laravel.log | grep "\[性能-订阅者\]"
```

**可能原因**：
- 关联查询效率低
- 缺少联合索引

**解决方案**：优化关联查询或添加索引

---

## 📚 详细文档

| 文档 | 说明 |
|------|------|
| `性能监控部署说明.md` | 快速开始指南 |
| `导入性能诊断指南.md` | 导入问题详细诊断 |
| `黑名单页面性能诊断说明.md` | 黑名单页面详细诊断 |
| `导入进度轮询优化说明.md` | 前端轮询优化说明 |

---

## 🎓 使用流程

### 1. 发现问题
用户报告某个功能慢或卡顿

### 2. 选择工具
根据问题场景选择对应的诊断脚本

### 3. 开始监控
运行脚本，清空日志，开始实时监控

### 4. 重现问题
在浏览器中操作，触发慢请求

### 5. 分析日志
观察日志输出，找出瓶颈：
- 数据库查询慢？
- 缓存慢？
- 后处理慢？
- 响应构建慢？

### 6. 针对性优化
根据瓶颈进行优化：
- 数据库 → 添加索引、优化查询
- 缓存 → 检查Redis、优化缓存策略
- 后处理 → 优化业务逻辑
- 响应 → 减少返回数据量

### 7. 验证效果
再次运行诊断，对比优化前后的耗时

---

## 💡 最佳实践

### 日常监控
```bash
# 每天运行一次，查看整体性能
cd /data/www/sendwalk
./diagnose-import-performance.sh
# 选择 7（全面性能报告）
```

### 问题排查
```bash
# 根据具体问题选择对应工具
# 导入问题 → 立即诊断导入性能.sh
# 黑名单问题 → 快速诊断黑名单性能.sh
# 订阅者问题 → tail -f 日志 | grep 订阅者
```

### 性能优化
```bash
# 1. 运行诊断找出瓶颈
# 2. 针对性优化
# 3. 再次运行诊断验证
# 4. 对比优化前后的数据
```

---

## 📈 性能对比

优化前后的性能对比（示例）：

### 黑名单首页

| 指标 | 优化前 | 优化后 | 提升 |
|------|--------|--------|------|
| 数据库查询 | 8500ms | 45ms | 99.5% ↑ |
| 总耗时 | 8600ms | 52ms | 99.4% ↑ |

### 导入进度查询

| 指标 | 优化前 | 优化后 | 提升 |
|------|--------|--------|------|
| 轮询间隔 | 1秒 | 3秒 | 降低67%请求 |
| 平均耗时 | 15ms | 5ms | 67% ↑ |

---

## 🔗 相关文件

### 后端代码
- `backend/app/Http/Controllers/Api/SubscriberController.php`
- `backend/app/Http/Controllers/Api/BlacklistController.php`

### 诊断脚本
- `立即诊断导入性能.sh`
- `diagnose-import-performance.sh`
- `快速诊断黑名单性能.sh`
- `diagnose-blacklist-performance.sh`

### 文档
- `性能监控部署说明.md`
- `导入性能诊断指南.md`
- `黑名单页面性能诊断说明.md`
- `导入进度轮询优化说明.md`
- `性能监控工具汇总.md` (本文件)

---

## ✅ 部署清单

- [x] 添加导入进度查询性能日志
- [x] 添加黑名单列表性能日志
- [x] 添加订阅者列表性能日志
- [x] 创建诊断脚本（4个）
- [x] 创建详细文档（4个）
- [x] 前端轮询间隔优化（1秒 → 3秒）
- [x] 自动告警机制（慢查询、极慢请求）

---

## 🚀 立即使用

最常用的命令（推荐收藏）：

```bash
# 导入问题诊断
cd /data/www/sendwalk && ./立即诊断导入性能.sh

# 黑名单页面诊断
cd /data/www/sendwalk && ./快速诊断黑名单性能.sh

# 查看所有性能日志
cd /data/www/sendwalk/backend && tail -f storage/logs/laravel.log | grep "\[性能"
```

---

**创建日期**: 2025-12-26  
**版本**: v1.0  
**维护者**: SendWalk Team

