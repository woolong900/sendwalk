# é»‘åå•é¡µé¢æ€§èƒ½è¯Šæ–­è¯´æ˜

## âœ… å·²æ·»åŠ çš„è¯¦ç»†æ€§èƒ½æ—¥å¿—

### é»‘åå•åˆ—è¡¨é¡µé¢ (`BlacklistController::index`)

ç°åœ¨ä¼šè®°å½•ä»¥ä¸‹æ­¥éª¤çš„è€—æ—¶ï¼š

1. **æŸ¥è¯¢æ„å»º** (`query_build_ms`)
   - æ„å»º Eloquent æŸ¥è¯¢å¯¹è±¡
   - æ·»åŠ  user_id è¿‡æ»¤æ¡ä»¶

2. **æœç´¢æ¡ä»¶** (`search_ms`)
   - å¦‚æœæœ‰æœç´¢ï¼Œæ·»åŠ  LIKE æ¡ä»¶
   - è®°å½•æœç´¢å…³é”®è¯

3. **SQL å‡†å¤‡**
   - è®°å½•å®é™…è¦æ‰§è¡Œçš„ SQL è¯­å¥
   - è®°å½•ç»‘å®šå‚æ•°

4. **æ•°æ®åº“æŸ¥è¯¢** (`db_query_ms`) â­ é‡ç‚¹
   - æ‰§è¡Œ SQL æŸ¥è¯¢ï¼ˆå«åˆ†é¡µï¼‰
   - è®°å½•è¿”å›çš„è®°å½•æ•°ã€æ€»æ•°ã€é¡µç 
   - **å¦‚æœè¶…è¿‡100msï¼Œè‡ªåŠ¨è®°å½•è­¦å‘Š**

5. **å“åº”æ„å»º** (`response_build_ms`)
   - æ„å»º JSON å“åº”

6. **æ€»è€—æ—¶** (`total_duration_ms`)
   - **å¦‚æœè¶…è¿‡500msï¼Œè‡ªåŠ¨è®°å½•è­¦å‘Š**

---

### è®¢é˜…è€…åˆ—è¡¨é¡µé¢ (`SubscriberController::index`)

åŒæ ·æ·»åŠ äº†è¯¦ç»†æ—¥å¿—ï¼ŒåŒ…æ‹¬ï¼š

1. **åˆ—è¡¨è¿‡æ»¤** (`list_filter_ms`)
   - whereHas å…³è”æŸ¥è¯¢
   - with å…³è”åŠ è½½

2. **æœç´¢æ¡ä»¶**
   - email/first_name/last_name çš„ LIKE æŸ¥è¯¢

3. **æ•°æ®åº“æŸ¥è¯¢** (`db_query_ms`)
   - **å¦‚æœè¶…è¿‡200msï¼Œè‡ªåŠ¨è®°å½•è­¦å‘Š**

4. **åå¤„ç†** (`post_process_ms`)
   - ä¸ºæ¯ä¸ªè®¢é˜…è€…æ·»åŠ åˆ—è¡¨çŠ¶æ€

5. **å“åº”æ„å»º** (`response_build_ms`)

6. **æ€»è€—æ—¶** (`total_duration_ms`)
   - **å¦‚æœè¶…è¿‡1ç§’ï¼Œè‡ªåŠ¨è®°å½•è­¦å‘Š**

---

## ğŸš€ å¿«é€Ÿå¼€å§‹è¯Šæ–­

### æ–¹æ³•1ï¼šä¸“ç”¨é»‘åå•è¯Šæ–­å·¥å…·ï¼ˆæ¨èï¼‰â­

```bash
cd /data/www/sendwalk
git pull
./diagnose-blacklist-performance.sh
```

**è‡ªåŠ¨åŠŸèƒ½**ï¼š
- âœ… å¤‡ä»½å¹¶æ¸…ç©ºæ—¥å¿—ï¼ˆä¾¿äºæŸ¥çœ‹æ–°æ—¥å¿—ï¼‰
- âœ… æ£€æŸ¥æ•°æ®åº“çŠ¶æ€ï¼ˆè®°å½•æ•°ã€ç´¢å¼•ï¼‰
- âœ… å®æ—¶ç›‘æ§æ€§èƒ½æ—¥å¿—ï¼ˆå½©è‰²è¾“å‡ºï¼‰
- âœ… è‡ªåŠ¨è¯†åˆ«æ…¢è¯·æ±‚å¹¶é«˜äº®æ˜¾ç¤º

**ç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æˆ–åˆ·æ–°é»‘åå•é¡µé¢ã€‚**

---

### æ–¹æ³•2ï¼šç›´æ¥æŸ¥çœ‹æ—¥å¿—

```bash
cd /data/www/sendwalk/backend
tail -f storage/logs/laravel.log | grep "\[æ€§èƒ½-é»‘åå•\]"
```

---

### æ–¹æ³•3ï¼šæŸ¥çœ‹è®¢é˜…è€…é¡µé¢æ€§èƒ½

```bash
cd /data/www/sendwalk/backend
tail -f storage/logs/laravel.log | grep "\[æ€§èƒ½-è®¢é˜…è€…\]"
```

---

## ğŸ“Š æ€§èƒ½æ—¥å¿—ç¤ºä¾‹

### æ­£å¸¸æƒ…å†µï¼ˆå¥åº·ï¼‰

```json
[æ€§èƒ½-é»‘åå•] å¼€å§‹å¤„ç†åˆ—è¡¨è¯·æ±‚
{
  "request_id": "req_abc123",
  "user_id": 1,
  "page": 1,
  "per_page": 15,
  "has_search": false
}

[æ€§èƒ½-é»‘åå•] æŸ¥è¯¢æ„å»ºå®Œæˆ
{
  "request_id": "req_abc123",
  "duration_ms": 0.8
}

[æ€§èƒ½-é»‘åå•] å‡†å¤‡æ‰§è¡ŒSQL
{
  "request_id": "req_abc123",
  "sql": "select `id`, `email`, `reason`, `created_at` from `blacklist` where `user_id` = ? order by `id` desc limit 15 offset 0"
}

[æ€§èƒ½-é»‘åå•] æ•°æ®åº“æŸ¥è¯¢å®Œæˆ
{
  "request_id": "req_abc123",
  "duration_ms": 45.2,
  "total_records": 2000000,
  "current_page": 1,
  "per_page": 15,
  "last_page": 133334,
  "returned_count": 15
}

[æ€§èƒ½-é»‘åå•] è¯·æ±‚å¤„ç†å®Œæˆ
{
  "request_id": "req_abc123",
  "query_build_ms": 0.8,
  "db_query_ms": 45.2,
  "response_build_ms": 2.1,
  "total_duration_ms": 52.5,
  "total_records": 2000000
}
```

---

### æœ‰é—®é¢˜çš„æƒ…å†µï¼ˆæ…¢æŸ¥è¯¢ï¼‰

```json
[æ€§èƒ½-é»‘åå•] æ•°æ®åº“æŸ¥è¯¢å®Œæˆ
{
  "request_id": "req_xyz789",
  "duration_ms": 8542.7,  // ğŸš¨ è¶…è¿‡8ç§’ï¼
  "total_records": 2000000,
  "current_page": 66667,  // ç¿»åˆ°å¾ˆåé¢çš„é¡µ
  "returned_count": 15
}

[æ€§èƒ½-é»‘åå•] æ•°æ®åº“æŸ¥è¯¢æ…¢
{
  "request_id": "req_xyz789",
  "duration_ms": 8542.7,
  "threshold_ms": 100,
  "total_records": 2000000
}

[æ€§èƒ½-é»‘åå•] è¯·æ±‚å¤„ç†å®Œæˆ
{
  "request_id": "req_xyz789",
  "db_query_ms": 8542.7,
  "total_duration_ms": 8650.3
}

[æ€§èƒ½-é»‘åå•] è¯·æ±‚å¤„ç†æ…¢
{
  "request_id": "req_xyz789",
  "total_duration_ms": 8650.3,
  "threshold_ms": 500,
  "db_query_ms": 8542.7,
  "percentage_in_db": "98.8%"  // 98.8%çš„æ—¶é—´åœ¨æ•°æ®åº“æŸ¥è¯¢
}
```

---

## ğŸ” è¯Šæ–­æ­¥éª¤

### Step 1: éƒ¨ç½²æœ€æ–°ä»£ç 
```bash
cd /data/www/sendwalk
git pull
```

### Step 2: å¼€å§‹è¯Šæ–­
```bash
./diagnose-blacklist-performance.sh
```

### Step 3: è§¦å‘é¡µé¢åŠ è½½
åœ¨æµè§ˆå™¨ä¸­ï¼š
1. æ‰“å¼€é»‘åå•é¡µé¢
2. å°è¯•ç¿»é¡µ
3. å°è¯•æœç´¢
4. è§‚å¯Ÿç»ˆç«¯æ—¥å¿—

### Step 4: åˆ†æç»“æœ

#### åœºæ™¯Aï¼šæ•°æ®åº“æŸ¥è¯¢æ…¢ï¼ˆdb_query_ms å¾ˆå¤§ï¼‰
**åŸå› **ï¼š
- æ•°æ®é‡å¤ªå¤§ï¼ˆ200ä¸‡+ï¼‰
- ç´¢å¼•ä¸è¶³æˆ–æœªä½¿ç”¨
- ç¿»é¡µåˆ°å¾ˆåé¢ï¼ˆOFFSET å¾ˆå¤§ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ç´¢å¼•ï¼ˆè§ä¸‹æ–¹"ç´¢å¼•ä¼˜åŒ–"ï¼‰
2. ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µä»£æ›¿OFFSET
3. é™åˆ¶æœ€å¤§é¡µæ•°

#### åœºæ™¯Bï¼šæ€»è€—æ—¶é•¿ä½†æ•°æ®åº“ä¸æ…¢
**åŸå› **ï¼š
- ç½‘ç»œå»¶è¿Ÿ
- PHPè¿›ç¨‹é˜»å¡
- å“åº”æ•°æ®è¿‡å¤§

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ response_build_ms
2. å‡å°‘è¿”å›çš„å­—æ®µ
3. æ£€æŸ¥PHP-FPMé…ç½®

---

## ğŸ”§ å¸¸è§é—®é¢˜ä¿®å¤

### é—®é¢˜1ï¼šç¿»é¡µè¶Šå¾€åè¶Šæ…¢

**ç—‡çŠ¶**ï¼š
- å‰å‡ é¡µå¾ˆå¿«ï¼ˆ<100msï¼‰
- åé¢çš„é¡µå¾ˆæ…¢ï¼ˆ>5ç§’ï¼‰
- æ—¥å¿—æ˜¾ç¤º `current_page` å¾ˆå¤§

**åŸå› **ï¼š
MySQLçš„OFFSETåœ¨å¤§æ•°æ®é›†ä¸Šæ€§èƒ½å·®ï¼š
```sql
-- ç¿»åˆ°ç¬¬66667é¡µ
LIMIT 15 OFFSET 999990  -- éœ€è¦è·³è¿‡999990æ¡è®°å½•ï¼
```

**è§£å†³æ–¹æ¡ˆ1ï¼šé™åˆ¶æœ€å¤§é¡µæ•°**

åœ¨å‰ç«¯é™åˆ¶ç”¨æˆ·ä¸èƒ½ç¿»å¤ªå¤šé¡µï¼š
```typescript
// frontend/src/pages/blacklist/index.tsx
const maxPage = Math.min(totalPages, 100) // æœ€å¤š100é¡µ
```

**è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼ˆæ¨èï¼‰**

ä¿®æ”¹åç«¯ä½¿ç”¨åŸºäºIDçš„åˆ†é¡µï¼š
```php
// ä¸è¦ç”¨ offsetï¼Œæ”¹ç”¨ where id < $lastId
$query->where('id', '<', $lastId)->limit($perPage);
```

---

### é—®é¢˜2ï¼šç´¢å¼•ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥ç´¢å¼•**ï¼š
```bash
mysql -e "SHOW INDEX FROM sendwalk.blacklist"
```

**åº”è¯¥æœ‰çš„ç´¢å¼•**ï¼š
```sql
-- ä¸»é”®ç´¢å¼•
PRIMARY KEY (id)

-- ç”¨æˆ·æŸ¥è¯¢ç´¢å¼•
KEY idx_blacklist_user_id_id (user_id, id)

-- åˆ›å»ºæ—¶é—´ç´¢å¼•ï¼ˆå¦‚æœæŒ‰æ—¶é—´æ’åºï¼‰
KEY idx_blacklist_created_at (created_at)
```

**æ·»åŠ ç¼ºå¤±çš„ç´¢å¼•**ï¼š
```bash
cd /data/www/sendwalk/backend
php artisan migrate
```

---

### é—®é¢˜3ï¼šæ•°æ®é‡è¿‡å¤§

**å½“å‰çŠ¶æ€**ï¼š200ä¸‡+æ¡è®°å½•

**ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **åˆ†é¡µé™åˆ¶**
```php
// é™åˆ¶æœ€å¤šè¿”å›10000æ¡
if ($totalRecords > 10000) {
    $maxPage = ceil(10000 / $perPage);
    if ($currentPage > $maxPage) {
        // é‡å®šå‘åˆ°æœ€åä¸€é¡µ
    }
}
```

2. **å½’æ¡£æ—§æ•°æ®**
```bash
# å°†1å¹´å‰çš„æ•°æ®ç§»åˆ°å½’æ¡£è¡¨
mysql -e "INSERT INTO blacklist_archive SELECT * FROM blacklist WHERE created_at < DATE_SUB(NOW(), INTERVAL 1 YEAR)"
```

3. **ä½¿ç”¨Elasticsearch**ï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰
- å°†é»‘åå•æ•°æ®åŒæ­¥åˆ°Elasticsearch
- å‰ç«¯ç›´æ¥æŸ¥è¯¢ES
- æ”¯æŒæ›´å¤æ‚çš„æœç´¢å’Œæ›´å¿«çš„åˆ†é¡µ

---

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### é»‘åå•åˆ—è¡¨

| åœºæ™¯ | æ•°æ®é‡ | é¡µç  | é¢„æœŸè€—æ—¶ | è­¦å‘Šé˜ˆå€¼ |
|------|--------|------|---------|---------|
| é¦–é¡µ | 200ä¸‡ | 1 | < 50ms | 100ms |
| å‰100é¡µ | 200ä¸‡ | 1-100 | < 100ms | 100ms |
| ä¸­é—´é¡µ | 200ä¸‡ | 100-1000 | < 200ms | 100ms |
| åé¢é¡µ | 200ä¸‡ | >1000 | å¯èƒ½å¾ˆæ…¢ | 100ms |

### è®¢é˜…è€…åˆ—è¡¨ï¼ˆå¸¦å…³è”æŸ¥è¯¢ï¼‰

| åœºæ™¯ | é¢„æœŸè€—æ—¶ | è­¦å‘Šé˜ˆå€¼ |
|------|---------|---------|
| æ— è¿‡æ»¤ | < 100ms | 200ms |
| åˆ—è¡¨è¿‡æ»¤ | < 200ms | 200ms |
| çŠ¶æ€è¿‡æ»¤ | < 200ms | 200ms |
| æœç´¢ | < 300ms | 200ms |
| å…¨éƒ¨æ¡ä»¶ | < 500ms | 200ms |

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆç«‹å³å¯åšï¼‰

1. **é™åˆ¶æœ€å¤§é¡µæ•°**
```typescript
// å‰ç«¯é™åˆ¶
const MAX_PAGE = 100
```

2. **æ·»åŠ æœç´¢æç¤º**
"å»ºè®®ä½¿ç”¨æœç´¢åŠŸèƒ½ç²¾ç¡®æŸ¥æ‰¾ï¼Œé¿å…ç¿»é¡µè¿‡å¤š"

3. **ç¼“å­˜æ€»æ•°**
ä¸è¦æ¯æ¬¡éƒ½ COUNT(*)ï¼Œç¼“å­˜æ€»æ•°ï¼š
```php
$totalCount = Cache::remember("blacklist_total_{$userId}", 300, function() {
    return Blacklist::where('user_id', $userId)->count();
});
```

### ä¸­æœŸä¼˜åŒ–

1. **æ¸¸æ ‡åˆ†é¡µ**
æ”¹ç”¨åŸºäºIDçš„åˆ†é¡µ

2. **æ•°æ®å½’æ¡£**
å®šæœŸå½’æ¡£æ—§æ•°æ®

3. **æ·»åŠ ç´¢å¼•**
ç¡®ä¿æ‰€æœ‰æŸ¥è¯¢éƒ½ç”¨ä¸Šç´¢å¼•

### é•¿æœŸä¼˜åŒ–

1. **Elasticsearché›†æˆ**
å¤§æ•°æ®æœç´¢å’Œåˆ†é¡µ

2. **åˆ†è¡¨ç­–ç•¥**
æŒ‰ç”¨æˆ·æˆ–æ—¶é—´åˆ†è¡¨

3. **Redisç¼“å­˜**
çƒ­ç‚¹æ•°æ®ç¼“å­˜

---

## ğŸ“ æ”¶é›†è¯Šæ–­ä¿¡æ¯

å¦‚æœé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œè¯·æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š

### 1. æ€§èƒ½æ—¥å¿—
```bash
cd /data/www/sendwalk/backend
tail -100 storage/logs/laravel.log | grep "\[æ€§èƒ½-é»‘åå•\]" > blacklist-performance.log
```

### 2. æ•°æ®åº“çŠ¶æ€
```bash
mysql -e "SELECT COUNT(*) FROM sendwalk.blacklist" > db-stats.txt
mysql -e "SHOW INDEX FROM sendwalk.blacklist" >> db-stats.txt
mysql -e "SHOW TABLE STATUS LIKE 'blacklist'" >> db-stats.txt
```

### 3. æ…¢æŸ¥è¯¢æ—¥å¿—
```bash
mysql -e "SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10" > slow-queries.log
```

### 4. å¤ç°æ­¥éª¤
è®°å½•ï¼š
- å“ªä¸ªé¡µé¢å¡
- ç¬¬å‡ é¡µ
- æœ‰æ²¡æœ‰æœç´¢
- è€—æ—¶å¤šä¹…
- æ—¥å¿—ä¸­çš„ request_id

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

éƒ¨ç½²åï¼Œä½ èƒ½çœ‹åˆ°ï¼š

1. âœ… æ¯ä¸ªè¯·æ±‚çš„è¯¦ç»†è€—æ—¶åˆ†è§£
2. âœ… æ•°æ®åº“æŸ¥è¯¢çš„å®é™…SQLè¯­å¥
3. âœ… è¿”å›çš„è®°å½•æ•°å’Œæ€»æ•°
4. âœ… è‡ªåŠ¨è¯†åˆ«æ…¢æŸ¥è¯¢ï¼ˆå½©è‰²é«˜äº®ï¼‰
5. âœ… ç“¶é¢ˆåœ¨å“ªä¸ªæ­¥éª¤ï¼ˆæ•°æ®åº“ï¼Ÿå“åº”æ„å»ºï¼Ÿï¼‰

ä½ èƒ½å‘ç°ï¼š

- ğŸ” é¡µé¢å¡åœ¨æ•°æ®åº“æŸ¥è¯¢è¿˜æ˜¯å…¶ä»–åœ°æ–¹
- ğŸ” å“ªäº›é¡µç ç‰¹åˆ«æ…¢
- ğŸ” æœ‰æ²¡æœ‰ç´¢å¼•ç”Ÿæ•ˆ
- ğŸ” æŸ¥è¯¢è¿”å›äº†å¤šå°‘æ•°æ®
- ğŸ” å…·ä½“çš„æ€§èƒ½ç“¶é¢ˆ

---

## ğŸš€ ç«‹å³å¼€å§‹

```bash
cd /data/www/sendwalk
git pull
./diagnose-blacklist-performance.sh
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€é»‘åå•é¡µé¢ï¼Œè§‚å¯Ÿå®æ—¶æ—¥å¿—ï¼

---

**åˆ›å»ºæ—¥æœŸ**: 2025-12-26  
**ç‰ˆæœ¬**: v1.0  
**é€‚ç”¨äº**: é»‘åå•åˆ—è¡¨é¡µé¢ã€è®¢é˜…è€…åˆ—è¡¨é¡µé¢

