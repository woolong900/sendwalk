# å¯¼å…¥æ€§èƒ½è¯Šæ–­æŒ‡å—

## ğŸ“‹ é—®é¢˜æè¿°

å¯¼å…¥è®¢é˜…è€…æ—¶ï¼Œå‰ç«¯ä¸æ–­æŸ¥è¯¢å¯¼å…¥è¿›åº¦ï¼Œä½†ï¼š
- åç«¯æ—¥å¿—ä¸€ç›´æ²¡æœ‰æ”¶åˆ°è¯·æ±‚
- å‰ç«¯è¯·æ±‚ä¸€ç›´å¤„äº pending çŠ¶æ€
- è¿‡äº†å¾ˆä¹…åï¼Œåç«¯çªç„¶åŒæ—¶æ‰“å°å¤§é‡æ—¥å¿—
- ç„¶åå‰ç«¯æ‰æç¤ºå¯¼å…¥å®Œæˆ

---

## ğŸ” å·²æ·»åŠ çš„æ€§èƒ½æ—¥å¿—

### 1. å¯¼å…¥è¿›åº¦æŸ¥è¯¢è¯¦ç»†æ—¥å¿—

æ¯æ¬¡æŸ¥è¯¢å¯¼å…¥è¿›åº¦æ—¶ï¼Œä¼šè®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š

```
[æ€§èƒ½] å¼€å§‹å¤„ç†å¯¼å…¥è¿›åº¦è¯·æ±‚
  - request_id: å”¯ä¸€è¯·æ±‚ID
  - import_id: å¯¼å…¥ä»»åŠ¡ID
  - timestamp: æ—¶é—´æˆ³

[æ€§èƒ½] ç¼“å­˜æŸ¥è¯¢å®Œæˆ
  - request_id: è¯·æ±‚ID
  - cache_key: ç¼“å­˜é”®
  - duration_ms: ç¼“å­˜æŸ¥è¯¢è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  - progress_found: æ˜¯å¦æ‰¾åˆ°è¿›åº¦
  - progress_status: å½“å‰çŠ¶æ€
  - progress_percent: è¿›åº¦ç™¾åˆ†æ¯”

[æ€§èƒ½] è¯·æ±‚å¤„ç†å®Œæˆ
  - request_id: è¯·æ±‚ID
  - cache_duration_ms: ç¼“å­˜æŸ¥è¯¢è€—æ—¶
  - response_duration_ms: å“åº”æ„å»ºè€—æ—¶
  - total_duration_ms: æ€»è€—æ—¶
  - progress_status: æœ€ç»ˆçŠ¶æ€
```

### 2. æ…¢è¯·æ±‚è­¦å‘Š

```
[æ€§èƒ½] æ…¢è¯·æ±‚è­¦å‘Š - è€—æ—¶è¶…è¿‡1ç§’
[æ€§èƒ½] ææ…¢è¯·æ±‚ - è€—æ—¶è¶…è¿‡5ç§’
```

---

## ğŸ› ï¸ è¯Šæ–­å·¥å…·

### å·¥å…·1ï¼šæ€§èƒ½è¯Šæ–­è„šæœ¬

åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š
```bash
cd /data/www/sendwalk
./diagnose-import-performance.sh
```

**åŠŸèƒ½é€‰é¡¹**ï¼š
1. **å®æ—¶ç›‘æ§æ€§èƒ½æ—¥å¿—** - æŸ¥çœ‹å®æ—¶çš„æ€§èƒ½æ•°æ®
2. **æŸ¥çœ‹æ…¢è¯·æ±‚** - æ‰¾å‡ºè€—æ—¶è¶…è¿‡1ç§’çš„è¯·æ±‚
3. **æŸ¥çœ‹ææ…¢è¯·æ±‚** - æ‰¾å‡ºè€—æ—¶è¶…è¿‡5ç§’çš„è¯·æ±‚
4. **å¯¼å…¥è¯·æ±‚ç»Ÿè®¡** - æ€»è¯·æ±‚æ•°ã€å¹³å‡è€—æ—¶ç­‰
5. **PHP-FPMçŠ¶æ€** - è¿›ç¨‹æ•°ã€å†…å­˜ä½¿ç”¨
6. **Nginxè¿æ¥æ•°** - å½“å‰è¿æ¥ç»Ÿè®¡
7. **å…¨é¢æ€§èƒ½æŠ¥å‘Š** - ç»¼åˆæŠ¥å‘Š

### å·¥å…·2ï¼šå®æ—¶æ—¥å¿—ç›‘æ§

æŸ¥çœ‹æ‰€æœ‰æ€§èƒ½ç›¸å…³æ—¥å¿—ï¼š
```bash
cd /data/www/sendwalk/backend
tail -f storage/logs/laravel.log | grep "\[æ€§èƒ½\]"
```

åªæŸ¥çœ‹å¯¼å…¥è¿›åº¦è¯·æ±‚ï¼š
```bash
tail -f storage/logs/laravel.log | grep "å¯¼å…¥è¿›åº¦è¯·æ±‚"
```

---

## ğŸ“Š å¦‚ä½•è¯Šæ–­é—®é¢˜

### æ­¥éª¤1ï¼šå¼€å§‹ä¸€æ¬¡å¯¼å…¥

åœ¨æµè§ˆå™¨ä¸­å¼€å§‹å¯¼å…¥è®¢é˜…è€…æˆ–é»‘åå•ã€‚

### æ­¥éª¤2ï¼šå®æ—¶ç›‘æ§æ—¥å¿—

åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š
```bash
cd /data/www/sendwalk
./diagnose-import-performance.sh
```

é€‰æ‹© `1` å®æ—¶ç›‘æ§æ€§èƒ½æ—¥å¿—ã€‚

### æ­¥éª¤3ï¼šè§‚å¯Ÿæ—¥å¿—è¾“å‡º

#### æ­£å¸¸æƒ…å†µ
åº”è¯¥æ¯3ç§’çœ‹åˆ°ä¸€ç»„æ—¥å¿—ï¼š
```
[æ€§èƒ½] å¼€å§‹å¤„ç†å¯¼å…¥è¿›åº¦è¯·æ±‚ {"request_id":"req_xxx",...}
[æ€§èƒ½] ç¼“å­˜æŸ¥è¯¢å®Œæˆ {"duration_ms":2.5,...}
[æ€§èƒ½] è¯·æ±‚å¤„ç†å®Œæˆ {"total_duration_ms":5.2,...}
```

#### å¼‚å¸¸æƒ…å†µ1ï¼šæ²¡æœ‰æ—¥å¿—è¾“å‡º
**å¯èƒ½åŸå› **ï¼š
- è¯·æ±‚æ ¹æœ¬æ²¡æœ‰åˆ°è¾¾PHP-FPM
- Nginxé…ç½®é—®é¢˜
- PHP-FPMè¿›ç¨‹å…¨éƒ¨é˜»å¡

**è¯Šæ–­**ï¼š
```bash
# æ£€æŸ¥Nginxæ—¥å¿—
sudo tail -f /var/log/nginx/access.log | grep "import-progress"

# æ£€æŸ¥PHP-FPMçŠ¶æ€
ps aux | grep php-fpm
```

#### å¼‚å¸¸æƒ…å†µ2ï¼šæ—¥å¿—å»¶è¿Ÿå¾ˆä¹…æ‰å‡ºç°
**å¯èƒ½åŸå› **ï¼š
- PHP-FPMè¿›ç¨‹ä¸è¶³ï¼Œè¯·æ±‚åœ¨æ’é˜Ÿ
- æ•°æ®åº“è¿æ¥æ± è€—å°½
- Redis/ç¼“å­˜è¿æ¥é—®é¢˜

**è¯Šæ–­**ï¼š
```bash
# æŸ¥çœ‹PHP-FPMè¿›ç¨‹æ•°
ps aux | grep php-fpm | wc -l

# æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
./diagnose-import-performance.sh
# é€‰æ‹© 5 æŸ¥çœ‹PHP-FPMçŠ¶æ€
```

#### å¼‚å¸¸æƒ…å†µ3ï¼šæ€»è€—æ—¶å¾ˆé•¿ï¼ˆ>1ç§’ï¼‰
**å¯èƒ½åŸå› **ï¼š
- ç¼“å­˜æŸ¥è¯¢æ…¢
- æ•°æ®åº“è¿æ¥æ…¢
- æœåŠ¡å™¨èµ„æºä¸è¶³

**æ£€æŸ¥æ—¥å¿—ä¸­çš„è¯¦ç»†è€—æ—¶**ï¼š
```
cache_duration_ms: X     # ç¼“å­˜æŸ¥è¯¢è€—æ—¶
response_duration_ms: Y  # å“åº”æ„å»ºè€—æ—¶
total_duration_ms: Z     # æ€»è€—æ—¶
```

---

## ğŸ”§ å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šPHP-FPMè¿›ç¨‹ä¸è¶³

**ç—‡çŠ¶**ï¼š
- æ—¥å¿—å»¶è¿Ÿå¾ˆä¹…æ‰å‡ºç°
- å¤§é‡è¯·æ±‚pending
- è¯Šæ–­è„šæœ¬æ˜¾ç¤ºè¿›ç¨‹æ•°åªæœ‰5ä¸ª

**è§£å†³æ–¹æ¡ˆ**ï¼š

ç¼–è¾‘ PHP-FPM é…ç½®ï¼š
```bash
sudo nano /etc/php/8.2/fpm/pool.d/www.conf
```

ä¿®æ”¹é…ç½®ï¼š
```ini
pm = dynamic
pm.max_children = 20          # ä»5æ”¹ä¸º20
pm.start_servers = 5          # ä»2æ”¹ä¸º5
pm.min_spare_servers = 3      # ä»1æ”¹ä¸º3
pm.max_spare_servers = 8      # ä»3æ”¹ä¸º8
```

é‡å¯PHP-FPMï¼š
```bash
sudo systemctl restart php8.2-fpm
```

éªŒè¯ï¼š
```bash
ps aux | grep php-fpm | wc -l
# åº”è¯¥æ˜¾ç¤ºæ›´å¤šè¿›ç¨‹
```

---

### é—®é¢˜2ï¼šç¼“å­˜æŸ¥è¯¢æ…¢

**ç—‡çŠ¶**ï¼š
- æ—¥å¿—æ˜¾ç¤º `cache_duration_ms` å¾ˆå¤§ï¼ˆ>100msï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

æ£€æŸ¥RedisçŠ¶æ€ï¼š
```bash
redis-cli ping
# åº”è¯¥è¿”å› PONG

redis-cli info stats | grep instantaneous_ops_per_sec
# æŸ¥çœ‹æ¯ç§’æ“ä½œæ•°
```

å¦‚æœRediså“åº”æ…¢ï¼š
```bash
# é‡å¯Redis
sudo systemctl restart redis

# æ¸…ç†ä¸éœ€è¦çš„ç¼“å­˜
redis-cli FLUSHDB
```

---

### é—®é¢˜3ï¼šæ•°æ®åº“è¿æ¥è€—å°½

**ç—‡çŠ¶**ï¼š
- æ—¥å¿—æ˜¾ç¤ºé”™è¯¯ "Too many connections"
- å¯¼å…¥ä»»åŠ¡æ— æ³•å¤„ç†

**è§£å†³æ–¹æ¡ˆ**ï¼š

æ£€æŸ¥MySQLè¿æ¥ï¼š
```bash
mysql -u root -p -e "SHOW PROCESSLIST;"
```

å¢åŠ æœ€å¤§è¿æ¥æ•°ï¼š
```bash
mysql -u root -p

SET GLOBAL max_connections = 200;
```

æ°¸ä¹…ä¿®æ”¹ï¼š
```bash
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf

# æ·»åŠ æˆ–ä¿®æ”¹
[mysqld]
max_connections = 200
```

é‡å¯MySQLï¼š
```bash
sudo systemctl restart mysql
```

---

### é—®é¢˜4ï¼šé˜Ÿåˆ—Workeré˜»å¡

**ç—‡çŠ¶**ï¼š
- å¯¼å…¥ä»»åŠ¡ä¸€ç›´å¤„äº queued çŠ¶æ€
- `progress_status` ä¸€ç›´æ˜¯ "queued"

**è§£å†³æ–¹æ¡ˆ**ï¼š

æ£€æŸ¥é˜Ÿåˆ—workerï¼š
```bash
# æŸ¥çœ‹é˜Ÿåˆ—workeræ—¥å¿—
cd /data/www/sendwalk/backend
tail -f storage/logs/laravel.log | grep "ImportSubscribers\|ImportBlacklist"
```

æ£€æŸ¥SupervisorçŠ¶æ€ï¼š
```bash
supervisorctl status

# å¦‚æœworkeræ²¡è¿è¡Œï¼Œå¯åŠ¨å®ƒ
supervisorctl start laravel-worker:*
```

æ£€æŸ¥å¤±è´¥çš„ä»»åŠ¡ï¼š
```bash
cd /data/www/sendwalk/backend
php artisan queue:failed

# é‡è¯•å¤±è´¥çš„ä»»åŠ¡
php artisan queue:retry all
```

---

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### æ­£å¸¸æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ­£å¸¸å€¼ | è­¦å‘Šå€¼ | å±é™©å€¼ |
|------|--------|--------|--------|
| æ€»è€—æ—¶ | < 50ms | 50-1000ms | > 1000ms |
| ç¼“å­˜æŸ¥è¯¢ | < 10ms | 10-50ms | > 50ms |
| å“åº”æ„å»º | < 5ms | 5-20ms | > 20ms |
| PHP-FPMè¿›ç¨‹ | 5-10ä¸ª | 10-20ä¸ª | > 20ä¸ª |
| Nginxè¿æ¥ | < 100ä¸ª | 100-500ä¸ª | > 500ä¸ª |

### ç¤ºä¾‹ï¼šå¥åº·çš„æ—¥å¿—

```json
{
  "request_id": "req_67641234",
  "import_id": "uuid-xxxx",
  "cache_duration_ms": 2.5,
  "response_duration_ms": 1.8,
  "total_duration_ms": 5.2,
  "progress_status": "processing"
}
```

### ç¤ºä¾‹ï¼šæœ‰é—®é¢˜çš„æ—¥å¿—

```json
{
  "request_id": "req_67641234",
  "import_id": "uuid-xxxx",
  "cache_duration_ms": 245.8,    // ç¼“å­˜æŸ¥è¯¢æ…¢ï¼
  "response_duration_ms": 1523.2, // å“åº”æ„å»ºæ…¢ï¼
  "total_duration_ms": 1825.7,   // æ€»è€—æ—¶è¶…è¿‡1ç§’ï¼
  "progress_status": "processing"
}
```

---

## ğŸš€ éƒ¨ç½²æ€§èƒ½ç›‘æ§

### 1. æ‹‰å–æœ€æ–°ä»£ç 
```bash
cd /data/www/sendwalk
git pull
```

### 2. æ— éœ€é‡å¯æœåŠ¡
æ€§èƒ½æ—¥å¿—å·²æ·»åŠ åˆ°ç°æœ‰ä»£ç ä¸­ï¼Œä¼šè‡ªåŠ¨ç”Ÿæ•ˆã€‚

### 3. å¼€å§‹ç›‘æ§
```bash
# æ–¹å¼1ï¼šä½¿ç”¨è¯Šæ–­è„šæœ¬
./diagnose-import-performance.sh

# æ–¹å¼2ï¼šç›´æ¥æŸ¥çœ‹æ—¥å¿—
cd backend
tail -f storage/logs/laravel.log | grep "\[æ€§èƒ½\]"
```

---

## ğŸ“ æ”¶é›†è¯Šæ–­ä¿¡æ¯

å¦‚æœé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œæ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š

### 1. æ€§èƒ½æŠ¥å‘Š
```bash
cd /data/www/sendwalk
./diagnose-import-performance.sh
# é€‰æ‹© 7 (å…¨é¢æ€§èƒ½æŠ¥å‘Š)
```

### 2. æœ€è¿‘çš„æ€§èƒ½æ—¥å¿—
```bash
cd backend
tail -100 storage/logs/laravel.log | grep "\[æ€§èƒ½\]" > performance.log
```

### 3. PHP-FPMé…ç½®
```bash
cat /etc/php/8.2/fpm/pool.d/www.conf > php-fpm.conf
```

### 4. ç³»ç»Ÿèµ„æº
```bash
# CPUå’Œå†…å­˜
top -b -n 1 | head -20 > system.log

# è¿æ¥ç»Ÿè®¡
netstat -an | grep :80 >> system.log
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å®šæœŸç›‘æ§**
   - æ¯å¤©è¿è¡Œä¸€æ¬¡æ€§èƒ½æŠ¥å‘Š
   - å…³æ³¨æ…¢è¯·æ±‚è¶‹åŠ¿

2. **è®¾ç½®å‘Šè­¦**
   - å½“æ…¢è¯·æ±‚æ•°è¶…è¿‡10ä¸ªæ—¶å‘Šè­¦
   - å½“PHP-FPMè¿›ç¨‹æ•°è¾¾åˆ°ä¸Šé™æ—¶å‘Šè­¦

3. **ä¼˜åŒ–é…ç½®**
   - æ ¹æ®æœåŠ¡å™¨èµ„æºè°ƒæ•´PHP-FPMè¿›ç¨‹æ•°
   - æ ¹æ®å¹¶å‘é‡è°ƒæ•´MySQLè¿æ¥æ•°

4. **æ—¥å¿—ç®¡ç†**
   - å®šæœŸæ¸…ç†æ—§æ—¥å¿—ï¼ˆä¿ç•™7å¤©ï¼‰
   - å‹ç¼©å½’æ¡£å†å²æ—¥å¿—

---

**åˆ›å»ºæ—¥æœŸ**: 2025-12-26  
**ç‰ˆæœ¬**: v1.0  
**é€‚ç”¨äº**: è®¢é˜…è€…å¯¼å…¥ã€é»‘åå•å¯¼å…¥

