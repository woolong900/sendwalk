# åŸŸåé…ç½®è¯´æ˜

## ğŸŒ ä½¿ç”¨çš„åŸŸå

æœ¬é¡¹ç›®åŸŸåé…ç½®ï¼š

| æœåŠ¡ | åŸŸå | è¯´æ˜ |
|------|------|------|
| å‰ç«¯åº”ç”¨ | `edm.sendwalk.com` | ç”¨æˆ·è®¿é—®çš„ä¸»ç•Œé¢ |
| åç«¯ API | `api.sendwalk.com` | API æ¥å£æœåŠ¡ |

## ğŸ“‹ DNS é…ç½®

éœ€è¦åœ¨åŸŸå DNS ç®¡ç†ä¸­æ·»åŠ ä»¥ä¸‹ A è®°å½•ï¼š

```
# å‡è®¾æœåŠ¡å™¨ IP ä¸º: 1.2.3.4

A     edm           1.2.3.4
A     api           1.2.3.4
```

æˆ–è€…ä½¿ç”¨ CNAMEï¼ˆå¦‚æœä¸»åŸŸåå·²æœ‰ A è®°å½•ï¼‰ï¼š

```
CNAME edm           sendwalk.com
CNAME api           sendwalk.com
```

## âœ… å·²æ›´æ–°çš„é…ç½®æ–‡ä»¶

### 1. **Nginx å‰ç«¯é…ç½®** (`nginx/frontend.conf`)

```nginx
server {
    listen 80;
    server_name edm.sendwalk.com;
    root /data/www/sendwalk/frontend/dist;
    ...
}
```

### 2. **Nginx API é…ç½®** (`nginx/api.conf`)

```nginx
server {
    listen 80;
    server_name api.sendwalk.com;
    root /data/www/sendwalk/backend/public;
    ...
}
```

### 3. **åç«¯ç¯å¢ƒé…ç½®** (`config.env.production.example`)

```bash
APP_URL=https://edm.sendwalk.com
FRONTEND_URL=https://edm.sendwalk.com
SANCTUM_STATEFUL_DOMAINS=edm.sendwalk.com
SESSION_DOMAIN=.edm.sendwalk.com
```

### 4. **å‰ç«¯ç¯å¢ƒé…ç½®**

åˆ›å»º `frontend/.env.production`ï¼š

```bash
VITE_API_URL=https://api.sendwalk.com
VITE_APP_NAME=SendWalk
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. é…ç½® DNS

åœ¨åŸŸåæœåŠ¡å•†ï¼ˆå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€Cloudflareï¼‰æ·»åŠ  DNS è®°å½•ï¼š

```
ç±»å‹   ä¸»æœºè®°å½•      è®°å½•å€¼
A      edm          æœåŠ¡å™¨IP
A      api.edm      æœåŠ¡å™¨IP
```

ç­‰å¾… DNS ç”Ÿæ•ˆï¼ˆé€šå¸¸ 5-10 åˆ†é’Ÿï¼Œæœ€é•¿å¯èƒ½éœ€è¦ 24 å°æ—¶ï¼‰ã€‚

### 2. éªŒè¯ DNS

```bash
# æ£€æŸ¥å‰ç«¯åŸŸå
ping edm.sendwalk.com

# æ£€æŸ¥ API åŸŸå
ping api.sendwalk.com

# æˆ–ä½¿ç”¨ nslookup
nslookup edm.sendwalk.com
nslookup api.sendwalk.com
```

### 3. éƒ¨ç½²ä»£ç 

æŒ‰ç…§æ­£å¸¸æµç¨‹éƒ¨ç½²ä»£ç åˆ° `/data/www/sendwalk`ã€‚

### 4. é…ç½®åç«¯ç¯å¢ƒå˜é‡

```bash
cd /data/www/sendwalk/backend
cp /data/www/sendwalk/config.env.production.example .env

# ç¼–è¾‘ .env æ–‡ä»¶
nano .env
```

ç¡®ä¿ä»¥ä¸‹é…ç½®æ­£ç¡®ï¼š

```bash
APP_URL=https://edm.sendwalk.com
FRONTEND_URL=https://edm.sendwalk.com
SANCTUM_STATEFUL_DOMAINS=edm.sendwalk.com
SESSION_DOMAIN=.edm.sendwalk.com
```

### 5. é…ç½®å‰ç«¯ç¯å¢ƒå˜é‡

```bash
cd /data/www/sendwalk/frontend

# åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®
cat > .env.production << 'EOF'
VITE_API_URL=https://api.sendwalk.com
VITE_APP_NAME=SendWalk
EOF

# æˆ–è€…ç¼–è¾‘ .env æ–‡ä»¶
nano .env
```

å†…å®¹ï¼š

```bash
VITE_API_URL=https://api.sendwalk.com
VITE_APP_NAME=SendWalk
```

### 6. é‡æ–°æ„å»ºå‰ç«¯

```bash
cd /data/www/sendwalk/frontend
npm run build
```

### 7. é…ç½® Nginx

```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶åˆ° conf.d ç›®å½•
sudo cp /data/www/sendwalk/nginx/api.conf /etc/nginx/conf.d/sendwalk-api.conf
sudo cp /data/www/sendwalk/nginx/frontend.conf /etc/nginx/conf.d/sendwalk-frontend.conf

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

### 8. é…ç½® SSL è¯ä¹¦

#### âœ… ä½¿ç”¨å·²æœ‰çš„ Cloudflare è¯ä¹¦ï¼ˆæ¨èï¼‰

æœ¬é¡¹ç›®å·²é…ç½®ä½¿ç”¨ Cloudflare ç”Ÿæˆçš„è¯ä¹¦ï¼š

```bash
# è¯ä¹¦æ–‡ä»¶ä½ç½®
/data/www/ca/sendwalk.pem   # è¯ä¹¦æ–‡ä»¶
/data/www/ca/sendwalk.key   # ç§é’¥æ–‡ä»¶

# ç¡®è®¤è¯ä¹¦æ–‡ä»¶å­˜åœ¨
ls -lh /data/www/ca/sendwalk.pem
ls -lh /data/www/ca/sendwalk.key

# è®¾ç½®æ­£ç¡®çš„æƒé™
sudo chown root:root /data/www/ca/sendwalk.*
sudo chmod 644 /data/www/ca/sendwalk.pem
sudo chmod 600 /data/www/ca/sendwalk.key

# Nginx é…ç½®å·²åŒ…å« SSL è®¾ç½®ï¼Œç›´æ¥é‡å¯å³å¯
sudo nginx -t
sudo systemctl restart nginx
```

> ğŸ’¡ **è¯´æ˜**: Nginx é…ç½®æ–‡ä»¶å·²ç»åŒ…å«å®Œæ•´çš„ SSL é…ç½®ï¼ŒåŒ…æ‹¬ï¼š
> - HTTPS ç›‘å¬ï¼ˆ443 ç«¯å£ï¼‰
> - SSL è¯ä¹¦è·¯å¾„
> - å®‰å…¨çš„ TLS åè®®å’ŒåŠ å¯†å¥—ä»¶
> - HTTP åˆ° HTTPS è‡ªåŠ¨é‡å®šå‘
> - å®‰å…¨å¤´ï¼ˆHSTSã€X-Frame-Options ç­‰ï¼‰

è¯¦ç»†çš„ SSL é…ç½®è¯´æ˜è¯·æŸ¥çœ‹ï¼š[SSLè¯ä¹¦é…ç½®è¯´æ˜.md](./SSLè¯ä¹¦é…ç½®è¯´æ˜.md)

#### æˆ–è€…ï¼šä½¿ç”¨ Let's Encryptï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰

å¦‚æœè¦ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦ï¼š

```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx

# ç”³è¯·è¯ä¹¦ï¼ˆä¼šè‡ªåŠ¨ä¿®æ”¹ Nginx é…ç½®ï¼‰
sudo certbot --nginx -d edm.sendwalk.com
sudo certbot --nginx -d api.sendwalk.com
```

> âš ï¸ **æ³¨æ„**: ä½¿ç”¨ Let's Encrypt ä¼šè¦†ç›– Nginx é…ç½®ä¸­çš„ SSL è®¾ç½®ã€‚

### 9. éªŒè¯éƒ¨ç½²

```bash
# æµ‹è¯•å‰ç«¯ï¼ˆHTTPï¼‰
curl -I http://edm.sendwalk.com

# æµ‹è¯•å‰ç«¯ï¼ˆHTTPSï¼‰
curl -I https://edm.sendwalk.com

# æµ‹è¯• APIï¼ˆHTTPï¼‰
curl http://api.sendwalk.com/api/health

# æµ‹è¯• APIï¼ˆHTTPSï¼‰
curl https://api.sendwalk.com/api/health
```

### 10. æµè§ˆå™¨æµ‹è¯•

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š

- å‰ç«¯ï¼š`https://edm.sendwalk.com`
- API å¥åº·æ£€æŸ¥ï¼š`https://api.sendwalk.com/api/health`

## ğŸ”§ SSL è¯ä¹¦é…ç½®è¯¦è§£

### è‡ªåŠ¨é…ç½®ï¼ˆæ¨èï¼‰

```bash
# Certbot ä¼šè‡ªåŠ¨é…ç½® SSL å’Œ HTTP åˆ° HTTPS çš„é‡å®šå‘
sudo certbot --nginx -d edm.sendwalk.com
sudo certbot --nginx -d api.sendwalk.com
```

### æ‰‹åŠ¨é…ç½®

å¦‚æœéœ€è¦æ‰‹åŠ¨é…ç½®ï¼ŒNginx SSL é…ç½®ç¤ºä¾‹ï¼š

```nginx
server {
    listen 443 ssl http2;
    server_name edm.sendwalk.com;
    
    ssl_certificate /etc/letsencrypt/live/edm.sendwalk.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/edm.sendwalk.com/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # å…¶ä»–é…ç½®...
}

# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name edm.sendwalk.com;
    return 301 https://$server_name$request_uri;
}
```

### è¯ä¹¦è‡ªåŠ¨ç»­æœŸ

Let's Encrypt è¯ä¹¦æœ‰æ•ˆæœŸ 90 å¤©ï¼ŒCertbot ä¼šè‡ªåŠ¨åˆ›å»ºç»­æœŸä»»åŠ¡ï¼š

```bash
# æ£€æŸ¥è‡ªåŠ¨ç»­æœŸé…ç½®
sudo systemctl status certbot.timer

# æµ‹è¯•ç»­æœŸï¼ˆä¸ä¼šçœŸæ­£ç»­æœŸï¼‰
sudo certbot renew --dry-run

# æ‰‹åŠ¨ç»­æœŸ
sudo certbot renew
```

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šåŸŸåæ— æ³•è®¿é—®

**æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥ DNS æ˜¯å¦ç”Ÿæ•ˆ
nslookup edm.sendwalk.com
nslookup api.sendwalk.com

# æ£€æŸ¥ Nginx é…ç½®
sudo nginx -t

# æ£€æŸ¥ Nginx æ˜¯å¦è¿è¡Œ
sudo systemctl status nginx
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç­‰å¾… DNS ç”Ÿæ•ˆ
- æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦å¼€æ”¾ 80/443 ç«¯å£
- æ£€æŸ¥ Nginx é…ç½®æ˜¯å¦æ­£ç¡®

### é—®é¢˜ 2ï¼šå‰ç«¯å¯ä»¥è®¿é—®ï¼Œä½†æ— æ³•è°ƒç”¨ API

**æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥ API æ˜¯å¦å¯è®¿é—®
curl https://api.sendwalk.com/api/health

# æ£€æŸ¥å‰ç«¯é…ç½®
cat /data/www/sendwalk/frontend/dist/assets/*.js | grep -o 'api\.edm\.sendwalk\.com'
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥å‰ç«¯ `.env` ä¸­çš„ `VITE_API_URL`
- é‡æ–°æ„å»ºå‰ç«¯ï¼š`npm run build`
- æ£€æŸ¥åç«¯ CORS é…ç½®

### é—®é¢˜ 3ï¼šCORS é”™è¯¯

**æ£€æŸ¥åç«¯é…ç½®**ï¼š
```bash
cd /data/www/sendwalk/backend
grep -E "FRONTEND_URL|SANCTUM|SESSION" .env
```

åº”è¯¥åŒ…å«ï¼š
```bash
FRONTEND_URL=https://edm.sendwalk.com
SANCTUM_STATEFUL_DOMAINS=edm.sendwalk.com
SESSION_DOMAIN=.edm.sendwalk.com
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ›´æ–°é…ç½®åæ¸…é™¤ç¼“å­˜
php artisan config:clear
php artisan config:cache

# é‡å¯ PHP-FPM
sudo systemctl restart php8.3-fpm
```

### é—®é¢˜ 4ï¼šSSL è¯ä¹¦é”™è¯¯

**æ£€æŸ¥è¯ä¹¦**ï¼š
```bash
# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
sudo certbot certificates

# æŸ¥çœ‹è¯ä¹¦è¯¦æƒ…
openssl x509 -in /etc/letsencrypt/live/edm.sendwalk.com/fullchain.pem -text -noout
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# é‡æ–°ç”³è¯·è¯ä¹¦
sudo certbot certonly --nginx -d edm.sendwalk.com
sudo certbot certonly --nginx -d api.sendwalk.com

# é‡å¯ Nginx
sudo systemctl restart nginx
```

## ğŸ“Š è®¿é—®åœ°å€æ±‡æ€»

| æœåŠ¡ | HTTP | HTTPS | è¯´æ˜ |
|------|------|-------|------|
| å‰ç«¯ | http://edm.sendwalk.com | https://edm.sendwalk.com | ä¸»åº”ç”¨ |
| API | http://api.sendwalk.com | https://api.sendwalk.com | API æ¥å£ |
| API å¥åº·æ£€æŸ¥ | - | https://api.sendwalk.com/api/health | æ£€æŸ¥ API çŠ¶æ€ |

## ğŸ” å®‰å…¨å»ºè®®

### 1. å¼ºåˆ¶ HTTPS

é…ç½® Nginx å°†æ‰€æœ‰ HTTP è¯·æ±‚é‡å®šå‘åˆ° HTTPSï¼ˆCertbot ä¼šè‡ªåŠ¨é…ç½®ï¼‰ã€‚

### 2. HSTS å¤´

åœ¨ Nginx SSL é…ç½®ä¸­æ·»åŠ ï¼š

```nginx
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
```

### 3. å®‰å…¨å¤´

```nginx
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;
```

### 4. éšè—ç‰ˆæœ¬ä¿¡æ¯

```nginx
# åœ¨ nginx.conf çš„ http å—ä¸­æ·»åŠ 
server_tokens off;
```

## âœ… é…ç½®æ£€æŸ¥æ¸…å•

éƒ¨ç½²å®Œæˆåï¼Œç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] DNS è®°å½•å·²æ·»åŠ ï¼ˆedm.sendwalk.com å’Œ api.sendwalk.comï¼‰
- [ ] DNS å·²ç”Ÿæ•ˆï¼ˆå¯ä»¥ ping é€šï¼‰
- [ ] åç«¯ .env é…ç½®æ­£ç¡®ï¼ˆAPP_URLã€FRONTEND_URL ç­‰ï¼‰
- [ ] å‰ç«¯ .env é…ç½®æ­£ç¡®ï¼ˆVITE_API_URLï¼‰
- [ ] å‰ç«¯å·²é‡æ–°æ„å»ºï¼ˆnpm run buildï¼‰
- [ ] Nginx é…ç½®å·²æ›´æ–°å¹¶é‡å¯
- [ ] SSL è¯ä¹¦å·²ç”³è¯·å¹¶é…ç½®
- [ ] HTTP è®¿é—®å¯ä»¥æ­£å¸¸é‡å®šå‘åˆ° HTTPS
- [ ] å‰ç«¯é¡µé¢å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] API å¯ä»¥æ­£å¸¸è®¿é—®ï¼ˆæµ‹è¯• /api/healthï¼‰
- [ ] å‰ç«¯å¯ä»¥æ­£å¸¸è°ƒç”¨ APIï¼ˆæ—  CORS é”™è¯¯ï¼‰
- [ ] å¯ä»¥æ­£å¸¸ç™»å½•å’Œä½¿ç”¨åŠŸèƒ½

## ğŸ“ å¿«é€Ÿé…ç½®å‘½ä»¤

```bash
# 1. é…ç½®åç«¯
cd /data/www/sendwalk/backend
cp ../config.env.production.example .env
sed -i 's|APP_URL=.*|APP_URL=https://edm.sendwalk.com|' .env
sed -i 's|FRONTEND_URL=.*|FRONTEND_URL=https://edm.sendwalk.com|' .env
sed -i 's|SANCTUM_STATEFUL_DOMAINS=.*|SANCTUM_STATEFUL_DOMAINS=edm.sendwalk.com|' .env
sed -i 's|SESSION_DOMAIN=.*|SESSION_DOMAIN=.edm.sendwalk.com|' .env

# 2. é…ç½®å‰ç«¯
cd /data/www/sendwalk/frontend
echo "VITE_API_URL=https://api.sendwalk.com" > .env
echo "VITE_APP_NAME=SendWalk" >> .env

# 3. é‡æ–°æ„å»ºå‰ç«¯
npm run build

# 4. é…ç½® Nginx
sudo cp /data/www/sendwalk/nginx/api.conf /etc/nginx/conf.d/sendwalk-api.conf
sudo cp /data/www/sendwalk/nginx/frontend.conf /etc/nginx/conf.d/sendwalk-frontend.conf
sudo nginx -t && sudo systemctl restart nginx

# 5. é…ç½® SSL
sudo certbot --nginx -d edm.sendwalk.com
sudo certbot --nginx -d api.sendwalk.com

# 6. æ¸…é™¤ç¼“å­˜
cd /data/www/sendwalk/backend
php artisan config:clear
php artisan config:cache

# 7. æµ‹è¯•
curl https://edm.sendwalk.com
curl https://api.sendwalk.com/api/health
```

---

**åŸŸåé…ç½®å®Œæˆï¼** âœ…

ç°åœ¨æ‚¨çš„ SendWalk åº”ç”¨å°†é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š
- å‰ç«¯ï¼šhttps://edm.sendwalk.com
- APIï¼šhttps://api.sendwalk.com

