# 邮件列表性能优化 - 快速开始

## 🚀 一键部署

```bash
./optimize-lists-performance.sh
```

就这么简单！脚本会自动：
- ✅ 运行数据库迁移
- ✅ 重新计算所有计数
- ✅ 清除应用缓存

## 📊 预期效果

**页面加载时间：7-8 秒 → < 1 秒**

## 🧪 测试性能

```bash
export TOKEN='your-bearer-token'
./test-lists-performance.sh
```

## 📖 详细文档

- **技术详情**: 查看 `邮件列表性能优化说明.md`
- **完整总结**: 查看 `OPTIMIZATION_SUMMARY.md`

## ⚠️ 重要提示

1. **生产环境部署前请先备份数据库**
2. **建议先在测试环境验证**
3. **部署后检查计数是否正确**

## 🔧 手动部署

如果自动脚本失败，可以手动执行：

```bash
cd backend
php artisan migrate --force
php artisan lists:recalculate-counts
php artisan cache:clear
```

## 📝 技术原理

**问题**: 每次加载列表页面都要实时统计订阅者数量，导致大量 JOIN 查询

**解决**: 使用缓存计数器 + 观察者模式自动维护，将复杂查询变为简单字段读取

## 🎯 优化内容

1. ✅ 添加 `unsubscribed_count` 缓存字段
2. ✅ 创建 `ListSubscriber` Pivot 模型
3. ✅ 创建 `ListSubscriberObserver` 自动维护计数
4. ✅ 优化 API 查询，使用缓存字段
5. ✅ 提供数据修复命令

## 💡 常见问题

### Q: 计数不准确怎么办？
A: 运行修复命令：
```bash
cd backend
php artisan lists:recalculate-counts
```

### Q: 如何回滚？
A: 查看 `OPTIMIZATION_SUMMARY.md` 中的回滚方案

### Q: 会影响现有功能吗？
A: 不会，这是透明升级，现有代码无需修改

## 📞 需要帮助？

查看日志文件：`backend/storage/logs/laravel.log`

