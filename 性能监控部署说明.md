# æ€§èƒ½ç›‘æ§éƒ¨ç½²è¯´æ˜

## âœ… å·²å®Œæˆçš„æ”¹è¿›

### 1. **è¯¦ç»†çš„æ€§èƒ½æ—¥å¿—** âœ…
åœ¨å¯¼å…¥è¿›åº¦æŸ¥è¯¢çš„æ¯ä¸ªæ­¥éª¤éƒ½æ·»åŠ äº†ç²¾ç¡®çš„è€—æ—¶è®°å½•ï¼š

**SubscriberController** å’Œ **BlacklistController** çš„ `getImportProgress()` æ–¹æ³•ï¼š
- âœ… è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
- âœ… è®°å½•ç¼“å­˜æŸ¥è¯¢è€—æ—¶
- âœ… è®°å½•å“åº”æ„å»ºè€—æ—¶
- âœ… è®°å½•æ€»è€—æ—¶
- âœ… æ…¢è¯·æ±‚è­¦å‘Šï¼ˆ>1ç§’ï¼‰
- âœ… ææ…¢è¯·æ±‚è­¦å‘Šï¼ˆ>5ç§’ï¼‰

### 2. **è¯Šæ–­å·¥å…·** âœ…
åˆ›å»ºäº†å¤šä¸ªè¯Šæ–­è„šæœ¬ï¼š

- **`diagnose-import-performance.sh`** - äº¤äº’å¼è¯Šæ–­å·¥å…·ï¼ˆ7ä¸ªé€‰é¡¹ï¼‰
- **`ç«‹å³è¯Šæ–­å¯¼å…¥æ€§èƒ½.sh`** - ä¸€é”®å¼€å§‹å®æ—¶ç›‘æ§
- **`å¯¼å…¥æ€§èƒ½è¯Šæ–­æŒ‡å—.md`** - è¯¦ç»†çš„è¯Šæ–­æ–‡æ¡£

---

## ğŸš€ ç«‹å³å¼€å§‹è¯Šæ–­

### æ–¹æ³•1ï¼šä¸€é”®è¯Šæ–­ï¼ˆæ¨èï¼‰â­

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š
```bash
cd /data/www/sendwalk
git pull
./ç«‹å³è¯Šæ–­å¯¼å…¥æ€§èƒ½.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. âœ… æ‹‰å–æœ€æ–°ä»£ç 
2. âœ… æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆPHP-FPMã€Nginxã€Redisã€MySQLï¼‰
3. âœ… æ¸…ç©ºæ—§æ—¥å¿—ï¼ˆå¤‡ä»½åï¼‰
4. âœ… å¼€å§‹å®æ—¶ç›‘æ§
5. âœ… å½©è‰²è¾“å‡ºæ€§èƒ½æŒ‡æ ‡

**ç„¶ååœ¨æµè§ˆå™¨ä¸­å¼€å§‹å¯¼å…¥ï¼Œå®æ—¶è§‚å¯Ÿæ—¥å¿—è¾“å‡ºã€‚**

---

### æ–¹æ³•2ï¼šäº¤äº’å¼è¯Šæ–­

```bash
cd /data/www/sendwalk
git pull
./diagnose-import-performance.sh
```

**é€‰é¡¹è¯´æ˜**ï¼š
1. **å®æ—¶ç›‘æ§æ€§èƒ½æ—¥å¿—** - æŸ¥çœ‹æ‰€æœ‰æ€§èƒ½æ—¥å¿—
2. **æŸ¥çœ‹æ…¢è¯·æ±‚** - æ‰¾å‡ºè€—æ—¶>1ç§’çš„è¯·æ±‚
3. **æŸ¥çœ‹ææ…¢è¯·æ±‚** - æ‰¾å‡ºè€—æ—¶>5ç§’çš„è¯·æ±‚
4. **å¯¼å…¥è¯·æ±‚ç»Ÿè®¡** - æ€»æ•°ã€å¹³å‡è€—æ—¶
5. **PHP-FPMçŠ¶æ€** - è¿›ç¨‹æ•°ã€å†…å­˜
6. **Nginxè¿æ¥æ•°** - è¿æ¥ç»Ÿè®¡
7. **å…¨é¢æ€§èƒ½æŠ¥å‘Š** - ç»¼åˆè¯Šæ–­

---

### æ–¹æ³•3ï¼šç›´æ¥æŸ¥çœ‹æ—¥å¿—

```bash
cd /data/www/sendwalk/backend
tail -f storage/logs/laravel.log | grep "\[æ€§èƒ½\]"
```

---

## ğŸ“Š æ€§èƒ½æ—¥å¿—ç¤ºä¾‹

### æ­£å¸¸è¯·æ±‚ï¼ˆå¥åº·ï¼‰
```json
[æ€§èƒ½] å¼€å§‹å¤„ç†å¯¼å…¥è¿›åº¦è¯·æ±‚
{
  "request_id": "req_6764abc",
  "import_id": "uuid-xxxx",
  "timestamp": "2025-12-26T10:30:15"
}

[æ€§èƒ½] ç¼“å­˜æŸ¥è¯¢å®Œæˆ
{
  "request_id": "req_6764abc",
  "duration_ms": 2.5,
  "progress_found": true,
  "progress_status": "processing",
  "progress_percent": 45
}

[æ€§èƒ½] è¯·æ±‚å¤„ç†å®Œæˆ
{
  "request_id": "req_6764abc",
  "cache_duration_ms": 2.5,
  "response_duration_ms": 1.8,
  "total_duration_ms": 5.2,
  "progress_status": "processing"
}
```

### æœ‰é—®é¢˜çš„è¯·æ±‚
```json
[æ€§èƒ½] è¯·æ±‚å¤„ç†å®Œæˆ
{
  "request_id": "req_6764xyz",
  "cache_duration_ms": 245.8,     // ğŸš¨ ç¼“å­˜æŸ¥è¯¢æ…¢
  "response_duration_ms": 1523.2,  // ğŸš¨ å“åº”æ„å»ºæ…¢
  "total_duration_ms": 1825.7,    // ğŸš¨ æ€»è€—æ—¶è¶…è¿‡1ç§’
  "progress_status": "processing"
}

[æ€§èƒ½] æ…¢è¯·æ±‚è­¦å‘Š
{
  "request_id": "req_6764xyz",
  "duration_ms": 1825.7,
  "threshold_ms": 1000
}
```

---

## ğŸ” è¯Šæ–­æµç¨‹

### Step 1: éƒ¨ç½²æ€§èƒ½ç›‘æ§
```bash
cd /data/www/sendwalk
git pull
```

### Step 2: å¼€å§‹ç›‘æ§
```bash
./ç«‹å³è¯Šæ–­å¯¼å…¥æ€§èƒ½.sh
```

### Step 3: è§¦å‘å¯¼å…¥
åœ¨æµè§ˆå™¨ä¸­å¼€å§‹å¯¼å…¥è®¢é˜…è€…æˆ–é»‘åå•

### Step 4: è§‚å¯Ÿæ—¥å¿—

#### åœºæ™¯Aï¼šæ—¥å¿—æ­£å¸¸è¾“å‡ºï¼Œè€—æ—¶åˆç†ï¼ˆ<100msï¼‰
âœ… **ç³»ç»Ÿæ­£å¸¸**ï¼Œé—®é¢˜å¯èƒ½åœ¨å‰ç«¯æˆ–ç½‘ç»œ

**æ£€æŸ¥**ï¼š
- æµè§ˆå™¨Networké¢æ¿æŸ¥çœ‹è¯·æ±‚æ—¶é—´
- æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
- æ£€æŸ¥Cloudflareæˆ–CDNé…ç½®

#### åœºæ™¯Bï¼šæ—¥å¿—å»¶è¿Ÿå¾ˆä¹…æ‰å‡ºç°
ğŸš¨ **PHP-FPMè¿›ç¨‹ä¸è¶³æˆ–é˜»å¡**

**è§£å†³**ï¼š
1. æ£€æŸ¥PHP-FPMè¿›ç¨‹æ•°ï¼š`ps aux | grep php-fpm | wc -l`
2. å¢åŠ è¿›ç¨‹æ•°ï¼ˆè§ä¸‹æ–¹é…ç½®ä¼˜åŒ–ï¼‰
3. é‡å¯PHP-FPMï¼š`sudo systemctl restart php8.2-fpm`

#### åœºæ™¯Cï¼šæ—¥å¿—æ˜¾ç¤ºè€—æ—¶å¾ˆé•¿ï¼ˆ>1ç§’ï¼‰
ğŸš¨ **æœåŠ¡å™¨èµ„æºé—®é¢˜æˆ–é…ç½®é—®é¢˜**

**æ£€æŸ¥**ï¼š
- `cache_duration_ms` è¿‡å¤§ â†’ Redisé—®é¢˜
- `response_duration_ms` è¿‡å¤§ â†’ PHPä»£ç é—®é¢˜
- `total_duration_ms` è¿‡å¤§ â†’ ç»¼åˆé—®é¢˜

---

## ğŸ”§ å¸¸è§é—®é¢˜ä¿®å¤

### é—®é¢˜1ï¼šPHP-FPMè¿›ç¨‹ä¸è¶³

**ç¼–è¾‘é…ç½®**ï¼š
```bash
sudo nano /etc/php/8.2/fpm/pool.d/www.conf
```

**ä¿®æ”¹**ï¼š
```ini
pm = dynamic
pm.max_children = 20       # å¢åŠ æœ€å¤§è¿›ç¨‹æ•°
pm.start_servers = 5
pm.min_spare_servers = 3
pm.max_spare_servers = 8
```

**é‡å¯**ï¼š
```bash
sudo systemctl restart php8.2-fpm
```

---

### é—®é¢˜2ï¼šRedisç¼“å­˜æ…¢

**æ£€æŸ¥Redis**ï¼š
```bash
redis-cli ping
redis-cli info stats
```

**é‡å¯Redis**ï¼š
```bash
sudo systemctl restart redis
```

---

### é—®é¢˜3ï¼šæ•°æ®åº“è¿æ¥è€—å°½

**æ£€æŸ¥è¿æ¥**ï¼š
```bash
mysql -u root -p -e "SHOW PROCESSLIST;"
```

**å¢åŠ è¿æ¥æ•°**ï¼š
```bash
mysql -u root -p
SET GLOBAL max_connections = 200;
```

---

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

| æŒ‡æ ‡ | ä¼˜ç§€ | è‰¯å¥½ | éœ€ä¼˜åŒ– |
|------|------|------|--------|
| **æ€»è€—æ—¶** | < 50ms | 50-100ms | > 100ms |
| **ç¼“å­˜æŸ¥è¯¢** | < 10ms | 10-50ms | > 50ms |
| **å“åº”æ„å»º** | < 5ms | 5-20ms | > 20ms |

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶
1. `backend/app/Http/Controllers/Api/SubscriberController.php` - æ·»åŠ æ€§èƒ½æ—¥å¿—
2. `backend/app/Http/Controllers/Api/BlacklistController.php` - æ·»åŠ æ€§èƒ½æ—¥å¿—

### æ–°å¢çš„æ–‡ä»¶
1. `diagnose-import-performance.sh` - äº¤äº’å¼è¯Šæ–­å·¥å…·
2. `ç«‹å³è¯Šæ–­å¯¼å…¥æ€§èƒ½.sh` - ä¸€é”®è¯Šæ–­è„šæœ¬
3. `å¯¼å…¥æ€§èƒ½è¯Šæ–­æŒ‡å—.md` - è¯¦ç»†æ–‡æ¡£
4. `æ€§èƒ½ç›‘æ§éƒ¨ç½²è¯´æ˜.md` - æœ¬æ–‡ä»¶

### åˆ›å»ºä½†æœªä½¿ç”¨çš„æ–‡ä»¶
- `backend/app/Http/Middleware/PerformanceLogger.php` - æ€§èƒ½æ—¥å¿—ä¸­é—´ä»¶ï¼ˆå¤‡ç”¨ï¼‰

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### æ—¥å¸¸ç›‘æ§
```bash
# æ¯å¤©æŸ¥çœ‹ä¸€æ¬¡æ€§èƒ½æŠ¥å‘Š
cd /data/www/sendwalk
./diagnose-import-performance.sh
# é€‰æ‹© 7ï¼ˆå…¨é¢æ€§èƒ½æŠ¥å‘Šï¼‰
```

### é—®é¢˜æ’æŸ¥
```bash
# å½“ç”¨æˆ·æŠ¥å‘Šå¯¼å…¥æ…¢æ—¶
./ç«‹å³è¯Šæ–­å¯¼å…¥æ€§èƒ½.sh
# è®©ç”¨æˆ·é‡æ–°å¯¼å…¥ï¼Œå®æ—¶è§‚å¯Ÿæ—¥å¿—
```

### æ€§èƒ½ä¼˜åŒ–
```bash
# æŸ¥çœ‹æœ€è¿‘çš„æ…¢è¯·æ±‚
./diagnose-import-performance.sh
# é€‰æ‹© 2ï¼ˆæŸ¥çœ‹æ…¢è¯·æ±‚ï¼‰

# æ ¹æ®æ—¥å¿—ä¸­çš„ç“¶é¢ˆè¿›è¡Œä¼˜åŒ–
```

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### éƒ¨ç½²åä½ èƒ½çœ‹åˆ°ï¼š
1. âœ… æ¯ä¸ªè¯·æ±‚çš„ç²¾ç¡®è€—æ—¶ï¼ˆæ¯«ç§’çº§ï¼‰
2. âœ… è¯·æ±‚çš„å„ä¸ªé˜¶æ®µè€—æ—¶ï¼ˆç¼“å­˜ã€å“åº”ã€æ€»è®¡ï¼‰
3. âœ… å®æ—¶çš„æ€§èƒ½è­¦å‘Šï¼ˆæ…¢è¯·æ±‚ï¼‰
4. âœ… è¯·æ±‚çš„å¤„ç†çŠ¶æ€
5. âœ… å½©è‰²çš„å®æ—¶ç›‘æ§è¾“å‡º

### ä½ èƒ½å‘ç°ï¼š
- ğŸ” è¯·æ±‚æ˜¯å¦åˆ°è¾¾åç«¯
- ğŸ” è¯·æ±‚åœ¨å“ªä¸ªç¯èŠ‚è€—æ—¶æœ€å¤š
- ğŸ” æ˜¯å¦æœ‰è¯·æ±‚ç§¯å‹
- ğŸ” ç³»ç»Ÿèµ„æºæ˜¯å¦å……è¶³
- ğŸ” å…·ä½“çš„æ€§èƒ½ç“¶é¢ˆåœ¨å“ªé‡Œ

---

## ğŸ“ ä¸‹ä¸€æ­¥

1. **ç«‹å³éƒ¨ç½²**ï¼š
   ```bash
   cd /data/www/sendwalk
   git pull
   ./ç«‹å³è¯Šæ–­å¯¼å…¥æ€§èƒ½.sh
   ```

2. **å¼€å§‹å¯¼å…¥**ï¼šåœ¨æµè§ˆå™¨ä¸­è§¦å‘å¯¼å…¥

3. **è§‚å¯Ÿæ—¥å¿—**ï¼šæŸ¥çœ‹å®æ—¶è¾“å‡ºï¼Œæ‰¾å‡ºé—®é¢˜æ‰€åœ¨

4. **åé¦ˆç»“æœ**ï¼šå‘Šè¯‰æˆ‘çœ‹åˆ°äº†ä»€ä¹ˆï¼Œæˆ‘ä¼šå¸®ä½ è¿›ä¸€æ­¥åˆ†æ

---

**åˆ›å»ºæ—¥æœŸ**: 2025-12-26  
**ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… å·²éƒ¨ç½²ï¼Œç«‹å³å¯ç”¨

