# 黑名单导入失败排查指南

## 🐛 问题现象

- ✅ 前端显示导入完成
- ❌ 实际数据库中没有数据
- 进度条正常跑完

## 🔍 可能的原因

### 原因 1: 队列服务未运行 ⭐️ 最常见

**症状**：
- 进度显示 100%
- 日志显示"创建导入任务"
- 但没有"导入完成"日志
- 数据库无数据

**诊断**：
```bash
# 检查队列进程
ps aux | grep "queue:work"

# 如果没有输出，说明队列未运行
```

**解决**：
```bash
# 方案 1: 配置 Supervisor（推荐）
cd /data/www/sendwalk
sudo ./setup-queue-worker.sh

# 方案 2: 临时运行（测试）
cd /data/www/sendwalk/backend
nohup php artisan queue:work > storage/logs/queue.log 2>&1 &

# 方案 3: 前台运行（看到实时输出）
cd /data/www/sendwalk/backend
php artisan queue:work
```

### 原因 2: 文件权限问题

**症状**：
- 日志显示"Permission denied"
- 无法创建临时文件

**诊断**：
```bash
cd /data/www/sendwalk/backend
ls -la storage/app/

# 检查所有者和权限
```

**解决**：
```bash
cd /data/www/sendwalk
./fix-storage-permissions.sh
```

### 原因 3: Job 执行失败

**症状**：
- 队列正在运行
- 但任务执行失败
- 在失败任务表中

**诊断**：
```bash
cd /data/www/sendwalk/backend

# 查看失败的任务
php artisan queue:failed

# 查看错误日志
tail -50 storage/logs/laravel.log | grep ERROR
```

**解决**：
```bash
# 查看具体错误信息
php artisan queue:failed

# 如果是可恢复的错误，重试
php artisan queue:retry all

# 如果问题已修复，清空失败任务
php artisan queue:flush
```

### 原因 4: 数据库连接问题

**症状**：
- 队列运行正常
- 日志显示数据库错误

**诊断**：
```bash
cd /data/www/sendwalk/backend

# 测试数据库连接
php artisan tinker
>>> DB::connection()->getPdo();
>>> DB::table('blacklist')->count();
```

**解决**：
检查 `.env` 文件中的数据库配置：
```bash
nano .env

# 确认以下配置正确
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=sendwalk
DB_USERNAME=root
DB_PASSWORD=your_password
```

### 原因 5: 缓存驱动问题

**症状**：
- 进度查询返回 404
- 前端无法获取进度

**诊断**：
```bash
cd /data/www/sendwalk/backend

# 检查缓存驱动
php artisan tinker
>>> config('cache.default');

# 如果是 Redis，检查 Redis
redis-cli ping
```

**解决**：
```bash
# 清理缓存
php artisan cache:clear

# 如果 Redis 有问题，改用文件缓存
# 修改 .env
CACHE_DRIVER=file

# 重启队列
sudo supervisorctl restart laravel-worker:*
```

## 🛠️ 快速诊断

### 步骤 1: 运行诊断脚本

```bash
cd /data/www/sendwalk
./diagnose-blacklist-import.sh
```

这个脚本会自动检查：
- ✅ 队列服务状态
- ✅ 文件权限
- ✅ 日志错误
- ✅ 数据库连接
- ✅ 失败任务

### 步骤 2: 根据输出采取行动

**如果显示"队列服务未运行"**：
```bash
# 立即启动队列
cd /data/www/sendwalk
sudo ./setup-queue-worker.sh
```

**如果显示"权限错误"**：
```bash
cd /data/www/sendwalk
./fix-storage-permissions.sh
```

**如果显示"有失败任务"**：
```bash
cd /data/www/sendwalk/backend

# 查看失败原因
php artisan queue:failed

# 重试失败任务
php artisan queue:retry all
```

## 📊 完整排查流程

### 1. 检查队列服务

```bash
# 方法 1: 使用 Supervisor
sudo supervisorctl status laravel-worker:*

# 方法 2: 检查进程
ps aux | grep "queue:work"

# 方法 3: 检查日志
tail -f /data/www/sendwalk/backend/storage/logs/worker.log
```

**预期结果**：应该看到 2 个 queue:work 进程

### 2. 测试手动导入

```bash
cd /data/www/sendwalk/backend

# 创建测试文件
echo "test@example.com" > /tmp/test.txt

# 手动触发导入（使用 tinker）
php artisan tinker
```

在 tinker 中执行：
```php
$userId = 1; // 你的用户 ID
$importId = \Illuminate\Support\Str::uuid()->toString();
$filePath = '/tmp/test.txt';
$reason = '测试';

// 手动执行 Job
$job = new \App\Jobs\ImportBlacklist($filePath, $userId, $reason, $importId);
$job->handle();

// 检查结果
DB::table('blacklist')->where('email', 'test@example.com')->count();
```

如果这里能成功，说明代码没问题，是队列服务的问题。

### 3. 实时监控导入过程

**终端 1 - 监控日志**：
```bash
tail -f /data/www/sendwalk/backend/storage/logs/laravel.log | grep "黑名单"
```

**终端 2 - 监控队列**：
```bash
watch -n 1 'ps aux | grep queue:work | grep -v grep'
```

**终端 3 - 在网页上传文件**

应该看到：
```
[2025-12-25 12:00:00] local.INFO: 创建黑名单导入任务 {"import_id":"xxx",...}
[2025-12-25 12:00:01] local.INFO: 黑名单导入 - 检测文件格式 {...}
[2025-12-25 12:00:05] local.INFO: 黑名单导入完成 {"added":100,...}
```

### 4. 检查数据库

```bash
mysql -u root -p sendwalk

-- 检查导入前的数量
SELECT COUNT(*) FROM blacklist;

-- 上传文件后再次检查
SELECT COUNT(*) FROM blacklist;

-- 查看最新导入的数据
SELECT * FROM blacklist ORDER BY created_at DESC LIMIT 10;
```

## 🎯 常见场景及解决方案

### 场景 1: 首次部署

```bash
# 1. 配置队列服务
cd /data/www/sendwalk
sudo ./setup-queue-worker.sh

# 2. 修复权限
./fix-storage-permissions.sh

# 3. 测试上传
# 在网页上传小文件

# 4. 监控日志
tail -f backend/storage/logs/laravel.log
```

### 场景 2: 之前能用，突然不能用了

```bash
# 1. 检查队列是否崩溃
sudo supervisorctl status

# 2. 重启队列
sudo supervisorctl restart laravel-worker:*

# 3. 清理失败任务
cd /data/www/sendwalk/backend
php artisan queue:retry all

# 4. 清理缓存
php artisan cache:clear
```

### 场景 3: 代码更新后不工作

```bash
# 1. 重启队列（加载新代码）
sudo supervisorctl restart laravel-worker:*

# 2. 清理缓存
cd /data/www/sendwalk/backend
php artisan cache:clear
php artisan config:clear

# 3. 检查日志
tail -f storage/logs/laravel.log
```

## 🔧 快速修复命令

```bash
# 一键修复（大部分情况）
cd /data/www/sendwalk
sudo ./setup-queue-worker.sh && \
./fix-storage-permissions.sh && \
cd backend && \
php artisan cache:clear && \
php artisan queue:retry all

# 验证
sudo supervisorctl status && \
ps aux | grep "queue:work"
```

## 📝 验证清单

导入前确认：

- [ ] 队列服务正在运行
- [ ] storage 目录权限正确
- [ ] 数据库连接正常
- [ ] 缓存驱动正常
- [ ] 没有失败的任务

导入后检查：

- [ ] 日志中有"创建导入任务"
- [ ] 日志中有"导入完成"
- [ ] 数据库中有新数据
- [ ] 前端显示正确的统计数字

## 🚨 紧急恢复

如果队列服务崩溃且无法启动：

```bash
# 1. 停止所有队列进程
pkill -f "queue:work"

# 2. 清理失败任务
cd /data/www/sendwalk/backend
php artisan queue:flush

# 3. 手动处理一个任务测试
php artisan queue:work --once

# 4. 如果成功，重启 Supervisor
sudo supervisorctl restart laravel-worker:*
```

## 📞 仍然无法解决？

1. **收集信息**：
   ```bash
   cd /data/www/sendwalk
   ./diagnose-blacklist-import.sh > diagnosis.txt
   ```

2. **查看完整日志**：
   ```bash
   tail -100 backend/storage/logs/laravel.log
   ```

3. **检查系统资源**：
   ```bash
   free -h  # 内存
   df -h    # 磁盘
   ```

4. **重启所有服务**（最后手段）：
   ```bash
   sudo systemctl restart php8.3-fpm
   sudo systemctl restart nginx
   sudo supervisorctl restart all
   ```

## 🎯 成功标志

当一切正常时，你会看到：

```
# Supervisor 状态
sudo supervisorctl status
laravel-worker:laravel-worker_00   RUNNING   pid 12345, uptime 0:10:00
laravel-worker:laravel-worker_01   RUNNING   pid 12346, uptime 0:10:00

# 上传文件后，日志显示
tail -f backend/storage/logs/laravel.log
[INFO] 创建黑名单导入任务
[INFO] 黑名单导入 - 检测文件格式
[INFO] 黑名单导入完成 {"added":100,...}

# 数据库有新数据
mysql> SELECT COUNT(*) FROM blacklist;
+----------+
| COUNT(*) |
+----------+
|      100 |
+----------+
```

这就是完全正常的状态！🎉

