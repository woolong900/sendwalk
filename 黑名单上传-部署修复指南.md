# é»‘åå•æ‰¹é‡ä¸Šä¼  - éƒ¨ç½²ä¿®å¤æŒ‡å—

## âŒ æŠ¥é”™åŸå› 

```
mkdir(): Permission denied at /data/www/sendwalk/backend/app/Http/Controllers/Api/BlacklistController.php
```

**åŸå› **ï¼šLaravel æ²¡æœ‰æƒé™åœ¨ `storage/app/` ç›®å½•ä¸‹åˆ›å»º `blacklist_imports` æ–‡ä»¶å¤¹ã€‚

## âœ… è§£å†³æ–¹æ¡ˆï¼ˆ2ç§ï¼‰

### æ–¹æ¡ˆ 1: ä¸€é”®ä¿®å¤ï¼ˆæ¨èï¼‰â­ï¸

åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œä¿®å¤è„šæœ¬ï¼š

```bash
# 1. SSH åˆ°æœåŠ¡å™¨
ssh root@your-server

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /data/www/sendwalk

# 3. æ‹‰å–æœ€æ–°ä»£ç ï¼ˆåŒ…å«ä¿®å¤ï¼‰
git pull

# 4. è¿è¡Œä¿®å¤è„šæœ¬
./fix-storage-permissions.sh

# 5. æµ‹è¯•ä¸Šä¼ 
# ç°åœ¨å¯ä»¥åœ¨ç½‘é¡µä¸Šæµ‹è¯•ä¸Šä¼ åŠŸèƒ½äº†
```

### æ–¹æ¡ˆ 2: æ‰‹åŠ¨ä¿®å¤

```bash
# SSH åˆ°æœåŠ¡å™¨
ssh root@your-server
cd /data/www/sendwalk/backend

# 1. ä¿®å¤ storage ç›®å½•æƒé™
sudo chown -R www-data:www-data storage
sudo chown -R www-data:www-data bootstrap/cache
sudo chmod -R 775 storage
sudo chmod -R 775 bootstrap/cache

# 2. åˆ›å»ºå¿…è¦çš„ç›®å½•
sudo -u www-data mkdir -p storage/app/blacklist_imports
sudo -u www-data mkdir -p storage/app/imports

# 3. éªŒè¯æƒé™
ls -la storage/app/

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
# drwxrwxr-x 2 www-data www-data 4096 Dec 25 11:20 blacklist_imports
# drwxrwxr-x 2 www-data www-data 4096 Dec 25 11:20 imports
```

## ğŸ”§ ä»£ç ä¿®å¤è¯´æ˜

å·²å°†ä»£ç ä»æ‰‹åŠ¨åˆ›å»ºç›®å½•ï¼š

```php
// âŒ æ—§ä»£ç ï¼ˆä¼šæŠ¥æƒé™é”™è¯¯ï¼‰
$tempPath = storage_path('app/blacklist_imports/' . $importId . '.txt');
$directory = dirname($tempPath);
if (!is_dir($directory)) {
    mkdir($directory, 0755, true);  // â† è¿™é‡Œä¼šæŠ¥é”™
}
$file->move($directory, basename($tempPath));
```

æ”¹ä¸ºä½¿ç”¨ Laravel Storageï¼š

```php
// âœ… æ–°ä»£ç ï¼ˆè‡ªåŠ¨å¤„ç†æƒé™ï¼‰
$path = $file->storeAs('blacklist_imports', $importId . '.txt');
$tempPath = storage_path('app/' . $path);
```

**ä¼˜åŠ¿**ï¼š
- âœ… Laravel Storage è‡ªåŠ¨å¤„ç†ç›®å½•åˆ›å»º
- âœ… è‡ªåŠ¨å¤„ç†æƒé™é—®é¢˜
- âœ… æ›´ç¬¦åˆ Laravel æœ€ä½³å®è·µ

## ğŸ“‹ å®Œæ•´éƒ¨ç½²æ­¥éª¤

```bash
# 1. SSH åˆ°æœåŠ¡å™¨
ssh root@your-server

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /data/www/sendwalk

# 3. åœæ­¢é˜Ÿåˆ—ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
sudo supervisorctl stop laravel-worker:*

# 4. æ‹‰å–æœ€æ–°ä»£ç 
git pull

# 5. ä¿®å¤æƒé™
./fix-storage-permissions.sh

# 6. é‡æ–°æ„å»ºå‰ç«¯
cd frontend
npm run build

# 7. æ¸…ç†ç¼“å­˜
cd ../backend
php artisan cache:clear
php artisan config:clear
php artisan view:clear

# 8. é‡å¯é˜Ÿåˆ—
sudo supervisorctl start laravel-worker:*

# 9. é‡å¯ PHP-FPMï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo systemctl restart php8.3-fpm

# 10. æµ‹è¯•ä¸Šä¼ 
echo "è®¿é—®é»‘åå•é¡µé¢ï¼Œæµ‹è¯•æ‰¹é‡ä¸Šä¼ åŠŸèƒ½"
```

## ğŸ§ª éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥æƒé™

```bash
cd /data/www/sendwalk/backend
ls -la storage/app/

# åº”è¯¥çœ‹åˆ°ï¼š
# drwxrwxr-x  2 www-data www-data  4096 Dec 25 11:20 blacklist_imports
# drwxrwxr-x  2 www-data www-data  4096 Dec 25 11:20 imports
```

### 2. æµ‹è¯•å°æ–‡ä»¶ä¸Šä¼ 

åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼š

```bash
# ç”Ÿæˆ 100 æ¡æµ‹è¯•æ•°æ®
for i in {1..100}; do echo "test${i}@example.com"; done > /tmp/test_blacklist.txt
```

ç„¶ååœ¨ç½‘é¡µä¸Šï¼š
1. æ‰“å¼€é»‘åå•é¡µé¢
2. ç‚¹å‡»"æ‰¹é‡ä¸Šä¼ "
3. é€‰æ‹© `/tmp/test_blacklist.txt`
4. ç‚¹å‡»"å¼€å§‹å¯¼å…¥"

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
- âœ… è¿›åº¦æ¡æ˜¾ç¤º
- âœ… æ˜¾ç¤º"æ–°å¢ 100 ä¸ª"

### 3. æ£€æŸ¥æ—¥å¿—

```bash
tail -f /data/www/sendwalk/backend/storage/logs/laravel.log

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
# [2025-12-25 11:25:00] local.INFO: åˆ›å»ºé»‘åå•å¯¼å…¥ä»»åŠ¡ {"import_id":"xxx",...}
# [2025-12-25 11:25:01] local.INFO: é»‘åå•å¯¼å…¥ - æ£€æµ‹æ–‡ä»¶æ ¼å¼ {...}
# [2025-12-25 11:25:05] local.INFO: é»‘åå•å¯¼å…¥å®Œæˆ {"added":100,...}
```

### 4. æ£€æŸ¥é˜Ÿåˆ—

```bash
# æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
php artisan queue:work --once

# æˆ–è€…æŒç»­ç›‘æ§
tail -f storage/logs/laravel.log | grep "é»‘åå•å¯¼å…¥"
```

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ä»ç„¶æŠ¥æƒé™é”™è¯¯ï¼Ÿ

**æ£€æŸ¥ PHP-FPM è¿è¡Œç”¨æˆ·**ï¼š

```bash
ps aux | grep php-fpm

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
# www-data 12345 ... php-fpm: pool www
```

å¦‚æœä¸æ˜¯ `www-data`ï¼Œä¿®æ”¹æ‰€æœ‰è€…ï¼š

```bash
# å‡è®¾æ˜¯ nginx
sudo chown -R nginx:nginx storage
sudo chown -R nginx:nginx bootstrap/cache
```

### Q2: ä¸Šä¼ åæ‰¾ä¸åˆ°æ–‡ä»¶ï¼Ÿ

**æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åˆ›å»º**ï¼š

```bash
ls -la storage/app/blacklist_imports/

# åº”è¯¥çœ‹åˆ° UUID æ ¼å¼çš„æ–‡ä»¶
# -rw-rw-r-- 1 www-data www-data 3000 Dec 25 11:25 550e8400-e29b-41d4-a716-446655440000.txt
```

### Q3: é˜Ÿåˆ—æ²¡æœ‰å¤„ç†ï¼Ÿ

**æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦è¿è¡Œ**ï¼š

```bash
# æŸ¥çœ‹ Supervisor çŠ¶æ€
sudo supervisorctl status

# å¦‚æœæ²¡æœ‰è¿è¡Œï¼Œå¯åŠ¨å®ƒ
sudo supervisorctl start laravel-worker:*

# æˆ–è€…æ‰‹åŠ¨è¿è¡Œæµ‹è¯•
cd /data/www/sendwalk/backend
php artisan queue:work --once
```

### Q4: æ–‡ä»¶ä¸Šä¼ æˆåŠŸä½†è¿›åº¦ä¸æ›´æ–°ï¼Ÿ

**æ£€æŸ¥ Redis/ç¼“å­˜**ï¼š

```bash
redis-cli
> KEYS blacklist_import:*
> GET blacklist_import:{import_id}
```

å¦‚æœæ²¡æœ‰ Redisï¼Œæ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ–‡ä»¶ç¼“å­˜ï¼š

```bash
ls -la storage/framework/cache/data/
```

## ğŸ“ æƒé™é…ç½®æœ€ä½³å®è·µ

### Laravel æ ‡å‡†æƒé™

```bash
# ç›®å½•æ‰€æœ‰è€…
sudo chown -R www-data:www-data /data/www/sendwalk/backend

# ç›®å½•æƒé™
sudo find /data/www/sendwalk/backend -type d -exec chmod 755 {} \;

# æ–‡ä»¶æƒé™
sudo find /data/www/sendwalk/backend -type f -exec chmod 644 {} \;

# Storage å’Œ Bootstrap/cache éœ€è¦å†™æƒé™
sudo chmod -R 775 /data/www/sendwalk/backend/storage
sudo chmod -R 775 /data/www/sendwalk/backend/bootstrap/cache

# å¦‚æœä½ çš„ç”¨æˆ·ä¹Ÿéœ€è¦è®¿é—®ï¼ˆå¦‚ deployerï¼‰
sudo usermod -a -G www-data deployer
```

### Nginx é…ç½®

ç¡®ä¿ Nginx ä½¿ç”¨ `www-data` ç”¨æˆ·ï¼š

```nginx
# /etc/nginx/nginx.conf
user www-data;
```

### PHP-FPM é…ç½®

ç¡®ä¿ PHP-FPM ä½¿ç”¨ `www-data` ç”¨æˆ·ï¼š

```ini
; /etc/php/8.3/fpm/pool.d/www.conf
user = www-data
group = www-data
```

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ä»£ç å·²æ‹‰å–æœ€æ–°ç‰ˆæœ¬
- [ ] storage ç›®å½•æƒé™æ­£ç¡®ï¼ˆ775ï¼‰
- [ ] storage æ‰€æœ‰è€…æ­£ç¡®ï¼ˆwww-dataï¼‰
- [ ] blacklist_imports ç›®å½•å·²åˆ›å»º
- [ ] PHP-FPM å·²é‡å¯
- [ ] é˜Ÿåˆ—æœåŠ¡æ­£åœ¨è¿è¡Œ
- [ ] å‰ç«¯å·²é‡æ–°æ„å»º
- [ ] æµ‹è¯•å°æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
- [ ] æ—¥å¿—ä¸­æ— é”™è¯¯ä¿¡æ¯

## ğŸ¯ éªŒè¯æˆåŠŸæ ‡å‡†

è¿è¡Œæµ‹è¯•ä¸Šä¼ åï¼Œåº”è¯¥çœ‹åˆ°ï¼š

1. **æµè§ˆå™¨**ï¼š
   - âœ… è¿›åº¦æ¡ä» 0% åˆ° 100%
   - âœ… æ˜¾ç¤º"æ–°å¢ X ä¸ª"
   - âœ… 3ç§’åè‡ªåŠ¨å…³é—­å¯¹è¯æ¡†

2. **æ—¥å¿—**ï¼š
   ```
   [INFO] åˆ›å»ºé»‘åå•å¯¼å…¥ä»»åŠ¡
   [INFO] é»‘åå•å¯¼å…¥ - æ£€æµ‹æ–‡ä»¶æ ¼å¼
   [INFO] é»‘åå•å¯¼å…¥å®Œæˆ
   ```

3. **æ•°æ®åº“**ï¼š
   ```sql
   SELECT COUNT(*) FROM blacklists WHERE created_at > NOW() - INTERVAL 1 HOUR;
   -- åº”è¯¥æ˜¾ç¤ºåˆšæ‰ä¸Šä¼ çš„æ•°é‡
   ```

4. **æ–‡ä»¶ç³»ç»Ÿ**ï¼š
   ```bash
   ls -la storage/app/blacklist_imports/
   # åº”è¯¥ä¸ºç©ºï¼ˆæ–‡ä»¶å·²è‡ªåŠ¨åˆ é™¤ï¼‰
   ```

å¦‚æœä»¥ä¸Š 4 ç‚¹éƒ½æ»¡è¶³ï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸï¼ğŸ‰

## ğŸš€ æµ‹è¯• 200 ä¸‡æ•°æ®

ç¡®è®¤å°æ–‡ä»¶æµ‹è¯•æˆåŠŸåï¼Œå¯ä»¥æµ‹è¯•å¤§æ–‡ä»¶ï¼š

```bash
# ç”Ÿæˆ 200 ä¸‡æ¡æµ‹è¯•æ•°æ®
seq 1 2000000 | awk '{print "test"$1"@example.com"}' > /tmp/blacklist_2m.txt

# æ–‡ä»¶å¤§å°çº¦ 60-70 MB
ls -lh /tmp/blacklist_2m.txt
```

ç„¶ååœ¨ç½‘é¡µä¸Šä¼ ï¼Œé¢„æœŸï¼š
- âœ… ä¸Šä¼ æ—¶é—´ï¼š~10ç§’
- âœ… å¤„ç†æ—¶é—´ï¼š3-5åˆ†é’Ÿ
- âœ… æµè§ˆå™¨ä¸å¡é¡¿
- âœ… å¯ä»¥ç¦»å¼€é¡µé¢

---

**å¿«é€Ÿå‘½ä»¤å‚è€ƒ**ï¼š

```bash
# ä¸€é”®ä¿®å¤
cd /data/www/sendwalk && git pull && ./fix-storage-permissions.sh

# æ‰‹åŠ¨ä¿®å¤
cd /data/www/sendwalk/backend && \
sudo chown -R www-data:www-data storage && \
sudo chmod -R 775 storage && \
sudo -u www-data mkdir -p storage/app/blacklist_imports

# éªŒè¯
ls -la storage/app/ && \
tail -f storage/logs/laravel.log
```

