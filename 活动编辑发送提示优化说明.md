# 活动编辑发送提示优化说明

## 🐛 问题描述

当用户在活动编辑页面修改活动内容后，点击"立即发送"或"定时发送"时，会出现两个提示：

1. **第一个提示**："活动已更新" ✅
2. **第二个提示**："活动已加入发送队列" ✅

用户认为：
- 修改活动时，只是修改活动的内容，不应该提示"活动已加入发送队列"
- 只有后台的定时任务才会将活动加入队列
- **期望行为**：修改并发送时，只显示一个提示，比如"活动已加入发送队列"或"活动已定时发送"

## 🔍 问题原因

### 代码流程分析

在 `frontend/src/pages/campaigns/editor.tsx` 中：

#### 1. `handleSendNow` 方法（立即发送）

```typescript
const handleSendNow = async () => {
  if (!id) {
    toast.error('请先保存活动')
    return
  }
  
  // 先保存修改
  try {
    if (isEditing) {
      await saveMutation.mutateAsync(formData) // ← 这里会触发第一个提示
    }
    
    sendMutation.mutate({ campaignId: parseInt(id) }) // ← 这里会触发第二个提示
  } catch (error) {
    console.error('保存失败:', error)
  }
}
```

#### 2. `saveMutation` 的 `onSuccess` 回调

```typescript
onSuccess: (response) => {
  // ...
  toast.success(isEditing ? '活动已更新' : '活动已保存为草稿') // ← 第一个提示
  navigate('/campaigns')
}
```

#### 3. `sendMutation` 的 `onSuccess` 回调

```typescript
onSuccess: (_, variables) => {
  queryClient.invalidateQueries({ queryKey: ['campaigns'] })
  if (variables.scheduledAt) {
    toast.success('活动已定时发送') // ← 第二个提示（定时发送）
  } else {
    toast.success('活动已加入发送队列') // ← 第二个提示（立即发送）
  }
  navigate('/campaigns')
}
```

### 问题根源

当用户在编辑页面修改活动后点击"立即发送"时：
1. 先调用 `saveMutation.mutateAsync(formData)` 保存活动
2. 保存成功后，`saveMutation` 的 `onSuccess` 触发，显示"活动已更新"
3. 然后调用 `sendMutation.mutate` 发送活动
4. 发送成功后，`sendMutation` 的 `onSuccess` 触发，显示"活动已加入发送队列"

结果：用户看到两个提示 ❌

## ✅ 解决方案

### 核心思路

使用一个状态标志 `isSaveBeforeSend` 来标记当前是否是"保存后发送"操作：
- 如果是"保存后发送"，则跳过保存成功的提示
- 只显示最终的发送成功提示

### 代码修改

#### 1. 添加状态标志

```typescript
const [isSaveBeforeSend, setIsSaveBeforeSend] = useState(false) // 标记是否是"保存后发送"操作
```

#### 2. 修改 `saveMutation` 的 `onSuccess`

```typescript
onSuccess: (response) => {
  // 刷新列表页缓存
  queryClient.invalidateQueries({ queryKey: ['campaigns'] })
  
  // 刷新当前活动的缓存（如果是编辑模式）
  if (isEditing && id) {
    queryClient.invalidateQueries({ queryKey: ['campaign', id] })
  }
  
  // ✅ 如果是"保存后发送"操作，不显示提示（由 sendMutation 统一提示）
  if (isSaveBeforeSend) {
    setIsSaveBeforeSend(false)
    return // ← 提前返回，不显示保存成功提示
  }
  
  // 如果是创建新活动且选择了发送，则自动发送
  if (!isEditing && sendMode !== 'draft') {
    // ...
  } else {
    toast.success(isEditing ? '活动已更新' : '活动已保存为草稿')
    navigate('/campaigns')
  }
}
```

#### 3. 修改 `handleSendNow` 方法

```typescript
const handleSendNow = async () => {
  if (!id) {
    toast.error('请先保存活动')
    return
  }
  
  // 先保存修改
  try {
    if (isEditing) {
      setIsSaveBeforeSend(true) // ✅ 标记为"保存后发送"，不显示保存成功提示
      await saveMutation.mutateAsync(formData)
    }
    
    sendMutation.mutate({ campaignId: parseInt(id) })
  } catch (error) {
    // 保存失败，不继续发送
    setIsSaveBeforeSend(false) // ✅ 重置标志
    console.error('保存失败:', error)
  }
}
```

#### 4. 修改 `handleScheduleSend` 方法

```typescript
const handleScheduleSend = async () => {
  if (!id) {
    toast.error('请先保存活动')
    return
  }
  if (!scheduledDateTime) {
    toast.error('请选择发送日期和时间')
    return
  }

  // 先保存修改
  try {
    if (isEditing) {
      setIsSaveBeforeSend(true) // ✅ 标记为"保存后发送"，不显示保存成功提示
      await saveMutation.mutateAsync(formData)
    }
    
    const scheduledAt = format(scheduledDateTime, 'yyyy-MM-dd HH:mm:ss')
    sendMutation.mutate({ campaignId: parseInt(id), scheduledAt })
    setIsSendDialogOpen(false)
  } catch (error) {
    // 保存失败，不继续定时发送
    setIsSaveBeforeSend(false) // ✅ 重置标志
    console.error('保存失败:', error)
  }
}
```

## 🎯 优化效果

### 优化前 ❌

**场景 1: 编辑活动后立即发送**
```
用户修改活动内容
    ↓
点击"立即发送"按钮
    ↓
提示 1: "活动已更新" 📢
    ↓
提示 2: "活动已加入发送队列" 📢
    ↓
跳转到活动列表
```
❌ **问题**: 两个提示，用户困惑

**场景 2: 编辑活动后定时发送**
```
用户修改活动内容
    ↓
点击"定时发送"按钮
    ↓
提示 1: "活动已更新" 📢
    ↓
提示 2: "活动已定时发送" 📢
    ↓
跳转到活动列表
```
❌ **问题**: 两个提示，用户困惑

### 优化后 ✅

**场景 1: 编辑活动后立即发送**
```
用户修改活动内容
    ↓
点击"立即发送"按钮
    ↓
保存活动（静默）
    ↓
提示: "活动已加入发送队列" 📢
    ↓
跳转到活动列表
```
✅ **效果**: 只有一个提示，清晰明了

**场景 2: 编辑活动后定时发送**
```
用户修改活动内容
    ↓
点击"定时发送"按钮
    ↓
保存活动（静默）
    ↓
提示: "活动已定时发送" 📢
    ↓
跳转到活动列表
```
✅ **效果**: 只有一个提示，清晰明了

**场景 3: 只保存活动（草稿）**
```
用户修改活动内容
    ↓
点击"保存"按钮
    ↓
提示: "活动已更新" 📢
    ↓
跳转到活动列表
```
✅ **效果**: 保持原有的保存提示

## 📊 各种操作的提示对比

| 操作 | 优化前 | 优化后 |
|------|--------|--------|
| 创建新活动 + 保存为草稿 | "活动已保存为草稿" | "活动已保存为草稿" ✅ |
| 创建新活动 + 立即发送 | "活动已加入发送队列" | "活动已加入发送队列" ✅ |
| 创建新活动 + 定时发送 | "活动已定时发送" | "活动已定时发送" ✅ |
| 编辑活动 + 保存 | "活动已更新" | "活动已更新" ✅ |
| 编辑活动 + 立即发送 | "活动已更新" + "活动已加入发送队列" ❌ | "活动已加入发送队列" ✅ |
| 编辑活动 + 定时发送 | "活动已更新" + "活动已定时发送" ❌ | "活动已定时发送" ✅ |

## 🧪 测试步骤

### 1. 测试编辑活动 + 立即发送

```bash
1. 打开浏览器，访问活动列表页面
2. 选择一个草稿状态的活动，点击"编辑"按钮
3. 修改活动的任意内容（比如标题、主题等）
4. 点击页面右上角的"立即发送"按钮
5. 确认发送

✅ 预期结果:
- 只显示一个提示: "活动已加入发送队列"
- 不显示"活动已更新"提示
- 跳转到活动列表页面
```

### 2. 测试编辑活动 + 定时发送

```bash
1. 打开浏览器，访问活动列表页面
2. 选择一个草稿状态的活动，点击"编辑"按钮
3. 修改活动的任意内容
4. 点击页面右上角的"定时发送"按钮
5. 选择发送时间
6. 确认发送

✅ 预期结果:
- 只显示一个提示: "活动已定时发送"
- 不显示"活动已更新"提示
- 跳转到活动列表页面
```

### 3. 测试编辑活动 + 仅保存

```bash
1. 打开浏览器，访问活动列表页面
2. 选择一个草稿状态的活动，点击"编辑"按钮
3. 修改活动的任意内容
4. 点击页面底部的"保存为草稿"按钮

✅ 预期结果:
- 显示提示: "活动已更新"
- 跳转到活动列表页面
```

### 4. 测试创建新活动 + 立即发送

```bash
1. 打开浏览器，访问活动列表页面
2. 点击"创建活动"按钮
3. 填写活动信息
4. 选择"立即发送"
5. 点击"创建并发送"按钮

✅ 预期结果:
- 只显示一个提示: "活动已加入发送队列"
- 不显示"活动已保存为草稿"提示
- 跳转到活动列表页面
```

## 🔧 技术细节

### 状态标志的生命周期

```typescript
// 初始状态
const [isSaveBeforeSend, setIsSaveBeforeSend] = useState(false)

// 在"保存后发送"操作中
handleSendNow() {
  setIsSaveBeforeSend(true)  // ← 设置标志
  await saveMutation.mutateAsync(formData)
  // saveMutation.onSuccess 检测到标志，不显示提示
  sendMutation.mutate({ campaignId: parseInt(id) })
}

// saveMutation.onSuccess 中
onSuccess: (response) => {
  if (isSaveBeforeSend) {
    setIsSaveBeforeSend(false)  // ← 重置标志
    return  // ← 提前返回，不显示提示
  }
  // ...
}

// 如果保存失败
catch (error) {
  setIsSaveBeforeSend(false)  // ← 重置标志
  console.error('保存失败:', error)
}
```

### 为什么不使用全局变量或 ref？

1. **useState** ✅
   - 组件级别的状态
   - React 会跟踪状态变化
   - 在 `onSuccess` 回调中能正确访问最新值
   - 符合 React 的最佳实践

2. **useRef** ❌
   - 虽然可以工作，但不符合 React 最佳实践
   - 修改 ref 不会触发重新渲染
   - 不利于调试

3. **全局变量** ❌
   - 会导致多个组件实例之间的状态混乱
   - 不符合 React 的数据流原则

## 📝 注意事项

1. **不影响其他操作**: 只有"编辑活动 + 立即/定时发送"才会跳过保存提示，其他操作（创建新活动、仅保存）的提示保持不变。

2. **错误处理**: 如果保存失败，会重置 `isSaveBeforeSend` 标志，确保下次操作不受影响。

3. **状态重置**: 在 `saveMutation.onSuccess` 中会重置 `isSaveBeforeSend` 标志，防止影响后续操作。

## 🚀 部署步骤

```bash
# 1. 进入前端目录
cd /data/www/sendwalk/frontend

# 2. 构建前端
npm run build

# 3. 重载 Nginx
sudo nginx -t
sudo nginx -s reload
```

## ✅ 验证

访问活动编辑页面，测试以下场景：
1. ✅ 编辑活动 + 立即发送 → 只显示"活动已加入发送队列"
2. ✅ 编辑活动 + 定时发送 → 只显示"活动已定时发送"
3. ✅ 编辑活动 + 保存 → 显示"活动已更新"
4. ✅ 创建新活动 + 立即发送 → 只显示"活动已加入发送队列"
5. ✅ 创建新活动 + 保存为草稿 → 显示"活动已保存为草稿"

---

**修复完成！** 现在用户在编辑活动后发送时，只会看到一个清晰的提示，不再有重复的提示信息。

