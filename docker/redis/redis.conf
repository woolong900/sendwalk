# Redis 持久化配置（推荐用于生产环境）

# ==================== AOF 持久化配置 ====================
# AOF (Append Only File) - 记录每个写操作，数据最安全
appendonly yes
appendfilename "appendonly.aof"

# AOF 同步策略（三选一）
# 1. always - 每次写操作都同步（最安全，性能最低）
# 2. everysec - 每秒同步一次（推荐，平衡性能和安全）
# 3. no - 由操作系统决定何时同步（性能最高，可能丢失较多数据）
appendfsync everysec

# AOF 重写配置
# 当 AOF 文件增长到一定大小时，自动重写以压缩文件
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF 重写时不同步（避免重写时阻塞）
no-appendfsync-on-rewrite no

# AOF 加载时错误处理
aof-load-truncated yes

# ==================== RDB 快照配置 ====================
# RDB (Redis Database) - 定期保存数据快照
# 格式：save <seconds> <changes>
# 含义：在 seconds 秒内，如果至少有 changes 个 key 发生变化，则保存快照

save 900 1        # 15分钟内至少1个key变化
save 300 10       # 5分钟内至少10个key变化
save 60 10000     # 1分钟内至少10000个key变化

# RDB 文件名
dbfilename dump.rdb

# RDB 和 AOF 文件保存目录
dir /data

# RDB 保存失败时停止写入（防止数据不一致）
stop-writes-on-bgsave-error yes

# RDB 文件压缩
rdbcompression yes

# RDB 文件校验
rdbchecksum yes

# ==================== 内存管理 ====================
# 最大内存限制（根据服务器配置调整）
maxmemory 2gb

# 内存淘汰策略
# - allkeys-lru: 所有key使用LRU算法淘汰
# - volatile-lru: 只淘汰设置了过期时间的key（推荐用于队列）
# - noeviction: 不淘汰，内存满时返回错误
maxmemory-policy volatile-lru

# ==================== 日志配置 ====================
# 日志级别：debug, verbose, notice, warning
loglevel notice

# 日志文件
logfile /var/log/redis/redis.log

# ==================== 网络配置 ====================
# 绑定地址（生产环境建议指定具体IP）
bind 0.0.0.0

# 监听端口
port 6379

# 超时时间（秒，0表示不超时）
timeout 300

# TCP keepalive
tcp-keepalive 300

# ==================== 安全配置 ====================
# 密码保护（生产环境必须设置）
# requirepass your_strong_password_here

# 禁用危险命令
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""
# rename-command CONFIG ""

# ==================== 性能优化 ====================
# 数据库数量
databases 16

# 客户端输出缓冲区限制
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# 后台保存子进程优先级
# 范围 -20 到 19，值越小优先级越高
# 建议设置为 5，避免影响主进程
set-proc-title yes
proc-title-template "{title} {listen-addr} {server-mode}"

