# åˆ—è¡¨åˆ†æ®µåŠŸèƒ½æ¸…ç†è¯´æ˜

## ğŸ“‹ èƒŒæ™¯

åˆ—è¡¨åˆ†æ®µï¼ˆSegmentsï¼‰åŠŸèƒ½åˆ›å»ºäº†æ•°æ®åº“è¡¨å’Œç›¸å…³æ–‡ä»¶ï¼Œä½†ä»æœªçœŸæ­£å®ç°ï¼š
- âœ… æ•°æ®åº“è¡¨ `segments` å­˜åœ¨ï¼ˆåªæœ‰ id å’Œ timestampsï¼Œæ— å®é™…å­—æ®µï¼‰
- âœ… æ¨¡å‹æ–‡ä»¶ `Segment.php` å­˜åœ¨ï¼ˆç©ºçš„ï¼‰
- âœ… æ§åˆ¶å™¨ `SegmentController.php` å­˜åœ¨ï¼ˆç©ºçš„ï¼‰
- âŒ å‰ç«¯æ²¡æœ‰å¯¹åº”é¡µé¢
- âŒ è·¯ç”±æœªæ³¨å†Œ
- âŒ æ²¡æœ‰å®é™…ä¸šåŠ¡é€»è¾‘

## ğŸ—‘ï¸ éœ€è¦æ¸…ç†çš„å†…å®¹

### 1. æ¨¡å‹æ–‡ä»¶
```
backend/app/Models/Segment.php
```

### 2. æ§åˆ¶å™¨æ–‡ä»¶
```
backend/app/Http/Controllers/Api/SegmentController.php
```

### 3. è¿ç§»æ–‡ä»¶
```
backend/database/migrations/2025_12_24_182329_create_segments_table.php
```

### 4. æ•°æ®åº“è¡¨
```sql
segments
```

## ğŸš€ æ¸…ç†æ­¥éª¤

### æ–¹æ³• 1: è‡ªåŠ¨æ¸…ç†ï¼ˆæ¨èï¼‰â­ï¸

```bash
# SSH åˆ°æœåŠ¡å™¨
ssh root@your-server
cd /data/www/sendwalk

# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# è¿è¡Œæ¸…ç†è„šæœ¬
./clean-unused-segment-files.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. âœ… åˆ é™¤ Segment æ¨¡å‹
2. âœ… åˆ é™¤ SegmentController
3. âœ… åˆ é™¤æ—§çš„è¿ç§»æ–‡ä»¶
4. âœ… è¿è¡Œæ–°è¿ç§»åˆ é™¤æ•°æ®åº“è¡¨
5. âœ… éªŒè¯æ¸…ç†ç»“æœ

### æ–¹æ³• 2: æ‰‹åŠ¨æ¸…ç†

#### æ­¥éª¤ 1: åˆ é™¤æ–‡ä»¶

```bash
cd /data/www/sendwalk

# åˆ é™¤æ¨¡å‹
rm backend/app/Models/Segment.php

# åˆ é™¤æ§åˆ¶å™¨
rm backend/app/Http/Controllers/Api/SegmentController.php

# åˆ é™¤æ—§çš„è¿ç§»
rm backend/database/migrations/2025_12_24_182329_create_segments_table.php
```

#### æ­¥éª¤ 2: åˆ é™¤æ•°æ®åº“è¡¨

```bash
cd backend

# è¿è¡Œè¿ç§»
php artisan migrate --path=database/migrations/2025_12_25_130000_remove_segments_table.php
```

æˆ–ç›´æ¥æ‰§è¡Œ SQLï¼š

```bash
mysql -u root -p sendwalk -e "DROP TABLE IF EXISTS segments;"
```

## ğŸ§ª éªŒè¯æ¸…ç†

### 1. æ£€æŸ¥æ–‡ä»¶å·²åˆ é™¤

```bash
cd /data/www/sendwalk/backend

# è¿™äº›å‘½ä»¤åº”è¯¥æ˜¾ç¤ºæ–‡ä»¶ä¸å­˜åœ¨
ls -l app/Models/Segment.php 2>/dev/null || echo "âœ“ Segment.php å·²åˆ é™¤"
ls -l app/Http/Controllers/Api/SegmentController.php 2>/dev/null || echo "âœ“ SegmentController.php å·²åˆ é™¤"
```

### 2. æ£€æŸ¥æ•°æ®åº“è¡¨å·²åˆ é™¤

```bash
mysql -u root -p sendwalk -e "SHOW TABLES LIKE 'segments';"
# åº”è¯¥è¿”å›ç©ºç»“æœ
```

æˆ–

```bash
mysql -u root -p sendwalk -e "
    SELECT COUNT(*) as table_exists 
    FROM information_schema.tables 
    WHERE table_schema = 'sendwalk' 
    AND table_name = 'segments';
"
# åº”è¯¥æ˜¾ç¤º 0
```

### 3. æ£€æŸ¥è¿ç§»è®°å½•

```bash
cd /data/www/sendwalk/backend

# æŸ¥çœ‹è¿ç§»å†å²
php artisan migrate:status

# åº”è¯¥çœ‹åˆ°ï¼š
# âœ“ 2025_12_25_130000_remove_segments_table ................... Ran
```

## ğŸ“Š æ¸…ç†å‰åå¯¹æ¯”

| é¡¹ç›® | æ¸…ç†å‰ | æ¸…ç†å |
|------|--------|--------|
| **Segment æ¨¡å‹** | âœ… å­˜åœ¨ï¼ˆç©ºï¼‰ | âŒ åˆ é™¤ |
| **SegmentController** | âœ… å­˜åœ¨ï¼ˆç©ºï¼‰ | âŒ åˆ é™¤ |
| **segments è¡¨** | âœ… å­˜åœ¨ï¼ˆç©ºï¼‰ | âŒ åˆ é™¤ |
| **create_segments_table è¿ç§»** | âœ… å­˜åœ¨ | âŒ åˆ é™¤ |
| **remove_segments_table è¿ç§»** | âŒ ä¸å­˜åœ¨ | âœ… æ–°å¢ |

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“å¤‡ä»½

è™½ç„¶ `segments` è¡¨æ˜¯ç©ºçš„ï¼Œä½†ä»å»ºè®®æ¸…ç†å‰å¤‡ä»½ï¼š

```bash
mysqldump -u root -p sendwalk segments > segments_backup.sql
```

### 2. è¿ç§»è®°å½•

åˆ é™¤æ—§çš„è¿ç§»æ–‡ä»¶åï¼Œ`migrations` è¡¨ä¸­ä»ä¼šæœ‰è®°å½•ï¼š

```sql
-- æŸ¥çœ‹
SELECT * FROM migrations WHERE migration LIKE '%segment%';

-- å¯ä»¥é€‰æ‹©åˆ é™¤è®°å½•ï¼ˆå¯é€‰ï¼‰
DELETE FROM migrations WHERE migration = '2025_12_24_182329_create_segments_table';
```

### 3. Git å†å²

æ–‡ä»¶åœ¨ Git ä¸­çš„å†å²è®°å½•ä¼šä¿ç•™ï¼Œå¦‚æœå°†æ¥éœ€è¦å¯ä»¥æ¢å¤ã€‚

## ğŸ¯ æ¸…ç†åŸå› 

1. **æœªå®ç°åŠŸèƒ½**ï¼š
   - Segment åŠŸèƒ½ä»æœªå®ç°
   - æ²¡æœ‰å‰ç«¯ç•Œé¢
   - æ²¡æœ‰ä¸šåŠ¡é€»è¾‘

2. **ç»´æŠ¤æˆæœ¬**ï¼š
   - ç©ºæ–‡ä»¶å’Œç©ºè¡¨å¢åŠ ç»´æŠ¤å¤æ‚åº¦
   - å®¹æ˜“å¼•èµ·æ··æ·†

3. **æ•°æ®åº“æ•´æ´**ï¼š
   - å‡å°‘ä¸å¿…è¦çš„è¡¨
   - æé«˜æ•°æ®åº“æ€§èƒ½

## ğŸ”® æœªæ¥å¦‚æœéœ€è¦åˆ†æ®µåŠŸèƒ½

å¦‚æœå°†æ¥éœ€è¦å®ç°åˆ—è¡¨åˆ†æ®µåŠŸèƒ½ï¼Œå»ºè®®ï¼š

### æ–¹æ¡ˆ 1: åŸºäºæ ‡ç­¾ï¼ˆTagsï¼‰

ä½¿ç”¨ç°æœ‰çš„ `tags` è¡¨å®ç°åˆ†æ®µï¼š
- âœ… å·²æœ‰è¡¨ç»“æ„
- âœ… å·²æœ‰å‰ç«¯ç•Œé¢
- âœ… å¯ä»¥å¿«é€Ÿå®ç°

### æ–¹æ¡ˆ 2: åŸºäºè‡ªå®šä¹‰å­—æ®µ

ä½¿ç”¨ subscribers è¡¨çš„ `custom_fields` å­—æ®µï¼š
- âœ… çµæ´»æ€§é«˜
- âœ… æ— éœ€é¢å¤–è¡¨
- âœ… æ”¯æŒåŠ¨æ€æ¡ä»¶

### æ–¹æ¡ˆ 3: é‡æ–°è®¾è®¡ Segments

å¦‚æœéœ€è¦ä¸“é—¨çš„åˆ†æ®µåŠŸèƒ½ï¼š
```sql
CREATE TABLE segments (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    list_id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    conditions JSON NOT NULL,  -- åˆ†æ®µæ¡ä»¶
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (list_id) REFERENCES lists(id)
);
```

## ğŸ“ æ¸…ç†æ¸…å•

æ‰§è¡Œæ¸…ç†åç¡®è®¤ï¼š

- [ ] Segment.php æ–‡ä»¶å·²åˆ é™¤
- [ ] SegmentController.php æ–‡ä»¶å·²åˆ é™¤
- [ ] create_segments_table.php è¿ç§»å·²åˆ é™¤
- [ ] segments æ•°æ®åº“è¡¨å·²åˆ é™¤
- [ ] remove_segments_table.php è¿ç§»å·²æ‰§è¡Œ
- [ ] è¿ç§»çŠ¶æ€æ˜¾ç¤ºæ­£å¸¸
- [ ] åº”ç”¨è¿è¡Œæ­£å¸¸ï¼ˆæ— é”™è¯¯ï¼‰
- [ ] å·²æäº¤åˆ° Git

## ğŸš€ å¿«é€Ÿæ¸…ç†å‘½ä»¤

```bash
# ä¸€é”®æ¸…ç†
cd /data/www/sendwalk && \
git pull && \
./clean-unused-segment-files.sh

# éªŒè¯
cd backend && \
php artisan migrate:status | grep segment && \
mysql -u root -p sendwalk -e "SHOW TABLES LIKE 'segments';"
```

## âœ… æ¸…ç†å®Œæˆæ ‡å¿—

æ¸…ç†æˆåŠŸåï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤åº”è¯¥çœ‹åˆ°ï¼š

```bash
# 1. æ–‡ä»¶ä¸å­˜åœ¨
$ ls backend/app/Models/Segment.php
ls: cannot access 'backend/app/Models/Segment.php': No such file or directory

# 2. è¡¨ä¸å­˜åœ¨
$ mysql -u root -p sendwalk -e "SHOW TABLES LIKE 'segments';"
Empty set (0.00 sec)

# 3. æ–°è¿ç§»å·²è¿è¡Œ
$ php artisan migrate:status | grep segment
    Ran  2025_12_25_130000_remove_segments_table
```

å®Œç¾ï¼æ•°æ®åº“å’Œä»£ç éƒ½æ›´æ•´æ´äº†ï¼ğŸ‰

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™æ¬¡æ¸…ç†ï¼š
- âœ… åˆ é™¤äº† 3 ä¸ªæœªä½¿ç”¨çš„æ–‡ä»¶
- âœ… åˆ é™¤äº† 1 ä¸ªç©ºçš„æ•°æ®åº“è¡¨
- âœ… å‡å°‘äº†ä»£ç ç»´æŠ¤æˆæœ¬
- âœ… æé«˜äº†é¡¹ç›®æ•´æ´åº¦

å¦‚æœå°†æ¥éœ€è¦åˆ—è¡¨åˆ†æ®µåŠŸèƒ½ï¼Œå¯ä»¥åŸºäºå®é™…éœ€æ±‚é‡æ–°è®¾è®¡å’Œå®ç°ï¼

