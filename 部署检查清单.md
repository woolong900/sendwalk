# é‚®ä»¶åˆ—è¡¨æ€§èƒ½ä¼˜åŒ– - éƒ¨ç½²æ£€æŸ¥æ¸…å•

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥

### ç¯å¢ƒå‡†å¤‡
- [ ] å·²åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- [ ] å·²å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
- [ ] å·²ç¡®è®¤æ•°æ®åº“ç‰ˆæœ¬å…¼å®¹ (MySQL 5.7+ / MariaDB 10.2+)
- [ ] å·²ç¡®è®¤ PHP ç‰ˆæœ¬ (8.1+)
- [ ] å·²ç¡®è®¤ Laravel ç‰ˆæœ¬ (10.x)

### ä»£ç æ£€æŸ¥
- [ ] æ‰€æœ‰æ–°æ–‡ä»¶å·²åˆ›å»º
  - [ ] `backend/database/migrations/2025_12_23_000001_add_unsubscribed_count_to_lists_table.php`
  - [ ] `backend/app/Models/ListSubscriber.php`
  - [ ] `backend/app/Observers/ListSubscriberObserver.php`
  - [ ] `backend/app/Console/Commands/RecalculateListCounts.php`
  - [ ] `optimize-lists-performance.sh`
- [ ] æ‰€æœ‰ä¿®æ”¹æ–‡ä»¶å·²æ›´æ–°
  - [ ] `backend/app/Http/Controllers/Api/ListController.php`
  - [ ] `backend/app/Models/MailingList.php`
  - [ ] `backend/app/Providers/AppServiceProvider.php`
  - [ ] `backend/app/Jobs/ImportSubscribers.php`
- [ ] æ²¡æœ‰è¯­æ³•é”™è¯¯
- [ ] æ²¡æœ‰ linter é”™è¯¯

### æƒé™æ£€æŸ¥
- [ ] éƒ¨ç½²è„šæœ¬æœ‰æ‰§è¡Œæƒé™ (`chmod +x optimize-lists-performance.sh`)
- [ ] æ•°æ®åº“ç”¨æˆ·æœ‰ ALTER TABLE æƒé™
- [ ] Laravel æœ‰å†™å…¥ storage ç›®å½•æƒé™

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. è¿›å…¥ç»´æŠ¤æ¨¡å¼ï¼ˆå¯é€‰ï¼Œæ¨èï¼‰
```bash
cd backend
php artisan down --message="ç³»ç»Ÿå‡çº§ä¸­ï¼Œé¢„è®¡5åˆ†é’Ÿ" --retry=60
```
- [ ] å·²è¿›å…¥ç»´æŠ¤æ¨¡å¼

### 2. æ‹‰å–æœ€æ–°ä»£ç 
```bash
git pull origin main
```
- [ ] ä»£ç å·²æ›´æ–°

### 3. è¿è¡Œä¼˜åŒ–è„šæœ¬
```bash
./optimize-lists-performance.sh
```
- [ ] è¿ç§»æ‰§è¡ŒæˆåŠŸ
- [ ] è®¡æ•°é‡æ–°è®¡ç®—å®Œæˆ
- [ ] ç¼“å­˜æ¸…é™¤æˆåŠŸ

### 4. é€€å‡ºç»´æŠ¤æ¨¡å¼
```bash
cd backend
php artisan up
```
- [ ] å·²é€€å‡ºç»´æŠ¤æ¨¡å¼

## âœ… éƒ¨ç½²åéªŒè¯

### åŠŸèƒ½æµ‹è¯•
- [ ] é‚®ä»¶åˆ—è¡¨é¡µé¢èƒ½æ­£å¸¸åŠ è½½
- [ ] åˆ—è¡¨æ˜¾ç¤ºçš„è®¢é˜…è€…æ•°é‡æ­£ç¡®
- [ ] åˆ—è¡¨æ˜¾ç¤ºçš„å–æ¶ˆè®¢é˜…æ•°é‡æ­£ç¡®
- [ ] å¯ä»¥æ­£å¸¸åˆ›å»ºæ–°åˆ—è¡¨
- [ ] å¯ä»¥æ­£å¸¸ç¼–è¾‘åˆ—è¡¨
- [ ] å¯ä»¥æ­£å¸¸åˆ é™¤åˆ—è¡¨

### è®¢é˜…è€…åŠŸèƒ½æµ‹è¯•
- [ ] å¯ä»¥æ·»åŠ è®¢é˜…è€…åˆ°åˆ—è¡¨
- [ ] æ·»åŠ åè®¡æ•°è‡ªåŠ¨æ›´æ–°
- [ ] å¯ä»¥åˆ é™¤è®¢é˜…è€…
- [ ] åˆ é™¤åè®¡æ•°è‡ªåŠ¨æ›´æ–°
- [ ] å¯ä»¥å¯¼å…¥è®¢é˜…è€…
- [ ] å¯¼å…¥åè®¡æ•°æ­£ç¡®

### æ€§èƒ½æµ‹è¯•
```bash
export TOKEN='your-bearer-token'
./test-lists-performance.sh
```
- [ ] å“åº”æ—¶é—´ < 1 ç§’
- [ ] HTTP çŠ¶æ€ç ä¸º 200
- [ ] è¿”å›æ•°æ®æ­£ç¡®

### æ•°æ®éªŒè¯
```bash
cd backend
php artisan tinker
```

```php
// éªŒè¯è®¡æ•°æ˜¯å¦å‡†ç¡®
$list = App\Models\MailingList::first();

// ç¼“å­˜è®¡æ•°
echo "ç¼“å­˜çš„æ´»è·ƒè®¢é˜…è€…: " . $list->subscribers_count . "\n";
echo "ç¼“å­˜çš„å–æ¶ˆè®¢é˜…è€…: " . $list->unsubscribed_count . "\n";

// å®é™…ç»Ÿè®¡
$actual_active = $list->subscribers()->wherePivot('status', 'active')->count();
$actual_unsubscribed = $list->subscribers()->wherePivot('status', 'unsubscribed')->count();

echo "å®é™…çš„æ´»è·ƒè®¢é˜…è€…: " . $actual_active . "\n";
echo "å®é™…çš„å–æ¶ˆè®¢é˜…è€…: " . $actual_unsubscribed . "\n";

// åº”è¯¥ç›¸ç­‰
echo "æ´»è·ƒè®¢é˜…è€…è®¡æ•°å‡†ç¡®: " . ($list->subscribers_count == $actual_active ? 'âœ…' : 'âŒ') . "\n";
echo "å–æ¶ˆè®¢é˜…è€…è®¡æ•°å‡†ç¡®: " . ($list->unsubscribed_count == $actual_unsubscribed ? 'âœ…' : 'âŒ') . "\n";
```
- [ ] æ‰€æœ‰è®¡æ•°éƒ½å‡†ç¡®

### æ—¥å¿—æ£€æŸ¥
```bash
tail -f backend/storage/logs/laravel.log
```
- [ ] æ²¡æœ‰é”™è¯¯æ—¥å¿—
- [ ] æ²¡æœ‰è­¦å‘Šæ—¥å¿—
- [ ] è§‚å¯Ÿè€…æ­£å¸¸å·¥ä½œ

## ğŸ“Š æ€§èƒ½ç›‘æ§

### ç¬¬ä¸€å¤©
- [ ] æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡å“åº”æ—¶é—´
- [ ] ç›‘æ§æ•°æ®åº“ CPU ä½¿ç”¨ç‡
- [ ] ç›‘æ§åº”ç”¨æœåŠ¡å™¨è´Ÿè½½
- [ ] æ£€æŸ¥é”™è¯¯æ—¥å¿—

### ç¬¬ä¸€å‘¨
- [ ] æ¯å¤©æ£€æŸ¥ä¸€æ¬¡æ€§èƒ½æŒ‡æ ‡
- [ ] å¯¹æ¯”ä¼˜åŒ–å‰åçš„ç›‘æ§æ•°æ®
- [ ] æ”¶é›†ç”¨æˆ·åé¦ˆ

### ç¬¬ä¸€æœˆ
- [ ] æ¯å‘¨è¿è¡Œä¸€æ¬¡è®¡æ•°éªŒè¯
- [ ] åˆ†ææ€§èƒ½è¶‹åŠ¿
- [ ] è¯„ä¼°ä¼˜åŒ–æ•ˆæœ

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šè¿ç§»å¤±è´¥
**å¯èƒ½åŸå› **:
- æ•°æ®åº“è¿æ¥å¤±è´¥
- æƒé™ä¸è¶³
- å­—æ®µå·²å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥
php artisan db:show

# æ£€æŸ¥è¿ç§»çŠ¶æ€
php artisan migrate:status

# æ‰‹åŠ¨æ‰§è¡Œè¿ç§»
php artisan migrate --force
```

### é—®é¢˜ï¼šè®¡æ•°ä¸å‡†ç¡®
**è§£å†³æ–¹æ¡ˆ**:
```bash
# é‡æ–°è®¡ç®—æ‰€æœ‰è®¡æ•°
php artisan lists:recalculate-counts

# éªŒè¯ç‰¹å®šåˆ—è¡¨
php artisan tinker
$list = App\Models\MailingList::find(1);
echo "ç¼“å­˜: " . $list->subscribers_count . "\n";
echo "å®é™…: " . $list->subscribers()->wherePivot('status', 'active')->count() . "\n";
```

### é—®é¢˜ï¼šè§‚å¯Ÿè€…æœªè§¦å‘
**æ£€æŸ¥é¡¹**:
- [ ] `AppServiceProvider` ä¸­æ˜¯å¦æ³¨å†Œäº†è§‚å¯Ÿè€…
- [ ] `ListSubscriber` æ¨¡å‹æ˜¯å¦æ­£ç¡®é…ç½®
- [ ] `MailingList` æ˜¯å¦ä½¿ç”¨äº† `->using(ListSubscriber::class)`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ¸…é™¤é…ç½®ç¼“å­˜
php artisan config:clear

# é‡å¯åº”ç”¨
php artisan optimize:clear
```

### é—®é¢˜ï¼šé¡µé¢ä»ç„¶å¾ˆæ…¢
**æ£€æŸ¥é¡¹**:
- [ ] è¿ç§»æ˜¯å¦æˆåŠŸæ‰§è¡Œ
- [ ] è®¡æ•°æ˜¯å¦å·²é‡æ–°è®¡ç®—
- [ ] API ä»£ç æ˜¯å¦å·²æ›´æ–°
- [ ] ç¼“å­˜æ˜¯å¦å·²æ¸…é™¤

**è°ƒè¯•**:
```bash
# å¯ç”¨æŸ¥è¯¢æ—¥å¿—
DB::enableQueryLog();
// ... æ‰§è¡ŒæŸ¥è¯¢
dd(DB::getQueryLog());
```

## ğŸ”„ å›æ»šè®¡åˆ’

å¦‚æœå‡ºç°ä¸¥é‡é—®é¢˜ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

### 1. è¿›å…¥ç»´æŠ¤æ¨¡å¼
```bash
php artisan down
```
- [ ] å·²è¿›å…¥ç»´æŠ¤æ¨¡å¼

### 2. å›æ»šæ•°æ®åº“
```bash
php artisan migrate:rollback --step=1
```
- [ ] è¿ç§»å·²å›æ»š

### 3. æ¢å¤ä»£ç 
```bash
git checkout HEAD~1 -- backend/app/Http/Controllers/Api/ListController.php
git checkout HEAD~1 -- backend/app/Models/MailingList.php
git checkout HEAD~1 -- backend/app/Providers/AppServiceProvider.php
git checkout HEAD~1 -- backend/app/Jobs/ImportSubscribers.php

rm backend/app/Models/ListSubscriber.php
rm backend/app/Observers/ListSubscriberObserver.php
rm backend/app/Console/Commands/RecalculateListCounts.php
```
- [ ] ä»£ç å·²æ¢å¤

### 4. æ¸…é™¤ç¼“å­˜
```bash
php artisan config:clear
php artisan cache:clear
php artisan optimize:clear
```
- [ ] ç¼“å­˜å·²æ¸…é™¤

### 5. é€€å‡ºç»´æŠ¤æ¨¡å¼
```bash
php artisan up
```
- [ ] å·²é€€å‡ºç»´æŠ¤æ¨¡å¼

### 6. éªŒè¯
- [ ] é¡µé¢èƒ½æ­£å¸¸è®¿é—®
- [ ] åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] æ²¡æœ‰é”™è¯¯æ—¥å¿—

## ğŸ“ è”ç³»æ”¯æŒ

å¦‚æœé‡åˆ°æ— æ³•è§£å†³çš„é—®é¢˜ï¼š

1. æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š
   - [ ] é”™è¯¯æ—¥å¿— (`backend/storage/logs/laravel.log`)
   - [ ] æ•°æ®åº“æ—¥å¿—
   - [ ] è¿ç§»çŠ¶æ€ (`php artisan migrate:status`)
   - [ ] ç¯å¢ƒä¿¡æ¯ (`php artisan about`)

2. æŸ¥çœ‹æ–‡æ¡£ï¼š
   - [ ] `é‚®ä»¶åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–è¯´æ˜.md`
   - [ ] `OPTIMIZATION_SUMMARY.md`

3. å¦‚éœ€å›æ»šï¼ŒæŒ‰ç…§ä¸Šè¿°å›æ»šè®¡åˆ’æ‰§è¡Œ

## âœ¨ éƒ¨ç½²å®Œæˆ

- [ ] æ‰€æœ‰æ£€æŸ¥é¡¹å·²å®Œæˆ
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] æ•°æ®éªŒè¯é€šè¿‡
- [ ] ç›‘æ§å·²é…ç½®

**æ­å–œï¼ä¼˜åŒ–éƒ¨ç½²æˆåŠŸï¼** ğŸ‰

---

**éƒ¨ç½²æ—¥æœŸ**: _______________  
**éƒ¨ç½²äººå‘˜**: _______________  
**éªŒè¯äººå‘˜**: _______________  
**å¤‡æ³¨**: _______________

