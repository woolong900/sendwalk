# 活动复制智能命名说明

## 🎯 功能说明

复制活动时，系统会智能地处理活动标题的编号：

### 命名规则

1. **如果原标题不以 `#数字` 结尾**
   - 在标题后面加上 `#1`
   
2. **如果原标题以 `#数字` 结尾**
   - 将 `#` 后面的数字加 1

## 📋 示例对比

### 优化前 ❌

| 原标题 | 复制后标题 |
|-------|-----------|
| 测试活动 | 测试活动 (副本) |
| 测试活动 (副本) | 测试活动 (副本) (副本) |
| 测试活动 (副本) (副本) | 测试活动 (副本) (副本) (副本) |

❌ **问题**：
- 标题越来越长
- 重复的"(副本)"字样不美观
- 难以区分不同的副本

### 优化后 ✅

| 原标题 | 复制后标题 |
|-------|-----------|
| 测试活动 | 测试活动#1 |
| 测试活动#1 | 测试活动#2 |
| 测试活动#2 | 测试活动#3 |
| 测试活动#5 | 测试活动#6 |
| 春节促销活动 | 春节促销活动#1 |
| 春节促销活动#1 | 春节促销活动#2 |

✅ **优点**：
- 标题长度保持一致
- 编号清晰易懂
- 便于管理和区分

## 🧪 测试用例

### 测试用例 1: 普通标题

```
原标题: "双十一促销活动"
操作: 复制活动
预期结果: "双十一促销活动#1"
```

### 测试用例 2: 已有编号

```
原标题: "双十一促销活动#1"
操作: 复制活动
预期结果: "双十一促销活动#2"
```

### 测试用例 3: 连续复制

```
第1次:
  原标题: "测试活动"
  复制后: "测试活动#1"

第2次:
  原标题: "测试活动#1"
  复制后: "测试活动#2"

第3次:
  原标题: "测试活动#2"
  复制后: "测试活动#3"
```

### 测试用例 4: 大编号

```
原标题: "测试活动#99"
操作: 复制活动
预期结果: "测试活动#100"
```

### 测试用例 5: 标题中包含#但不在末尾

```
原标题: "C#编程入门活动"
操作: 复制活动
预期结果: "C#编程入门活动#1"
```

### 测试用例 6: 标题末尾有#但没有数字

```
原标题: "测试活动#"
操作: 复制活动
预期结果: "测试活动##1"
```

### 测试用例 7: 标题末尾有#和非数字

```
原标题: "测试活动#abc"
操作: 复制活动
预期结果: "测试活动#abc#1"
```

## 💻 技术实现

### 核心代码

```php
public function duplicate(Request $request, Campaign $campaign)
{
    // ...权限检查...

    $newCampaign = $campaign->replicate();
    
    // 智能命名：如果标题以 #数字 结尾，则数字加1；否则加上 #1
    $originalName = $campaign->name;
    if (preg_match('/#(\d+)$/', $originalName, $matches)) {
        // 标题以 #数字 结尾，提取数字并加1
        $number = (int)$matches[1];
        $newNumber = $number + 1;
        $newCampaign->name = preg_replace('/#(\d+)$/', '#' . $newNumber, $originalName);
    } else {
        // 标题不以 #数字 结尾，加上 #1
        $newCampaign->name = $originalName . '#1';
    }
    
    // ...其他复制逻辑...
}
```

### 正则表达式解释

**`/#(\d+)$/`**

- `#` - 匹配井号字符
- `(\d+)` - 捕获组，匹配一个或多个数字
- `$` - 匹配字符串末尾

**匹配示例**：
- ✅ "测试活动#1" → 匹配，捕获 "1"
- ✅ "测试活动#999" → 匹配，捕获 "999"
- ❌ "测试活动" → 不匹配
- ❌ "测试活动#abc" → 不匹配（不是数字）
- ❌ "测试活动#1abc" → 不匹配（数字后还有字符）
- ❌ "测试#1活动" → 不匹配（#数字不在末尾）

## 🔄 工作流程

```
用户点击"复制"按钮
    ↓
获取原活动标题
    ↓
检查标题是否以 #数字 结尾？
    ↓
  是                     否
    ↓                     ↓
提取数字              在标题后加 #1
    ↓                     ↓
数字 + 1              新标题 = 原标题#1
    ↓                     ↓
替换原数字            保存新活动
    ↓                     ↓
新标题 = 原标题#(数字+1)
    ↓
保存新活动
    ↓
返回新活动信息
```

## 📝 使用指南

### 1. 复制活动

```
1. 在活动列表页面找到要复制的活动
2. 点击该活动的"复制"按钮
3. 系统自动创建副本，标题按照智能规则生成
4. 新活动状态为"草稿"，可以进行编辑
```

### 2. 手动修改标题

如果自动生成的标题不符合需求，可以：

```
1. 编辑新创建的活动
2. 修改活动标题为任意内容
3. 保存修改
```

### 3. 批量复制

连续复制同一个活动时，编号会自动递增：

```
原活动: "春节活动"
    ↓ 复制
"春节活动#1"
    ↓ 复制
"春节活动#2"
    ↓ 复制
"春节活动#3"
...
```

## 🎨 用户体验

### 场景 1: 测试不同版本

```
用户需求：测试不同的邮件主题效果

操作：
1. 创建活动 "周末促销"
2. 复制 → "周末促销#1"（测试主题A）
3. 复制 → "周末促销#2"（测试主题B）
4. 复制 → "周末促销#3"（测试主题C）

优点：
✅ 编号清晰，便于区分不同版本
✅ 标题整洁，不会越来越长
✅ 便于分析和对比效果
```

### 场景 2: 定期发送活动

```
用户需求：每月发送同类活动

操作：
1. 创建活动 "月度会员通讯"
2. 下个月复制 → "月度会员通讯#1"
3. 再下个月复制 → "月度会员通讯#2"

优点：
✅ 便于追踪历史活动
✅ 编号代表期数
✅ 便于报表统计
```

### 场景 3: A/B 测试

```
用户需求：测试不同的发送时间

操作：
1. 创建活动 "新品发布"
2. 复制 → "新品发布#1"（上午10点发送）
3. 复制 → "新品发布#2"（下午3点发送）
4. 复制 → "新品发布#3"（晚上8点发送）

优点：
✅ 便于对比不同时间段的效果
✅ 清晰的编号对应不同的测试组
```

## ⚠️ 注意事项

### 1. 编号不会自动回收

删除某个编号的活动后，该编号不会被重新使用：

```
存在活动: "测试#1", "测试#2", "测试#3"
删除: "测试#2"
复制 "测试#3" → 得到 "测试#4"（不是 "测试#2"）
```

### 2. 编号没有上限

理论上编号可以无限增长：

```
测试#1 → 测试#2 → ... → 测试#999 → 测试#1000 → ...
```

### 3. 手动修改后重新开始

如果手动修改了标题，删除了编号，再次复制会重新加上 `#1`：

```
原活动: "测试#5"
复制: "测试#6"
手动改为: "新测试"
再复制: "新测试#1"
```

## 🚀 部署

### 清除缓存

```bash
cd /data/www/sendwalk/backend
php artisan config:clear
php artisan route:clear
php artisan cache:clear
```

### 测试

```bash
# 1. 创建测试活动
curl -X POST https://api.sendwalk.com/api/campaigns \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"name":"测试活动","..."}'

# 2. 复制活动
curl -X POST https://api.sendwalk.com/api/campaigns/1/duplicate \
  -H "Authorization: Bearer YOUR_TOKEN"

# 预期响应中 name 字段为: "测试活动#1"
```

## ✅ 验证步骤

1. **创建新活动**
   - 标题: "双十一促销"
   - 复制 → 应该得到 "双十一促销#1"

2. **复制已有编号的活动**
   - 标题: "双十一促销#1"
   - 复制 → 应该得到 "双十一促销#2"

3. **连续复制**
   - 从 "双十一促销#2" 复制
   - 应该得到 "双十一促销#3"

4. **大编号测试**
   - 手动创建标题为 "测试#99" 的活动
   - 复制 → 应该得到 "测试#100"

---

**优化完成！** 现在复制活动的标题更加智能和整洁。

