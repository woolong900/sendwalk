# é‚®ä»¶æ´»åŠ¨æŠ•è¯‰ç‡åŠŸèƒ½è¯´æ˜

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

åœ¨é‚®ä»¶æ´»åŠ¨åˆ—è¡¨é¡µé¢æ·»åŠ äº†"æŠ•è¯‰ç‡"åˆ—ï¼Œå¹¶æ”¯æŒç‚¹å‡»æŸ¥çœ‹è¯¦ç»†çš„æŠ•è¯‰æŠ¥å‘Šã€‚

---

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

### 1. æŠ•è¯‰ç‡æ˜¾ç¤º
- âœ… åœ¨æ´»åŠ¨åˆ—è¡¨ä¸­æ˜¾ç¤ºæŠ•è¯‰ç‡ç™¾åˆ†æ¯”
- âœ… æ˜¾ç¤ºæŠ•è¯‰æ¬¡æ•°
- âœ… ç±»ä¼¼æ‰“å¼€ç‡å’Œç‚¹å‡»ç‡çš„æ ·å¼
- âœ… å¯ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼ˆæŠ•è¯‰æ¬¡æ•°ä¸º0æ—¶ç¦ç”¨ï¼‰

### 2. æŠ•è¯‰æŠ¥å‘Šè¯¦æƒ…å¯¹è¯æ¡†
- âœ… æ˜¾ç¤ºæ‰€æœ‰æŠ•è¯‰é‚®ç®±åœ°å€
- âœ… æ˜¾ç¤ºæŠ•è¯‰åŸå› 
- âœ… æ˜¾ç¤ºæŠ•è¯‰æ—¶çš„IPåœ°å€
- âœ… æ˜¾ç¤ºæŠ•è¯‰æ—¶é—´
- âœ… æ”¯æŒæœç´¢é‚®ç®±åœ°å€
- âœ… åˆ†é¡µæ˜¾ç¤ºï¼ˆæ¯é¡µ50æ¡ï¼‰
- âœ… åŒ…å«é¦–é¡µã€ä¸Šä¸€é¡µã€ä¸‹ä¸€é¡µã€å°¾é¡µæŒ‰é’®

---

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯ä¿®æ”¹

#### 1. **Campaign æ¨¡å‹** (`backend/app/Models/Campaign.php`)
```php
// æ·»åŠ  complaint_rate åˆ° appends
protected $appends = [
    'open_rate',
    'click_rate',
    'complaint_rate',  // æ–°å¢
    'list_ids',
];

// æ·»åŠ æŠ•è¯‰æŠ¥å‘Šå…³ç³»
public function abuseReports()
{
    return $this->hasMany(AbuseReport::class);
}

// æ·»åŠ æŠ•è¯‰ç‡è®¡ç®—
public function getComplaintRateAttribute()
{
    if ($this->total_delivered == 0) return 0;
    return round(($this->total_complained / $this->total_delivered) * 100, 2);
}
```

#### 2. **Campaign Analytics æ§åˆ¶å™¨** (`backend/app/Http/Controllers/Api/CampaignAnalyticsController.php`)
```php
// æ–°å¢æ–¹æ³•ï¼šè·å–æŠ•è¯‰æŠ¥å‘Š
public function getAbuseReports(Request $request, $campaignId)
{
    $campaign = Campaign::findOrFail($campaignId);
    
    // æ£€æŸ¥æƒé™
    if ($campaign->user_id !== $request->user()->id) {
        return response()->json(['message' => 'æ— æƒè®¿é—®æ­¤æ´»åŠ¨'], 403);
    }

    $query = AbuseReport::with('subscriber')
        ->where('campaign_id', $campaignId)
        ->orderBy('created_at', 'desc');

    // æ”¯æŒæœç´¢
    if ($request->search) {
        $query->where('email', 'like', '%' . $request->search . '%');
    }

    $perPage = $request->per_page ?? 50;
    $reports = $query->paginate($perPage);

    return response()->json($reports);
}
```

#### 3. **API è·¯ç”±** (`backend/routes/api.php`)
```php
Route::get('campaigns/{campaign}/abuse-reports', [CampaignAnalyticsController::class, 'getAbuseReports']);
```

---

### å‰ç«¯ä¿®æ”¹

#### 1. **Campaign æ¥å£å®šä¹‰** (`frontend/src/pages/campaigns/index.tsx`)
```typescript
interface Campaign {
  // ... å…¶ä»–å­—æ®µ
  total_complained: number    // æ–°å¢ï¼šæŠ•è¯‰æ€»æ•°
  complaint_rate: number      // æ–°å¢ï¼šæŠ•è¯‰ç‡
}
```

#### 2. **çŠ¶æ€ç®¡ç†**
```typescript
const [abuseReportsDialog, setAbuseReportsDialog] = useState<{
  open: boolean
  campaignId: number | null
  campaignName: string
}>({
  open: false,
  campaignId: null,
  campaignName: '',
})
```

#### 3. **è¡¨æ ¼åˆ—**
- åœ¨ `colgroup` ä¸­æ·»åŠ äº† `<col className="w-[100px]" />` ç”¨äºæŠ•è¯‰ç‡åˆ—
- è¡¨æ ¼æœ€å°å®½åº¦ä» `1190px` è°ƒæ•´ä¸º `1290px`
- æ·»åŠ è¡¨å¤´ï¼š`<TableHead className="text-center">æŠ•è¯‰ç‡</TableHead>`

#### 4. **æŠ•è¯‰ç‡å•å…ƒæ ¼**
```tsx
<TableCell className="text-center whitespace-nowrap">
  <button
    onClick={() => setAbuseReportsDialog({ 
      open: true, 
      campaignId: campaign.id, 
      campaignName: campaign.name 
    })}
    className="flex flex-col items-center gap-1 w-full hover:opacity-70 transition-opacity cursor-pointer"
    disabled={campaign.total_complained === 0}
  >
    <span className="font-medium">
      {campaign.complaint_rate?.toFixed(1) || 0}%
    </span>
    <span className="text-xs text-muted-foreground">
      {campaign.total_complained || 0} æ¬¡
    </span>
  </button>
</TableCell>
```

#### 5. **æŠ•è¯‰æŠ¥å‘Šå¯¹è¯æ¡†** (`frontend/src/pages/campaigns/analytics-dialogs.tsx`)
- åˆ›å»ºäº† `AbuseReportsDialog` ç»„ä»¶
- ä¸ `SendLogsDialog` å’Œ `EmailOpensDialog` ä¿æŒä¸€è‡´çš„UI/UX
- æ”¯æŒæœç´¢å’Œåˆ†é¡µ
- ä½¿ç”¨ `AlertOctagon` å›¾æ ‡å’Œçº¢è‰²ä¸»é¢˜

---

## ğŸ“Š åˆ—é¡ºåº

å½“å‰é‚®ä»¶æ´»åŠ¨åˆ—è¡¨çš„åˆ—é¡ºåºï¼š

1. ID
2. æ ‡é¢˜
3. çŠ¶æ€
4. åˆ—è¡¨
5. å‘é€è¿›åº¦
6. æ‰“å¼€ç‡ï¼ˆå¯ç‚¹å‡»ï¼‰
7. ç‚¹å‡»ç‡
8. **æŠ•è¯‰ç‡**ï¼ˆå¯ç‚¹å‡»ï¼‰â† æ–°å¢
9. æ—¶é—´
10. æ“ä½œ

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. æ‹‰å–æœ€æ–°ä»£ç 
```bash
cd /data/www/sendwalk
git pull
```

### 2. åç«¯æ— éœ€é¢å¤–æ“ä½œ
- æŠ•è¯‰æ•°æ®å·²å­˜å‚¨åœ¨ `abuse_reports` è¡¨ä¸­
- `campaigns` è¡¨å·²æœ‰ `total_complained` å­—æ®µ
- æ–°çš„ `complaint_rate` å±æ€§ä¼šè‡ªåŠ¨è®¡ç®—

### 3. é‡æ–°æ„å»ºå‰ç«¯
```bash
cd frontend
npm run build
```

### 4. é‡å¯æœåŠ¡ï¼ˆå¯é€‰ï¼‰
å¦‚æœä½¿ç”¨ PM2 æˆ–å…¶ä»–è¿›ç¨‹ç®¡ç†å™¨ï¼Œå¯èƒ½éœ€è¦é‡å¯ï¼š
```bash
# å¦‚æœä½¿ç”¨ PM2
pm2 restart sendwalk-api

# å¦‚æœä½¿ç”¨ Supervisor
supervisorctl restart sendwalk-api
```

---

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### æŸ¥çœ‹æŠ•è¯‰ç‡
1. è¿›å…¥é‚®ä»¶æ´»åŠ¨åˆ—è¡¨é¡µé¢
2. åœ¨"æŠ•è¯‰ç‡"åˆ—ä¸­å¯ä»¥çœ‹åˆ°æ¯ä¸ªæ´»åŠ¨çš„æŠ•è¯‰ç‡å’ŒæŠ•è¯‰æ¬¡æ•°

### æŸ¥çœ‹æŠ•è¯‰è¯¦æƒ…
1. ç‚¹å‡»"æŠ•è¯‰ç‡"å•å…ƒæ ¼ï¼ˆæŠ•è¯‰æ¬¡æ•°ä¸ä¸º0æ—¶å¯ç‚¹å‡»ï¼‰
2. åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼š
   - æŠ•è¯‰çš„é‚®ç®±åœ°å€
   - æŠ•è¯‰åŸå› 
   - æŠ•è¯‰æ—¶çš„IPåœ°å€
   - æŠ•è¯‰æ—¶é—´
3. å¯ä»¥ä½¿ç”¨æœç´¢åŠŸèƒ½æŸ¥æ‰¾ç‰¹å®šé‚®ç®±
4. ä½¿ç”¨åˆ†é¡µæŒ‰é’®æµè§ˆæ‰€æœ‰æŠ•è¯‰è®°å½•

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æŠ•è¯‰ç‡è®¡ç®—**ï¼š
   - å…¬å¼ï¼š`(total_complained / total_delivered) * 100`
   - å½“ `total_delivered` ä¸º 0 æ—¶ï¼ŒæŠ•è¯‰ç‡æ˜¾ç¤ºä¸º 0%

2. **ç‚¹å‡»é™åˆ¶**ï¼š
   - åªæœ‰å½“æŠ•è¯‰æ¬¡æ•°å¤§äº 0 æ—¶ï¼ŒæŠ•è¯‰ç‡å•å…ƒæ ¼æ‰å¯ç‚¹å‡»
   - æŠ•è¯‰æ¬¡æ•°ä¸º 0 æ—¶ï¼ŒæŒ‰é’®ä¸ºç¦ç”¨çŠ¶æ€

3. **æƒé™æ£€æŸ¥**ï¼š
   - åç«¯ API ä¼šæ£€æŸ¥ç”¨æˆ·æƒé™
   - åªèƒ½æŸ¥çœ‹è‡ªå·±æ´»åŠ¨çš„æŠ•è¯‰æŠ¥å‘Š

4. **æ•°æ®æ¥æº**ï¼š
   - æŠ•è¯‰æ•°æ®æ¥è‡ª `abuse_reports` è¡¨
   - æ¯æ¡è®°å½•åŒ…å«æŠ•è¯‰è€…çš„é‚®ç®±ã€åŸå› ã€IPåœ°å€å’Œæ—¶é—´

---

## ğŸ” æ•°æ®åº“è¡¨ç»“æ„

### `abuse_reports` è¡¨
```sql
CREATE TABLE `abuse_reports` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `campaign_id` bigint unsigned NOT NULL,
  `subscriber_id` bigint unsigned DEFAULT NULL,
  `email` varchar(255) NOT NULL,
  `reason` text,
  `ip_address` varchar(45) DEFAULT NULL,
  `user_agent` text,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `abuse_reports_campaign_id_foreign` (`campaign_id`),
  KEY `abuse_reports_subscriber_id_foreign` (`subscriber_id`)
);
```

### `campaigns` è¡¨ç›¸å…³å­—æ®µ
```sql
`total_complained` int DEFAULT 0,  -- æŠ•è¯‰æ€»æ•°
-- complaint_rate æ˜¯åŠ¨æ€è®¡ç®—çš„ï¼Œä¸å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
```

---

## âœ¨ æ”¹è¿›å»ºè®®ï¼ˆæœªæ¥ï¼‰

1. **æŠ•è¯‰ç»Ÿè®¡**ï¼š
   - æ·»åŠ æŠ•è¯‰è¶‹åŠ¿å›¾è¡¨
   - æ˜¾ç¤ºæŠ•è¯‰åŸå› çš„åˆ†å¸ƒç»Ÿè®¡

2. **é‚®ç®±ç®¡ç†**ï¼š
   - ä¸€é”®å°†æŠ•è¯‰é‚®ç®±åŠ å…¥é»‘åå•
   - æ‰¹é‡å¤„ç†æŠ•è¯‰è®°å½•

3. **é€šçŸ¥åŠŸèƒ½**ï¼š
   - å½“æŠ•è¯‰ç‡è¶…è¿‡é˜ˆå€¼æ—¶å‘é€è­¦å‘Š
   - å®æ—¶æŠ•è¯‰é€šçŸ¥

4. **æŠ•è¯‰åˆ†æ**ï¼š
   - æŠ•è¯‰åŸå› åˆ†æ
   - æŠ•è¯‰æ—¶é—´æ®µåˆ†æ
   - æŠ•è¯‰ä¸å…¶ä»–æŒ‡æ ‡çš„å…³è”åˆ†æ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
2. åç«¯æ—¥å¿—ï¼š`backend/storage/logs/laravel.log`
3. API è¯·æ±‚æ˜¯å¦æˆåŠŸè¿”å›æ•°æ®

---

**æ›´æ–°æ—¥æœŸ**: 2025-12-26
**ç‰ˆæœ¬**: v1.0

