# 黑名单批量上传 - 测试指南

## 🧪 测试步骤

### 1. 准备测试数据

#### 小批量测试（100条）

```bash
# 生成 100 条测试数据
for i in {1..100}; do
  echo "test${i}@example.com"
done > blacklist_test_100.txt
```

#### 中批量测试（1万条）

```bash
# 生成 1 万条测试数据
for i in {1..10000}; do
  echo "test${i}@example.com"
done > blacklist_test_10k.txt
```

#### 大批量测试（10万条）

```bash
# 生成 10 万条测试数据
for i in {1..100000}; do
  echo "test${i}@example.com"
done > blacklist_test_100k.txt
```

#### 超大批量测试（200万条）

```bash
# 生成 200 万条测试数据
for i in {1..2000000}; do
  echo "test${i}@example.com"
done > blacklist_test_2m.txt

# 或者使用更快的方法
seq 1 2000000 | awk '{print "test"$1"@example.com"}' > blacklist_test_2m.txt
```

### 2. 部署更新

```bash
# 1. 拉取最新代码
cd /data/www/sendwalk
git pull

# 2. 后端无需迁移（没有数据库变更）

# 3. 确保队列服务运行
php artisan queue:work --daemon

# 4. 重新构建前端
cd frontend
npm run build

# 5. 重启服务（如果需要）
sudo systemctl reload nginx
```

### 3. 功能测试

#### 测试 1: 小批量上传（100条）

**目的**：验证基本功能

1. 打开黑名单页面
2. 点击"批量上传"
3. 选择 `blacklist_test_100.txt`
4. 点击"开始导入"

**预期结果**：
- ✅ 文件上传成功
- ✅ 进度条显示 0% → 100%
- ✅ 显示"新增 100 个"
- ✅ 3秒后自动关闭对话框
- ✅ 列表中显示新增的邮箱

**预计时间**：< 5 秒

#### 测试 2: 中批量上传（1万条）

**目的**：验证批量处理

1. 上传 `blacklist_test_10k.txt`
2. 观察进度更新

**预期结果**：
- ✅ 进度实时更新
- ✅ 显示"新增 10000 个"
- ✅ 无错误提示

**预计时间**：5-10 秒

#### 测试 3: 重复上传

**目的**：验证去重功能

1. 再次上传 `blacklist_test_100.txt`（相同文件）

**预期结果**：
- ✅ 显示"新增 0 个，已存在 100 个"
- ✅ 不会重复添加

#### 测试 4: 无效邮箱

**目的**：验证数据验证

创建包含无效邮箱的文件：

```bash
cat > blacklist_test_invalid.txt << EOF
valid@example.com
invalid-email
not-an-email
another@valid.com
@invalid.com
EOF
```

上传文件。

**预期结果**：
- ✅ 显示"新增 2 个，无效 3 个"
- ✅ 只添加有效邮箱

#### 测试 5: CSV 格式

**目的**：验证 CSV 支持

创建 CSV 文件：

```bash
cat > blacklist_test.csv << EOF
email
csv1@example.com
csv2@example.com
csv3@example.com
EOF
```

上传文件。

**预期结果**：
- ✅ 自动跳过表头
- ✅ 显示"新增 3 个"

#### 测试 6: 大批量上传（10万条）

**目的**：验证性能

1. 上传 `blacklist_test_100k.txt`
2. 观察进度和内存使用

**预期结果**：
- ✅ 进度平滑更新
- ✅ 浏览器不卡顿
- ✅ 内存占用正常（< 100MB）
- ✅ 显示"新增 100000 个"

**预计时间**：30秒 - 2分钟

#### 测试 7: 超大批量上传（200万条）⭐️

**目的**：验证原问题已解决

1. 上传 `blacklist_test_2m.txt`（约 60-100 MB）
2. 观察整个过程

**预期结果**：
- ✅ 文件上传成功（不报错 `net::ERR_FAILED`）
- ✅ 进度实时更新
- ✅ 浏览器不崩溃
- ✅ 可以离开页面，导入继续进行
- ✅ 最终显示"新增 2000000 个"

**预计时间**：3-5 分钟

**监控命令**：

```bash
# 监控队列处理
watch -n 1 'php artisan queue:work --once'

# 监控缓存
redis-cli
> KEYS blacklist_import:*
> GET blacklist_import:{import_id}

# 监控数据库
mysql -u root -p
> SELECT COUNT(*) FROM blacklists;

# 监控服务器资源
htop
```

### 4. 错误场景测试

#### 测试 8: 网络中断

1. 开始上传大文件
2. 在上传过程中断开网络
3. 重新连接网络

**预期结果**：
- ✅ 显示错误提示
- ✅ 可以重新上传

#### 测试 9: 队列未运行

1. 停止队列服务：`supervisorctl stop laravel-worker:*`
2. 上传文件

**预期结果**：
- ✅ 文件上传成功
- ✅ 状态显示"queued"
- ✅ 启动队列后自动处理

#### 测试 10: 文件格式错误

1. 上传非文本文件（如图片）

**预期结果**：
- ✅ 显示"请选择txt、csv或xlsx文件"
- ✅ 不允许上传

### 5. 性能基准测试

使用不同数据量测试，记录时间：

| 数据量 | 文件大小 | 上传时间 | 处理时间 | 总时间 | 内存占用 |
|--------|---------|---------|---------|--------|---------|
| 100 | ~3 KB | < 1s | < 1s | < 2s | < 10 MB |
| 1,000 | ~30 KB | < 1s | ~2s | ~3s | < 10 MB |
| 10,000 | ~300 KB | ~1s | ~5s | ~6s | < 20 MB |
| 100,000 | ~3 MB | ~2s | ~30s | ~32s | < 50 MB |
| 1,000,000 | ~30 MB | ~5s | ~2min | ~2min 5s | < 100 MB |
| 2,000,000 | ~60 MB | ~10s | ~4min | ~4min 10s | < 150 MB |

### 6. 用户体验测试

#### 测试 11: 进度显示

1. 上传 10 万条数据
2. 观察进度更新频率

**预期**：
- ✅ 进度条平滑更新
- ✅ 数字实时变化
- ✅ 无明显卡顿

#### 测试 12: 多次上传

1. 连续上传 3 个文件
2. 观察是否有冲突

**预期**：
- ✅ 每次上传独立处理
- ✅ 进度互不干扰
- ✅ 结果正确显示

#### 测试 13: 页面刷新

1. 开始上传大文件
2. 刷新页面
3. 再次打开批量上传

**预期**：
- ✅ 之前的导入继续在后台进行
- ✅ 可以开始新的导入
- ✅ 数据最终正确

### 7. 浏览器兼容性测试

在不同浏览器测试：

- [ ] Chrome/Edge（Chromium）
- [ ] Firefox
- [ ] Safari
- [ ] 移动端浏览器

### 8. 验证数据正确性

```bash
# 连接到数据库
mysql -u root -p sendwalk

# 检查总数
SELECT COUNT(*) FROM blacklists WHERE user_id = 1;

# 检查样例数据
SELECT * FROM blacklists WHERE user_id = 1 ORDER BY id DESC LIMIT 10;

# 检查是否有重复
SELECT email, COUNT(*) as count 
FROM blacklists 
WHERE user_id = 1 
GROUP BY email 
HAVING count > 1;

# 检查订阅者状态更新
SELECT COUNT(*) FROM subscribers WHERE status = 'blacklisted';
```

## ✅ 测试检查清单

### 基本功能
- [ ] 文件选择正常
- [ ] 文件上传成功
- [ ] 进度显示正确
- [ ] 结果统计准确
- [ ] 自动关闭对话框

### 数据处理
- [ ] 邮箱验证正确
- [ ] 去重功能正常
- [ ] 批量处理高效
- [ ] 数据库更新正确
- [ ] 订阅者状态同步

### 性能表现
- [ ] 小批量（< 1万）：< 10秒
- [ ] 中批量（1-10万）：< 1分钟
- [ ] 大批量（10-100万）：< 3分钟
- [ ] 超大批量（100-200万）：< 5分钟
- [ ] 浏览器内存 < 150 MB

### 用户体验
- [ ] 进度实时更新
- [ ] 无明显卡顿
- [ ] 错误提示清晰
- [ ] 可以离开页面
- [ ] 结果展示友好

### 错误处理
- [ ] 网络错误处理
- [ ] 文件格式验证
- [ ] 队列失败恢复
- [ ] 超时处理
- [ ] 日志记录完整

## 🐛 问题排查

### 问题 1: 上传失败

**检查**：
```bash
# 检查 Nginx 配置
sudo nginx -t
cat /etc/nginx/conf.d/sendwalk-api.conf | grep client_max_body_size

# 检查 PHP 配置
php -i | grep upload_max_filesize
php -i | grep post_max_size

# 检查日志
tail -f /var/log/nginx/sendwalk-api-error.log
tail -f storage/logs/laravel.log
```

### 问题 2: 进度不更新

**检查**：
```bash
# 检查队列是否运行
ps aux | grep queue:work

# 检查缓存
redis-cli
> KEYS blacklist_import:*

# 检查日志
tail -f storage/logs/laravel.log | grep "黑名单导入"
```

### 问题 3: 数据不正确

**检查**：
```bash
# 查看导入日志
tail -f storage/logs/laravel.log | grep "import_id"

# 检查数据库
mysql -u root -p sendwalk
> SELECT * FROM blacklists WHERE created_at > NOW() - INTERVAL 1 HOUR;
```

## 📊 测试报告模板

```markdown
## 黑名单批量上传测试报告

**测试日期**：2025-12-25
**测试人员**：[姓名]
**环境**：生产环境

### 测试结果

| 测试项 | 数据量 | 结果 | 耗时 | 备注 |
|--------|--------|------|------|------|
| 小批量 | 100 | ✅ | 2s | 正常 |
| 中批量 | 10,000 | ✅ | 8s | 正常 |
| 大批量 | 100,000 | ✅ | 45s | 正常 |
| 超大批量 | 2,000,000 | ✅ | 4min 20s | 正常 |
| 重复上传 | 100 | ✅ | 2s | 去重正常 |
| 无效邮箱 | 5 | ✅ | 1s | 验证正常 |
| CSV格式 | 3 | ✅ | 1s | 解析正常 |

### 性能指标

- **浏览器内存峰值**：120 MB
- **服务器 CPU 峰值**：45%
- **服务器内存峰值**：300 MB
- **网络带宽峰值**：10 MB/s

### 问题记录

1. [无] 或 [问题描述]

### 总结

✅ 所有测试通过，功能正常，性能良好。
```

## 🎯 关键测试点

**最重要的测试**：

1. ✅ **200万数据上传** - 验证原问题已解决
2. ✅ **进度实时显示** - 验证用户体验
3. ✅ **浏览器不崩溃** - 验证内存优化
4. ✅ **数据正确性** - 验证业务逻辑
5. ✅ **队列处理** - 验证异步机制

如果这5项都通过，说明重构成功！🎉

